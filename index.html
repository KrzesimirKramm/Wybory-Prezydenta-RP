<!doctype html>
<html lang="pl">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet1.css"><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css"><link rel="stylesheet" href="css/L.Control.Locate.min.css">
		<link rel="preconnect" href="https://fonts.gstatic.com">
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet"> 
		<link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/qgis2web.css">
		<link rel="stylesheet" href="css/leaflet-search.css">
		<link rel="icon" href="images/triangles_tri.png">
		<!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" integrity="sha256-aa0xaJgmK/X74WM224KMQeNQC2xYKwlAt08oZqjeF0E=" crossorigin="anonymous" /-->
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
			z-index: 100;
		}
        #loader {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 2000;
        }
        #loader img {
            width: 200px;
            height: 200px;
			border-radius: 100px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin: -100px 0 0 -100px;
        }
        </style>
		<style id="workAround"></style>
		<style type='text/css'>
			#btn-spin {
			  position: absolute;
			  left: 200px;
			  z-index: 10;
			  font-size: 1.5em;
			}
			.help {
				font-size: 1.5em;
				position: absolute;
				top:0;
				left: 0;
				right: 0;
				height: 30px;
				z-index: 10;
				background-color: rgba(0,0,0,0.5);
				color: white;
				padding: 10px;
				margin: 0px;
				text-align: center;
			}
			.help a.sources {
				float: left;
				margin-left: 50px;
				color: white;
			}
			.help a.logo {
				float: right;
			}
			.help a.logo img {
				height: 30px;
			}	
		</style>
        <title>Wybory Prezydenta RP</title>
	</head>
    <body>
        <div id="map">
			<div id='loader'>
				<p style="color: black; padding: 20px; font-size: 32px; display: block; position: absolute; top: 20%; width: 100%; text-align: center;">Ładowanie danych mapy...</p>
				<img src='images/200.gif' alt='loader' />
			</div>
			<div class="modal"><!-- Place at bottom of page --></div>
        </div>
		<!--div id="info-pane" class="leaflet-bar chart-container">
		  <canvas id="chartCanvas"></canvas>
		</div-->
		<script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script><script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/tinyqueue.min.js"></script>
		<!--script src="js/require.js"></script-->
		<!--script src="https://unpkg.com/tinyqueue"></script-->
        <script src="js/polylabel.js"></script>
        
		<!--script src="https://unpkg.com/tinyqueue@2.0.0/tinyqueue.min.js"></script-->
		<script src="js/leaflet-search.src.js"></script>
		<script src="js/Chart.min_.js"></script>
		<script src="js/chartjs-plugin-annotation.min.js"></script>
		<script type='text/javascript' src="js/leaflet.spin.min.js"></script>
		<script src="js/spin.js"></script>
		<!--script src="https://teastman.github.io/Leaflet.pattern/leaflet.pattern.js"></script-->

		
        <script src="data/Gminy_6.js"></script>
        <script src="data/Powiaty_Simplified_6.js"></script>
        <script src="data/Granicewojewdztw_5.js"></script>
        <script src="data/PL1897.js"></script>
        <script src="data/PL1931.js"></script>
        <script src="data/ZAB1910.js"></script>
        <script src="data/ZAB1910a.js"></script>
        <script>
		//$map = $("#map");
		//console.log($map);
		/*$(document).on({
			ajaxStart: function() { $map.addClass("loading");    },
			 ajaxStop: function() { $map.removeClass("loading"); }    
		});*/
		
		//$('#loader').append('<p style="color: black; padding: 20px; font-size: 32px; display: block; position: absolute; top: 25%; width: 100%; text-align: center;">Ładowanie danych mapy</p>');
		
		var JEkod = {};
		var JEnazwa = {};
		var JEudzial = {};
		var JEkolor ={};
		var WEkod = {};
		var WEnazwa = {};
		var WEudzial = {};
		var WEkolor ={};
		var WEpow = {};
		var PLkod = {};
		var PLnazwa = {};
		var PLudzial = {};
		var PLkolor ={};
		var PLpow ={};
		var PLwoj ={};
		
		var layers = {};
		var layers10 = {};
		var layers15 = {};
		var layers20 = {};
		var pow_ats = {};
		var pow_ats2 = {};
		var wojewods = {};
		var wojewods2 = {};
		var scatterPlotDataArray = [];
		var scatterPlotDataArray10 = [];
		var scatterPlotDataArray15 = [];
		var scatterPlotDataArray20 = [];
		
		var scatterPlotDataArrayTemp = [];
		var scatterPlotDataArray_xy = [];
		var scatterPlotDataArray_xz = [];
		var scatterPlotDataArray_yx = [];
		var scatterPlotDataArray_yz = [];
		var scatterPlotDataArray_zx = [];
		var scatterPlotDataArray_zy = [];
		var scatterPlotDataArray10_xy = [];
		var scatterPlotDataArray10_xz = [];
		var scatterPlotDataArray10_yx = [];
		var scatterPlotDataArray10_yz = [];
		var scatterPlotDataArray10_zx = [];
		var scatterPlotDataArray10_zy = [];
		var scatterPlotDataArray15_xy = [];
		var scatterPlotDataArray15_xz = [];
		var scatterPlotDataArray15_yx = [];
		var scatterPlotDataArray15_yz = [];
		var scatterPlotDataArray15_zx = [];
		var scatterPlotDataArray15_zy = [];
		var scatterPlotDataArray20_xy = [];
		var scatterPlotDataArray20_xz = [];
		var scatterPlotDataArray20_yx = [];
		var scatterPlotDataArray20_yz = [];
		var scatterPlotDataArray20_zx = [];
		var scatterPlotDataArray20_zy = [];
		var pointBackgroundColors = [];
		var pointFBackgroundColors = [];
		var pointBBackgroundColors = [];
		var pointRadiuses = [];
		var pointBorderColors = [];
		var pointBBorderColors = [];
		var pointBorderWidths = [];
		var current_KOD = '1465011';
		var gminList = [];
		var powList = [];
		var kodList = [];
		var selected = false; //czy wybrano województwo/powiat
		var woj_zoom =true;
		var xa = 'Komorowski';
		var ya = 'Kaczyński';
		var za = 'Absencja i nieważne';
		var xb = xa;
		var yb = ya;
		var zb = za;
		//scroll position
		var sc, sc_temp;
		//index of current woj in select
		var cind =1;
		var vind =1;
		//var subb =0;
		var polind = 1;
		
		var year = 0;
		var link_clicked = false;
		
		var options_saved;
		var data_saved;
		var layer_code = 1465011;
		var l1, l2, l3, l4, l5, l6, l7, l8, l9;
		var already_filtered = true;
		var block_cl_pop = false;
		var pop_op=false;
		
		var layer_change_first_clicked = false;
		var select_change_first_clicked = false;
		var subselect_change_first_clicked = false;
		var popup_open_first_clicked = false;
		var popup_close_first_clicked = false;
		var manual_popup = true;
		var manual_zoom = true;
		var manually_zoomed = true;
		var temp_zoomed = true;
		var item_clicked = false;
		var adm_clicked = false;
		var sel_clicked = false;
		var subsel_clicked = false;
		var polygon_clicked = false;
		var manual_select = true;
		var block_centering = false;
		var select_twice = false;
		var auto_zoom = false;
		var already_selected = true;
		
		var czoom = 6;
		var szoom = 6;
		var tooltipThreshold = 8;
		var zooms = [1,1.5,1.9,2.3,2.8];
		var blend_modes = ['normal','normal','darken','multiply','multiply'];
		
		var jedn = '%';
		var sred = 'Średnia: ';
		//var item_set = 0;
		
		var h3o = '<h5 style="margin-bottom: 8px;">'+'';
		var tabso = '</h5>'+
			'<div class="tabs">'+
				'<ul class="tab-links">'+
					'<li class="active">'+'<a href="#tab1">Podsumowanie</a>'+'</li>'+
					'<li>'+'<a href="#tab2">2010</a>'+'</li>'+
					'<li>'+'<a href="#tab3">2015</a>'+'</li>'+
					'<li>'+'<a href="#tab4">2020</a>'+'</li>'+
				'</ul>'+
			'<div style="width: 656px; height: 16px; margin-left: -60px; margin-top: -16px; background-image: linear-gradient(to bottom, #fff, #fff 8px, #f4f4f4 16px); border-radius: 16px 16px 0 0; z-index: 960; box-shadow: 5px 5px 3px rgba(80, 128, 80, 0.25), -5px 5px 3px rgba(80, 128, 80, 0.25); overflow: hidden;"></div>'+
			'<div class="tab-content">'+
			'<div id="tab1" class="tab active">'+
				'<div>';
					
		var pretabl1 = '<h5 style="text-align: center; color: #484848; padding: 0px 8px;">Wyniki II tury Wyborów Prezydenta RP na terenie ';
		var pretabl2 = ' w&nbsp;latach 2010, 2015 i 2020 jako&nbsp;odsetek osób uprawnionych do&nbsp;głosowania:</h5>';
		var pretabl3 = '<h5 style="text-align: center; color: #484848; padding: 0px 8px;">Dodatkowe informacje:</h5>';
		var tableo = '<table class = "tabela" id="Podsumowanie">\
				<thead>\
					<tr style="background: none;">\
						<th style="border-right: 2px solid #eee; border-top-left-radius: 32px;"></th>\
						<th><b>2010</b></th>\
						<th><b>2015</b></th>\
						<th style="border-right: 2px solid #eee;"><b>2020</b></th>\
						<th><b>2010->2015</b></th>\
						<th><b>2015->2020</b></th>\
						<th>2010->2020</b></th>\
					</tr>\
				</thead>\
				<tbody>';
		var end_tabl = '</tbody>\
						</table>';
					
		var end_tab =	'</div></div>';
		var tabc =		'<div id="tab2" class="tab">\
					<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
				</div>\
				\
				<div id="tab3" class="tab">\
					<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
				</div>\
				\
				<div id="tab4" class="tab">\
					<p>Błąd wczytywania danych. Proszę spróbować ponownie za kilka chwil.</p>\
				</div>\
			</div>';
		var divclear = '<div style="clear:both;"></div></div>';
		
		function numberWithSpaces(x) {
			return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "&nbsp;");
		}
		function lengthToBlank(number) {
			var ntext = "";
			var length = number.toString().length;
			for (i=0; i<7-length; i++){
				ntext = ntext + "&#8199;";
			}
			if (length<4) ntext = ntext + "&nbsp;";
			if (length<7) ntext = ntext + "&nbsp;";
			return ntext;
		}
		function lengthToBlank1(number) {
			var percent  = parseFloat(number).toFixed(2);
			if (number/10>=1){
				return percent;
			}else{
				return "&#8199;"+percent;
			}
		}
		
		function lengthToBlank2(number) {
			var ntext = [];
			var percent ;
			if(number>0){
				percent = "+"+number.toFixed(2);
			}else{
				percent = number.toFixed(2);
			}
				
			var length = percent.length;
			for (i=0; i<7-length; i++){
				ntext .push("&#8199;");
			}
			/*if (length<4) ntext = ntext + "&#8199;";*/
			ntext .push(percent);
			return ntext.join("");
		}
		
		function lengthToBlank3(number) {
			var ntext = [];
			var percent ;
			if(number>0){
				percent = "+"+number.toFixed(2);
			}else{
				percent = number.toFixed(2);
			}
				
			var length = percent.length;
			for (i=0; i<6-length; i++){
				ntext .push("&#8199;");
			}
			/*if (length<4) ntext = ntext + "&#8199;";*/
			ntext .push(percent);
			return ntext.join("");
		}
		
		function colorizeTextR(value){
			if (value==0){
				return ' style = "font-weight: 700; color: #101010">';
			}else if  (value>0){
				return ' style = "font-weight: 700; color: green">';
			}else{
				return ' style = "font-weight: 700; color: red">';
			}
		}
		function colorizeTextRt(value){
			if (value==0){
				return ' style = "font-weight: 700;">';
			}else if  (value>0){
				return ' style = "font-weight: 700; color: #109010">';
			}else{
				return ' style = "font-weight: 700; color: #ff1010">';
			}
		}
		
		/*<td><div style = "background-color: ' + ((feature.properties['abs10'] !== 100)? feature.properties['rgb10']:'rgba(0,0,0,0.0)')  + '; display: inline-block; padding: 12px; margin: 2px; opacity: 0.8;"></div></td>\
							<td><div style = "background-color: ' + ((feature.properties['abs15'] !== 100)? feature.properties['rgb15']:'rgba(0,0,0,0.0)')   + '; display: inline-block; padding: 12px; margin: 2px; opacity: 0.8;"></div></td>\
							<td style="border-right: 2px dotted #bbb;"><div style = "background-color: ' + ((feature.properties['abs20'] !== 100)? feature.properties['rgb20']:'rgba(0,0,0,0.0)')   + '; display: inline-block; padding: 12px; margin: 2px; opacity: 0.8;"></div></td>*/
		var std = '<td>';
		var xtd = '</td>';
		var bgcolor1 = '<div style = "display: inline-block; background-color: white; width: 28px; height: 28px;"><div style = "background-color: ';
		var bgcolor12 = '<div style = "display: inline-block; background-color: white; width: 24px; height: 24px;"><div style = "background-color: ';
		var bgcolor2 = '<td style="border-right: 2px dotted #bbb;"><div style = "background-color: white; display: inline-block; width: 28px; height: 28px;"><div style = "background-color: ';
		var inlbl = '; display: inline-block; padding: 12px; margin: 2px; opacity: 0.8;"></div></div>';
		var inlbl2 = '; display: inline-block; padding: 10px; margin: 2px; opacity: 0.8;"></div></div>';
		function renderColor(ccolor, divided=false){
			if (divided){
				return bgcolor2 + ccolor + inlbl + xtd ;
			}else{
				return std + bgcolor12 + ccolor + inlbl + xtd;
			}
		}
		function renderColor2(ccolor1, ccolor2){
			return std +bgcolor12 + ccolor1 + inlbl2 + bgcolor12 + ccolor2 + inlbl2 + xtd;
		}
		
		
		function renderRow(rtext,r1,r2,r3,divided){
			var multistringText =  [];
			if (divided){
				multistringText.push('<tr class="divider">');
			}else{
				multistringText.push('<tr>');
			}
			multistringText.push('<td><b>'+rtext+'</b></td>');
			r1=='&mdash;'?multistringText.push('<td>&mdash;</td>'):multistringText.push('<td  style="color: #66f; font-weight: 700;">'+lengthToBlank1(r1)+'%</td>');
			multistringText.push('<td  style="color: #66f; font-weight: 700;">'+lengthToBlank1(r2)+'%</td>');
			multistringText.push('<td style="border-right: 2px dotted #bbb; color: #66f; font-weight: 700;">'+lengthToBlank1(r3)+'%</td>');
			r1=='&mdash;'?multistringText.push('<td>&mdash;</td>'):multistringText.push('<td'+colorizeTextR(r2-r1)+lengthToBlank3(r2-r1)+' p.p.</td>');
			multistringText.push('<td'+colorizeTextR(r3-r2)+lengthToBlank3(r3-r2)+' p.p.</td>');
			r1=='&mdash;'?multistringText.push('<td>&mdash;</td>'):multistringText.push('<td'+colorizeTextR(r3-r1)+lengthToBlank3(r3-r1)+' p.p.</td>');
			multistringText.push('</tr>');
			return multistringText.join('');
		}
		function renderRowt(rtext,r1,r2,r3,divided){
			var multistringText =  [];
			if (divided){
				multistringText.push('<tr class="divider">');
			}else{
				multistringText.push('<tr>');
			}
			//console.log(lengthToBlank(r1));
			multistringText.push('<td><b>'+rtext+'</b></td>');
			multistringText.push('<td  style="color: #55e; font-weight: 700;">'+lengthToBlank(r1)+numberWithSpaces(r1)+'</td>');
			multistringText.push('<td  style="color: #55e; font-weight: 700;">'+lengthToBlank(r2)+numberWithSpaces(r2)+'</td>');
			multistringText.push('<td style="border-right: 2px dotted #bbb; color: #55e; font-weight: 700;">'+lengthToBlank(r3)+numberWithSpaces(r3)+'</td>');
			r1=='&mdash;'||r1==0?multistringText.push('<td>&mdash;</td>'):multistringText.push('<td'+colorizeTextRt(r2-r1)+lengthToBlank2((r2-r1)/r1*100)+'%</td>');
			r2==0?multistringText.push('<td>&mdash;</td>'):multistringText.push('<td'+colorizeTextRt(r3-r2)+lengthToBlank2((r3-r2)/r2*100)+'%</td>');
			r1=='&mdash;'||r1==0?multistringText.push('<td>&mdash;</td>'):multistringText.push('<td'+colorizeTextRt(r3-r1)+lengthToBlank2((r3-r1)/r1*100)+'%</td>');
			multistringText.push('</tr>');
			return multistringText.join('');
		}
		json_Gminy_0.getFeaturesByProperty = function(key, value) {
		  return this.features.filter(function(feature){
			if (feature.properties[key] === value) {
			  return true;
			} else {
			  return false;
			}
		  });
		};
		json_Powiaty_Simplified_1.getFeaturesByProperty = function(key, value) {
		  return this.features.filter(function(feature){
			if (feature.properties[key] === value) {
			  return true;
			} else {
			  return false;
			}
		  });
		};
		json_Granicewojewdztw_2.getFeaturesByProperty = function(key, value) {
		  return this.features.filter(function(feature){
			if (feature.properties[key] === value) {
			  return true;
			} else {
			  return false;
			}
		  });
		};
		
		const sortArrayofObjects = (property, order) => {
		  var sortOrder = order === 'asc' ? 1 : -1;
		  //var topIds = [100.0, 0.0];
		  return function (a, b) {
			 var result = (a['properties'][property] < b['properties'][property]) ? -1 : (a['properties'][property] > b['properties'][property]) ? 1 : 0;
			  return result * sortOrder;
			 /* return topIds.includes(b['properties'][property]) - topIds.includes(a['properties'][property]) || b['properties'][property] - a['properties'][property];*/
		  }
		};
		
		function arrayXMin(arr) {
		  var len = arr.length, min = Infinity;
		  while (len--) {
			if (arr[len].x < min) {
			  min = arr[len].x;
			}
		  }
		  return min;
		};
		
		function arrayYMin(arr) {
		  var len = arr.length, min = Infinity;
		  while (len--) {
			if (arr[len].y < min) {
			  min = arr[len].y;
			}
		  }
		  return min;
		};
		
		function arrayXMax(arr) {
		  var len = arr.length, max = -Infinity;
		  while (len--) {
			if (arr[len].x > max) {
			  max = arr[len].x;
			}
		  }
		  return max;
		};
		
		function arrayYMax(arr) {
		  var len = arr.length, max = -Infinity;
		  while (len--) {
			if (arr[len].y > max) {
			  max = arr[len].y;
			}
		  }
		  return max;
		};
				
		function rank_Powiaty(feature, layer) {
			/*var pow_at = json_Gminy_0.getFeaturesByProperty('Powiat', feature.properties['Powiat']);
			pow_at1  = pow_at1.sort(sortArrayofObjects('pis10', 'desc'));*/
			var JE = feature.properties.JPT_KOD_JE;
			var JN = feature.properties.JPT_NAZWA_;
			//console.log(JE);
			var  pow_at = [];
			
			for (i=0; i<9; i++){
				pow_at[i]  = json_Gminy_0.getFeaturesByProperty('Powiat', JE);
			}
			
			pow_at[0]  = pow_at[0].sort(sortArrayofObjects('pis10', 'desc'));
			pow_at[1]  = pow_at[1].sort(sortArrayofObjects('po10', 'desc'));
			pow_at[2]  = pow_at[2].sort(sortArrayofObjects('abs10', 'desc'));
			pow_at[3]  = pow_at[3].sort(sortArrayofObjects('pis15', 'desc'));
			pow_at[4]  = pow_at[4].sort(sortArrayofObjects('po15', 'desc'));
			pow_at[5]  = pow_at[5].sort(sortArrayofObjects('abs15', 'desc'));
			pow_at[6]  = pow_at[6].sort(sortArrayofObjects('pis20', 'desc'));
			pow_at[7]  = pow_at[7].sort(sortArrayofObjects('po20', 'desc'));
			pow_at[8]  = pow_at[8].sort(sortArrayofObjects('abs20', 'desc'));
			//var JE = [];
			var kod = [];
			var nazwa = [];
			var udzial = [];
			var kolor = [];
			for (i=0; i<9; i++){
				kod[i]  = new Array(pow_at[i].length);
				nazwa[i]  = new Array(pow_at[i].length);
				udzial[i]  = new Array(pow_at[i].length);
				kolor[i]  = new Array(pow_at[i].length);
			}
			//console.log(pow_at[8][0].properties.JPT_NAZWA_);
			//console.log(pow_at[8][1].properties.JPT_NAZWA_);
			for (i=0; i<9; i++){
				for (t=0; t<pow_at[i].length;t++){
					kod[i][t] = pow_at[i][t].properties.JPT_KOD_JE;
					nazwa[i][t] = pow_at[i][t].properties.JPT_NAZWA_;
					switch(i){
						case 0:
							udzial[i][t] = pow_at[i][t].properties.pis10;
							kolor[i][t] = pow_at[i][t].properties.rgb10;
							break;
						case 1:
							udzial[i][t] = pow_at[i][t].properties.po10;
							kolor[i][t] = pow_at[i][t].properties.rgb10;
							break;
						case 2:
							udzial[i][t] = pow_at[i][t].properties.abs10;
							kolor[i][t] = pow_at[i][t].properties.rgb10;
							break;
						case 3:
							udzial[i][t] = pow_at[i][t].properties.pis15;
							kolor[i][t] = pow_at[i][t].properties.rgb15;
							break;
						case 4:
							udzial[i][t] = pow_at[i][t].properties.po15;
							kolor[i][t] = pow_at[i][t].properties.rgb15;
							break;
						case 5:
							udzial[i][t] = pow_at[i][t].properties.abs15;
							kolor[i][t] = pow_at[i][t].properties.rgb15;
							break;
						case 6:
							udzial[i][t] = pow_at[i][t].properties.pis20;
							kolor[i][t] = pow_at[i][t].properties.rgb20;
							break;
						case 7:
							udzial[i][t] = pow_at[i][t].properties.po20;
							kolor[i][t] = pow_at[i][t].properties.rgb20;
							break;
						case 8:
							udzial[i][t] = pow_at[i][t].properties.abs20;
							kolor[i][t] = pow_at[i][t].properties.rgb20;
							break;
						default:
							udzial[i][t] = 0;
							kolor[i][t] = '#ffffff';
					}
					/*udzial[i][t] = pow_at[i][t].properties.pis10;*/
				}
			}
			JEkod[JE] = kod;
			JEnazwa[JE] = nazwa;
			JEudzial[JE] = udzial;
			JEkolor[JE] = kolor;
			/*JEkod.push(layer);*/
			/*console.log(JN);
			console.log(JEkod[JE]);*/
		}
		
		function rank_Wojewod(feature, layer) {
			/*var woj_at = json_Gminy_0.getFeaturesByProperty('Powiat', feature.properties['Powiat']);
			woj_at1  = woj_at1.sort(sortArrayofObjects('pis10', 'desc'));*/
			var WE = feature.properties.Wojewod;
			var WN = feature.properties.JPT_NAZWA_;
			//console.log(WE);
			var  woj_at = [];
			
			for (i=0; i<9; i++){
				woj_at[i]  = json_Gminy_0.getFeaturesByProperty('Wojewod', WE);
			}
			
			woj_at[0]  = woj_at[0].sort(sortArrayofObjects('pis10', 'desc'));
			woj_at[1]  = woj_at[1].sort(sortArrayofObjects('po10', 'desc'));
			woj_at[2]  = woj_at[2].sort(sortArrayofObjects('abs10', 'desc'));
			woj_at[3]  = woj_at[3].sort(sortArrayofObjects('pis15', 'desc'));
			woj_at[4]  = woj_at[4].sort(sortArrayofObjects('po15', 'desc'));
			woj_at[5]  = woj_at[5].sort(sortArrayofObjects('abs15', 'desc'));
			woj_at[6]  = woj_at[6].sort(sortArrayofObjects('pis20', 'desc'));
			woj_at[7]  = woj_at[7].sort(sortArrayofObjects('po20', 'desc'));
			woj_at[8]  = woj_at[8].sort(sortArrayofObjects('abs20', 'desc'));
			//var WE = [];
			var kod = [];
			var nazwa = [];
			var udzial = [];
			var kolor = [];
			var powiat = [];
			for (i=0; i<9; i++){
				kod[i]  = new Array(woj_at[i].length);
				nazwa[i]  = new Array(woj_at[i].length);
				udzial[i]  = new Array(woj_at[i].length);
				kolor[i]  = new Array(woj_at[i].length);
				powiat[i]  = new Array(woj_at[i].length);
			}
			//console.log(woj_at[8][0].properties.JPT_NAZWA_);
			//console.log(woj_at[8][1].properties.JPT_NAZWA_);
			for (i=0; i<9; i++){
				for (t=0; t<woj_at[i].length;t++){
					kod[i][t] = woj_at[i][t].properties.JPT_KOD_JE;
					nazwa[i][t] = woj_at[i][t].properties.JPT_NAZWA_;
					powiat[i][t] = woj_at[i][t].properties.Powiat;
					
					switch(i){
						case 0:
							udzial[i][t] = woj_at[i][t].properties.pis10;
							kolor[i][t] = woj_at[i][t].properties.rgb10;
							break;
						case 1:
							udzial[i][t] = woj_at[i][t].properties.po10;
							kolor[i][t] = woj_at[i][t].properties.rgb10;
							break;
						case 2:
							udzial[i][t] = woj_at[i][t].properties.abs10;
							kolor[i][t] = woj_at[i][t].properties.rgb10;
							break;
						case 3:
							udzial[i][t] = woj_at[i][t].properties.pis15;
							kolor[i][t] = woj_at[i][t].properties.rgb15;
							break;
						case 4:
							udzial[i][t] = woj_at[i][t].properties.po15;
							kolor[i][t] = woj_at[i][t].properties.rgb15;
							break;
						case 5:
							udzial[i][t] = woj_at[i][t].properties.abs15;
							kolor[i][t] = woj_at[i][t].properties.rgb15;
							break;
						case 6:
							udzial[i][t] = woj_at[i][t].properties.pis20;
							kolor[i][t] = woj_at[i][t].properties.rgb20;
							break;
						case 7:
							udzial[i][t] = woj_at[i][t].properties.po20;
							kolor[i][t] = woj_at[i][t].properties.rgb20;
							break;
						case 8:
							udzial[i][t] = woj_at[i][t].properties.abs20;
							kolor[i][t] = woj_at[i][t].properties.rgb20;
							break;
						default:
							udzial[i][t] = 0;
							kolor[i][t] = '#ffffff';
					}
					/*udzial[i][t] = woj_at[i][t].properties.pis10;*/
				}
			}
			WEkod[WE] = kod;
			WEnazwa[WE] = nazwa;
			WEudzial[WE] = udzial;
			WEkolor[WE] = kolor;
			WEpow[WE] = powiat;
			/*WEkod.push(layer);*/
			/*console.log(WN);*/
			/*console.log(WEkod[WE]);*/
		}
		
		function rank_PL() {
			/*var pl_at = json_Gminy_0.getFeaturesByProperty('Powiat', feature.properties['Powiat']);
			pl_at1  = pl_at1.sort(sortArrayofObjects('pis10', 'desc'));*/
			/*var PL = feature.properties.Wojewod;
			var WN = feature.properties.JPT_NAZWA_;*/
			//console.log(PL);
			var  pl_at = [];
			
			for (i=0; i<9; i++){
				pl_at[i] = new Array(json_Gminy_0.features.length);
				for (t=0; t< json_Gminy_0.features.length; t++){
					pl_at[i][t]  = json_Gminy_0.features[t];
				}
			}
			
			//console.log(pl_at_[8][0].properties.JPT_NAZWA_+' aaa');
			//console.log(pl_at[8][0].properties.JPT_NAZWA_+' bbb');
			pl_at[0]  = pl_at[0].sort(sortArrayofObjects('pis10', 'desc'));
			pl_at[1]  = pl_at[1].sort(sortArrayofObjects('po10', 'desc'));
			pl_at[2]  = pl_at[2].sort(sortArrayofObjects('abs10', 'desc'));
			pl_at[3]  = pl_at[3].sort(sortArrayofObjects('pis15', 'desc'));
			pl_at[4]  = pl_at[4].sort(sortArrayofObjects('po15', 'desc'));
			pl_at[5]  = pl_at[5].sort(sortArrayofObjects('abs15', 'desc'));
			pl_at[6]  = pl_at[6].sort(sortArrayofObjects('pis20', 'desc'));
			pl_at[7]  = pl_at[7].sort(sortArrayofObjects('po20', 'desc'));
			pl_at[8]  = pl_at[8].sort(sortArrayofObjects('abs20', 'desc'));
			//var PL = [];
			//console.log(pl_at[8][0].properties.JPT_NAZWA_+' ccc');
			var kod = [];
			var nazwa = [];
			var udzial = [];
			var kolor = [];
			var powiat = [];
			var wojewod = [];
			
			for (i=0; i<9; i++){
				kod[i]  = new Array(pl_at[i].length);
				nazwa[i]  = new Array(pl_at[i].length);
				udzial[i]  = new Array(pl_at[i].length);
				kolor[i]  = new Array(pl_at[i].length);
				powiat[i]  = new Array(pl_at[i].length);
				wojewod[i]  = new Array(pl_at[i].length);
			}
			//console.log(pl_at[8][0].properties.JPT_NAZWA_);
			//console.log(pl_at[8][1].properties.JPT_NAZWA_);
			for (i=0; i<9; i++){
				for (t=0; t<pl_at[i].length;t++){
					kod[i][t] = pl_at[i][t].properties.JPT_KOD_JE;
					nazwa[i][t] = pl_at[i][t].properties.JPT_NAZWA_;
					powiat[i][t] = pl_at[i][t].properties.Powiat;
					wojewod[i][t] = pl_at[i][t].properties.Wojewod;
					switch(i){
						case 0:
							udzial[i][t] = pl_at[i][t].properties.pis10;
							kolor[i][t] = pl_at[i][t].properties.rgb10;
							break;
						case 1:
							udzial[i][t] = pl_at[i][t].properties.po10;
							kolor[i][t] = pl_at[i][t].properties.rgb10;
							break;
						case 2:
							udzial[i][t] = pl_at[i][t].properties.abs10;
							kolor[i][t] = pl_at[i][t].properties.rgb10;
							break;
						case 3:
							udzial[i][t] = pl_at[i][t].properties.pis15;
							kolor[i][t] = pl_at[i][t].properties.rgb15;
							break;
						case 4:
							udzial[i][t] = pl_at[i][t].properties.po15;
							kolor[i][t] = pl_at[i][t].properties.rgb15;
							break;
						case 5:
							udzial[i][t] = pl_at[i][t].properties.abs15;
							kolor[i][t] = pl_at[i][t].properties.rgb15;
							break;
						case 6:
							udzial[i][t] = pl_at[i][t].properties.pis20;
							kolor[i][t] = pl_at[i][t].properties.rgb20;
							break;
						case 7:
							udzial[i][t] = pl_at[i][t].properties.po20;
							kolor[i][t] = pl_at[i][t].properties.rgb20;
							break;
						case 8:
							udzial[i][t] = pl_at[i][t].properties.abs20;
							kolor[i][t] = pl_at[i][t].properties.rgb20;
							break;
						default:
							udzial[i][t] = 0;
							kolor[i][t] = '#ffffff';
					}
					/*udzial[i][t] = pl_at[i][t].properties.pis10;*/
				}
			}
			PLkod = kod;
			PLnazwa = nazwa;
			PLudzial= udzial;
			PLkolor = kolor;
			PLpow = powiat;
			PLwoj = wojewod;
			/*PLkod.push(layer);*/
			/*console.log(WN);*/
			/*console.log(PLnazwa[1]+'aaa');*/
		}
		rank_PL();
		
		function colorconvert(color, transparency) {
				var r = parseInt(color.substring(1,3),16);
				var g = parseInt(color.substring(3,5),16);
				var b = parseInt(color.substring(5,7),16);
				var a = parseFloat(transparency);
				return ('rgba(' + r + ', ' + g + ', ' + b + ', ' + a + ')');
		}
		
		function rotateData(dfeature, x, y){
				var x1=x;
				var y1=y;
				var z1=100-(x1+y1);
				
				scatterPlotDataArray_xy.push({
					x: x1,
					y: y1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_xz.push({
					x: x1,
					y: z1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yx.push({
					x: y1,
					y: x1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yz.push({
					x: y1,
					y: z1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zx.push({
					x: z1,
					y: x1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zy.push({
					x: z1,
					y: y1,
					featureId: dfeature.JPT_KOD_JE
				});
		}
		function rotateDataPP(dfeature, x, y){
				var x1=x;
				var y1=y;
				var z1=0-(x1+y1);
				
				scatterPlotDataArray_xy.push({
					x: x1,
					y: y1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_xz.push({
					x: x1,
					y: z1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yx.push({
					x: y1,
					y: x1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_yz.push({
					x: y1,
					y: z1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zx.push({
					x: z1,
					y: x1,
					featureId: dfeature.JPT_KOD_JE
				});
				scatterPlotDataArray_zy.push({
					x: z1,
					y: y1,
					featureId: dfeature.JPT_KOD_JE
				});
		}
		
		
		
        var map = L.map('map', {
            zoomControl:true, maxZoom:10, minZoom:6
        }).fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
		//map.spin(true);
        var hash = new L.Hash(map);
		var a_zoom = map.getZoom();
		map.attributionControl.addAttribution('<a href="https://prezydent20200628.pkw.gov.pl/prezydent20200628/pl/wyniki/pl" target="_blank">Wybory Prezydenta Rzeczypospolitej Polskiej</a>');
		map.attributionControl.addAttribution('<a href="https://github.com/jschoeley/tricolore" target="_blank">tricolore</a>');
        map.attributionControl.addAttribution('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a>');
        map.attributionControl.addAttribution('Icons made by <a href="https://www.flaticon.com/authors/juicy-fish" title="juicy_fish">juicy_fish</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>');
		map.attributionControl.addAttribution('<a href="https://censusmosaic.demog.berkeley.edu/data/historical-gis-files">mosaic</a>');
        var bounds_group = new L.featureGroup([]);
        /*var basemap0 = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            maxZoom: 10,
			opacity: 0.5
        });*/
		var basemap0 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
			subdomains: 'abcd',
			maxZoom: 10,
			opacity: 1
		});
		szoom = map.getZoom();
		var stripes = new L.StripePattern({height:9, weight: 1, spaceWeight: 2, color: '#c22', opacity: 0.4, spaceColor: '#caa', spaceOpacity: 0.2, angle: 45});
        stripes.addTo(map);
		var patt_blank = new L.StripePattern({opacity: 0.0, spaceOpacity: 0.0});
		patt_blank.addTo(map);
		/*map.spin(true);
		setTimeout(function () {
			basemap0.addTo(map);    
			map.spin(false);
		}, 3000);*/
        basemap0.addTo(map); 
		L.control.locate().addTo(map);
        function setBounds() {
        }
        function pop_Gminy_0(feature, layer) {
			var p = layer.feature.properties;
			var PJE = p.Powiat;
			var PWE = p.Wojewod;
            var popupContent ="" ;
			popupContent += h3o;
			popupContent  += p.JPT_KOD_JE.substring(6, 7) !== "1"? 'gm.' : 'm.';
			popupContent += ' ';
			popupContent  += (p.JPT_NAZWA_ !== null ? Autolinker.link(String(p.JPT_NAZWA_)) : '');
			popupContent += tabso;
			popupContent += pretabl1;
			popupContent  += (p.JPT_KOD_JE.substring(6, 7) !== "1"? 'gminy' : 'miasta');
			popupContent += pretabl2;
			popupContent  += tableo;
			popupContent  += renderRow('Kandydat popierany przez PiS:',p.pis10,p.pis15,p.pis20,false);
			popupContent  += renderRow('Kandydat popierany przez PO:',p.po10,p.po15,p.po20,false);
			popupContent  += renderRow('Absencja i głosy nieważne:',p.abs10,p.abs15,p.abs20,false);
			
			popupContent  += '<tr><td><b>Kolor: </b></td>';
			popupContent  += renderColor(p.rgb10);
			popupContent  += renderColor(p.rgb15);
			popupContent  += renderColor(p.rgb20, true);
			popupContent  += renderColor2(p.rgb1510, p.rgb1510c);
			popupContent  += renderColor2(p.rgb2015, p.rgb2015c);
			popupContent  += renderColor2(p.rgb2010, p.rgb2010c);
			popupContent  += '</tr>';
			popupContent += end_tabl;
			
			
			popupContent += pretabl3;
			popupContent += tableo;
			popupContent  += renderRowt('Liczba uprawnionych do&nbsp;głosowania:',p.LW10,p.LW15,p.LW20,false);
			popupContent  += renderRowt('Głosy oddane:',(p.KPIS10+p.KPO10)+p.GN10,(p.KPIS15+p.KPO15)+p.GN15,(p.KPIS20+p.KPO20)+p.GN20,false);
			popupContent  += renderRowt('Głosy ważne:',(p.KPIS10+p.KPO10),(p.KPIS15+p.KPO15),(p.KPIS20+p.KPO20),false);
			popupContent  += renderRowt('Głosy nieważne:',p.GN10,p.GN15,p.GN20,false);
			popupContent  += renderRowt('Liczba wyborców głosujących na&nbsp;podstawie zaświadczenia o&nbsp;prawie do&nbsp;głosowania:','&mdash;',p.ZAS15,p.ZAS20,false);
			popupContent  += renderRowt('Kandydat popierany przez&nbsp;PiS:',p.KPIS10,p.KPIS15,p.KPIS20,false);
			popupContent  += renderRowt('Kandydat popierany przez&nbsp;PO:',p.KPO10,p.KPO15,p.KPO20,true);
			popupContent  += renderRow('Frekwencja:',((p.KPIS10+p.KPO10)+p.GN10)/p.LW10*100,((p.KPIS15+p.KPO15)+p.GN15)/p.LW15*100,((p.KPIS20+p.KPO20)+p.GN20)/p.LW20*100,false);
			popupContent  += renderRow('Odsetek głosów ważnych:',(p.KPIS10+p.KPO10)/((p.KPIS10+p.KPO10)+p.GN10)*100,(p.KPIS15+p.KPO15)/((p.KPIS15+p.KPO15)+p.GN15)*100,(p.KPIS20+p.KPO20)/((p.KPIS20+p.KPO20)+p.GN20)*100,false);
			popupContent  += renderRow('Odsetek głosów nieważnych:',p.GN10/((p.KPIS10+p.KPO10)+p.GN10)*100,p.GN15/((p.KPIS15+p.KPO15)+p.GN15)*100,p.GN20/((p.KPIS20+p.KPO20)+p.GN20)*100,false);
			popupContent  += renderRow('Odsetek wyborców głosujących na&nbsp;podstawie zaświadczenia o&nbsp;prawie do&nbsp;głosowania:','&mdash;',p.ZAS15/((p.KPIS15+p.KPO15)+p.GN15)*100,p.ZAS20/((p.KPIS20+p.KPO20)+p.GN20)*100,false);
			popupContent  += renderRow('Kandydat popierany przez&nbsp;PiS&nbsp;(%):',(p.KPIS10/(p.KPIS10+p.KPO10))*100,(p.KPIS15/(p.KPIS15+p.KPO15))*100,(p.KPIS20/(p.KPIS20+p.KPO20))*100,false);
			popupContent  += renderRow('Kandydat popierany przez&nbsp;PO&nbsp;(%):',p.KPO10/(p.KPIS10+p.KPO10)*100,p.KPO15/(p.KPIS15+p.KPO15)*100,p.KPO20/(p.KPIS20+p.KPO20)*100,false);
			//popupContent  += '</tr>';
			popupContent += end_tabl;
			popupContent += '<p style="margin: 16px;">Źródło: Opracowanie własne na podstawie danych PKW.</p>';
			popupContent += end_tab;
			
			popupContent += tabc;
			popupContent += divclear;
			
			/*console.log(Number(feature.properties['Absencja']).toFixed(2));*/
            layer.bindPopup(popupContent, {maxHeight: 800, autoPanPaddingTopLeft: [80,20],autoPanPaddingBottomRight: [320,20]});
			rotateData(p, p.po10, p.pis10);
			p.wojewod = p.JPT_KOD_JE.substring(0,2);
			//console.log(p.wojewod);
			kodList.push(p.JPT_KOD_JE);
			p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
			layers[feature.properties.JPT_KOD_JE] = layer;
			//pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
			pointFBackgroundColors.push(p.rgb10);
			pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
			pointBBackgroundColors.push(colorconvert(p.rgb10,0.32));
			pointBBorderColors.push('rgba(255, 255, 255, 0.2)');
			//pointBBorderColors.push('rgba(224, 224, 224, 0.08)');
			/*if (current_KOD==feature.properties.JPT_KOD_JE){
				pointRadiuses.push(6.4);
				pointBorderColors.push('rgba(255, 0, 0, 0.4)');
				pointBorderWidths.push(2);
			}else{*/
				pointRadiuses.push(3.6);
				pointBorderColors.push('rgba(64, 64, 64, 0.64)');
				pointBorderWidths.push(1);
				
			//}
			gminList.push(p.JPT_NAZWA_);
        }
		function pop_Gm_0(feature, layer) {
			layer.bindPopup(layers[feature.properties.JPT_KOD_JE]._popup._content, {maxHeight: 640});
		}
		function pop_Curr_0(feature, layer) {
			layers[feature.properties.JPT_KOD_JE] = layer;
		}
		
        function style_Gminy_0_0(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 0,
				className: 'stroke-polyline',
                fillColor: /*hexToRgbA(*/feature.properties["rgb10"],
            }
        }
		function style_p10(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb10"],
            }
        }
		
		function style_p15(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb15"],
            }
        }
		
		function style_p20(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb20"],
            }
        }
		function style_p1510(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb1510"],
            }
        }function style_p2015(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb2015"],
            }
        }function style_p2010(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                //color: feature.properties["rgb2010"],
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb2010"],
            }
        }
		function style_p1510c(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb1510c"],
            }
        }function style_p2015c(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb2015c"],
            }
        }function style_p2010c(feature) {
            return {
                pane: 'pane_Gminy_0',
                opacity: 1.0,
                color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 0.32, 
                fill: true,
                fillOpacity: 1.0,
				className: 'stroke-polyline',
                fillColor: feature.properties["rgb2010c"],
            }
        }
        map.createPane('pane_Gminy_0');
        map.getPane('pane_Gminy_0').style.zIndex = 400;
        map.getPane('pane_Gminy_0').style['mix-blend-mode'] = 'normal';
        /*var layer_Gminy_0 = new L.geoJson(json_Gminy_0, {
            attribution: '<a href=""></a>',
            pane: 'pane_Gminy_0',
            onEachFeature: pop_Gminy_0,
            style: style_Gminy_0_0,
        });*/
		var layer_10 = new L.geoJson(json_Gminy_0, {
			name: 'D2010',
			pane: 'pane_Okregi_0',
            onEachFeature: pop_Gminy_0,
            style: style_p10,
        })/*.addTo(map)*/;
		
		var layer_15 = new L.geoJson( json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p15,
        })/*.addTo(map);*/
		
		var layer_20 = new L.geoJson( json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p20,
        })/*.addTo(map);*/
		
		//var layer_2020 = Object.assign({}, layer_2010);
		/*var layer_2020 = jQuery.extend(true, {}, layer_2010)
		layer_2020.setStyle(style_D2020);
		layer_2010.setStyle(style_D2010);*/
		
		var layer_1510 = new L.geoJson( json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p1510,
        })/*.addTo(map);*/
		
		var layer_2015 = new L.geoJson(json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p2015,
        })/*.addTo(map);*/
		
		var layer_2010 = new L.geoJson( json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p2010,
        })/*.addTo(map);*/
		
		var layer_1510c = new L.geoJson( json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p1510c,
        })/*.addTo(map);*/
		
		var layer_2015c = new L.geoJson( json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p2015c,
        })/*.addTo(map);*/
		
		var layer_2010c = new L.geoJson(json_Gminy_0, {
            pane: 'pane_Okregi_0',
            onEachFeature: pop_Gm_0,
            style: style_p2010c,
        })/*.addTo(map);*/
		
		l1 = layer_10._leaflet_id;
		l2 = layer_15._leaflet_id;
		l3 = layer_20._leaflet_id;
		l4 = layer_1510._leaflet_id;
		l5 = layer_2015._leaflet_id;
		l6 = layer_2010._leaflet_id;
		l7 = layer_1510c._leaflet_id;
		l8 = layer_2015c._leaflet_id;
		l9 = layer_2010c._leaflet_id;
		
		
        //bounds_group.addLayer(layer_Gminy_0
        //map.addLayer(layer_Gminy_0);
		//console.log("Layer ID: "+layer_10._leaflet_id);
		var layer_current=layer_10;
		layer_code = layer_current._leaflet_id;
		layers10 = layers;
		//scatterPlotDataArray10 = scatterPlotDataArray;
		scatterPlotDataArray10_xy = scatterPlotDataArray_xy;
		scatterPlotDataArray10_xz = scatterPlotDataArray_xz;
		scatterPlotDataArray10_yx = scatterPlotDataArray_yx;
		scatterPlotDataArray10_yz = scatterPlotDataArray_yz;
		scatterPlotDataArray10_zx = scatterPlotDataArray_zx;
		scatterPlotDataArray10_zy = scatterPlotDataArray_zy;
		
		scatterPlotDataArray_xy = [];
		scatterPlotDataArray_xz = [];
		scatterPlotDataArray_yx = [];
		scatterPlotDataArray_yz = [];
		scatterPlotDataArray_zx = [];
		scatterPlotDataArray_zy = [];
		
		layer_15.eachLayer(function (evt, idx) {
			var p = evt.feature.properties;
			layers15[p.JPT_KOD_JE] = evt;
			rotateData(p, p.po15, p.pis15);
			//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
			//rotateData(p, p.po15, p.pis15);
			//pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
		});
		scatterPlotDataArray15_xy = scatterPlotDataArray_xy;
		scatterPlotDataArray15_xz = scatterPlotDataArray_xz;
		scatterPlotDataArray15_yx = scatterPlotDataArray_yx;
		scatterPlotDataArray15_yz = scatterPlotDataArray_yz;
		scatterPlotDataArray15_zx = scatterPlotDataArray_zx;
		scatterPlotDataArray15_zy = scatterPlotDataArray_zy;
		
		scatterPlotDataArray_xy = [];
		scatterPlotDataArray_xz = [];
		scatterPlotDataArray_yx = [];
		scatterPlotDataArray_yz = [];
		scatterPlotDataArray_zx = [];
		scatterPlotDataArray_zy = [];
		
		layer_20.eachLayer(function (evt, idx) {
			var p = evt.feature.properties;
			layers20[p.JPT_KOD_JE] = evt;
			rotateData(p, p.po20, p.pis20);
			//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
			//rotateData(p, p.po20, p.pis20);
			//pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
		});
		scatterPlotDataArray20_xy = scatterPlotDataArray_xy;
		scatterPlotDataArray20_xz = scatterPlotDataArray_xz;
		scatterPlotDataArray20_yx = scatterPlotDataArray_yx;
		scatterPlotDataArray20_yz = scatterPlotDataArray_yz;
		scatterPlotDataArray20_zx = scatterPlotDataArray_zx;
		scatterPlotDataArray20_zy = scatterPlotDataArray_zy;
		
		scatterPlotDataArray_xy = scatterPlotDataArray10_xy;
		scatterPlotDataArray_xz = scatterPlotDataArray10_xz;
		scatterPlotDataArray_yx = scatterPlotDataArray10_yx;
		scatterPlotDataArray_yz = scatterPlotDataArray10_yz;
		scatterPlotDataArray_zx = scatterPlotDataArray10_zx;
		scatterPlotDataArray_zy = scatterPlotDataArray10_zy;
		
		//$('#loader').remove();
		console.log("Layer ID: "+layer_current._leaflet_id);
		/*map.spin(true);*/
        setTimeout(function () {
				$('#loader').remove();
				//map.addLayer(layer_current);    
				//map.spin(false);
           }, 1000);
		map.addLayer(layer_current);
		
        function list_Powiaty_Simplified_2(feature, layer) {
            powList.push(feature.properties.JPT_KOD_JE+' '+feature.properties.JPT_NAZWA_);
			pow_ats[feature.properties.JPT_KOD_JE] = layer;
        }
		
		var powFront = 'rgba(96, 96, 96, 1.0)';
		var powBack = 'rgba(240,240,240,0.4)';
		var wojFront = 'rgba(80,80,80,1.0)';
		var wojBack = 'rgba(255,255,255,0.6)';

        function style_Powiaty_Simplified_1_0() {
            return {
                pane: 'pane_Powiaty_Simplified_1',
                opacity: 1.0,
                color: powFront,
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.2, 
                fill: true,
                fillOpacity: 0,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
		function style_Powiaty_Simplified_3_0() {
            return {
                pane: 'pane_Powiaty_Simplified_1',
                opacity: 0,
                color: 'rgba(224, 224, 224, 0.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 0, 
                fill: true,
                fillOpacity: 0,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Powiaty_Simplified_1');
        map.getPane('pane_Powiaty_Simplified_1').style.zIndex = 403;
        //map.getPane('pane_Powiaty_Simplified_1').style['mix-blend-mode'] = 'normal';
		L.Polygon.include({
			_update: function () {
				if (!this._map) { return; }

				this._clipPoints();
				this._simplifyPoints();
				this._updatePath();
				this.fire('reclipped', {parts: this._parts})
			}
		});
		var lab_centers = [];
        var layer_Powiaty_Simplified_1 = new L.geoJson(json_Powiaty_Simplified_1, {
            pane: 'pane_Powiaty_Simplified_1',
            onEachFeature: function(feat, poly){
				//rank_Powiaty;
				var center;
				poly.on('reclipped', function(ev) {
					//console.log(ev);
					var parts = ev.parts.map(function(ring){
						return ring.map(function(point){
							if ('x' in point) {
								return [point.x, point.y]
							}
						});
					});

					if (!parts.length) {
						// Polygon not visible
						if (center) center.remove();
						return;
					}

					var centerpoint = polylabel(parts, 4);
					var centerLatLng = map.layerPointToLatLng(centerpoint);
					//console.log(feat.properties.JPT_NAZWA_, parts, centerpoint, centerLatLng);

					/*if (center) {center.setLatLng(centerLatLng).addTo(map)} 
					else { center = L.circleMarker(centerLatLng, {color: 'red', radius:10}).addTo(map)}*/
					lab_centers.push(centerLatLng);
				})
			},
			
            style: style_Powiaty_Simplified_1_0,
        });
		var layer_Powiaty_Simplified_3 = new L.geoJson(json_Powiaty_Simplified_1, {
            pane: 'pane_Powiaty_Simplified_1',
            onEachFeature: rank_Powiaty,
			
            style: style_Powiaty_Simplified_3_0,
        });
		layer_Powiaty_Simplified_1.eachLayer(function(layer) {
			pow_ats2[layer.feature.properties.JPT_KOD_JE] = layer;
        });
		console.log(pow_ats2);
        //bounds_group.addLayer(layer_Powiaty_Simplified_1);
       // map.addLayer(layer_Powiaty_Simplified_1);
		
		function style_Powiaty_Simplified_2_0() {
            return {
                pane: 'pane_Powiaty_Simplified_2',
                opacity: 1.0,
                color: powBack,
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.8, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Powiaty_Simplified_2');
        map.getPane('pane_Powiaty_Simplified_2').style.zIndex = 401;
        map.getPane('pane_Powiaty_Simplified_2').style['mix-blend-mode'] = 'normal';
        var layer_Powiaty_Simplified_2 = new L.geoJson(json_Powiaty_Simplified_1, {
            attribution: '<a href=""></a>',
            pane: 'pane_Powiaty_Simplified_2',
			onEachFeature: list_Powiaty_Simplified_2,
            style: style_Powiaty_Simplified_2_0,
        });
        //bounds_group.addLayer(layer_Powiaty_Simplified_2);
        //map.addLayer(layer_Powiaty_Simplified_2);
		
		powList.sort();
		
		
        function pop_Granicewojewdztw_1(feature, layer) {
            wojewods[feature.properties.Wojewod] = layer;
        }
		function pop_Granicewojewdztw_2(layer) {
            wojewods2[layer.feature.properties.Wojewod] = layer;
        }

        function style_Granicewojewdztw_2_0() {
            return {
                pane: 'pane_Granicewojewdztw_2',
                opacity: 1.0,
                color: wojFront,
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 2.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Granicewojewdztw_2');
        map.getPane('pane_Granicewojewdztw_2').style.zIndex = 404;
        //map.getPane('pane_Granicewojewdztw_2').style['mix-blend-mode'] = 'normal';
        var layer_Granicewojewdztw_2 = new L.geoJson(json_Granicewojewdztw_2 , {
            attribution: '<a href=""></a>',
            pane: 'pane_Granicewojewdztw_2',
            onEachFeature: rank_Wojewod,
            style: style_Granicewojewdztw_2_0,
        });
		layer_Granicewojewdztw_2.eachLayer(function(layer) {
			pop_Granicewojewdztw_2(layer);
        });
        //bounds_group.addLayer(layer_Granicewojewdztw_2);
        //map.addLayer(layer_Granicewojewdztw_2);
		
		
		
		function style_Granicewojewdztw_1_0() {
            return {
                pane: 'pane_Granicewojewdztw_1',
                opacity: 1.0,
                color: wojBack,
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.2, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(200,162,240,0.0)',
				interactive: false,
            }
        }
        map.createPane('pane_Granicewojewdztw_1');
        map.getPane('pane_Granicewojewdztw_1').style.zIndex = 402;
        //map.getPane('pane_Granicewojewdztw_1').style['mix-blend-mode'] = 'normal';
		map.createPane('pane_layer_PL1931');
		map.getPane('pane_layer_PL1931').style.zIndex = 410;
		//map.getPane('pane_layer_PL1931').style['mix-blend-mode'] = 'normal';
		function style_PL1931() {
            return {
                pane: 'pane_layer_PL1931',
                opacity: 1.0,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.6, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(154,206,98,0.0)',
				interactive: false,
            }
        }
		map.createPane('pane_layer_PL1931a');
		map.getPane('pane_layer_PL1931a').style.zIndex = 411;
		map.getPane('pane_layer_PL1931a').style['mix-blend-mode'] = 'normal';
		map.createPane('pane_layer_PL1897a');
		map.getPane('pane_layer_PL1897a').style.zIndex = 413;
		map.getPane('pane_layer_PL1897a').style['mix-blend-mode'] = 'normal';
		map.createPane('pane_layer_PL1897');
		map.getPane('pane_layer_PL1897').style.zIndex = 412;
		map.getPane('pane_layer_PL1897').style['mix-blend-mode'] = 'normal';
		map.createPane('pane_layer_ZAB1910');
		map.getPane('pane_layer_ZAB1910').style.zIndex = 414;
		map.getPane('pane_layer_ZAB1910').style['mix-blend-mode'] = 'normal';
		map.createPane('pane_layer_ZAB1910a');
		map.getPane('pane_layer_ZAB1910a').style.zIndex = 415;
		map.getPane('pane_layer_ZAB1910a').style['mix-blend-mode'] = 'normal';
		function style_PL1931a() {
            return {
                pane: 'pane_layer_PL1931a',
                opacity: 1.0,
                color: 'rgba(255,64,64,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.8, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(154,206,98,0.0)',
				interactive: false,
            }
        }
		function style_PL1897() {
            return {
                pane: 'pane_layer_PL1897',
                opacity: 1.0,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.6, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(154,206,98,0.0)',
				interactive: false,
            }
        }
		function style_PL1897a() {
            return {
                pane: 'pane_layer_PL1897a',
                opacity: 1.0,
                color: 'rgba(0,128,0,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.8, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(154,206,98,0.0)',
				interactive: false,
            }
        }
		function style_ZAB1910() {
            return {
                pane: 'pane_layer_ZAB1910',
                opacity: 1.0,
                color: 'rgba(255,255,255,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 3.6, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(154,206,98,0.0)',
				interactive: false,
            }
        }
		function style_ZAB1910a() {
            return {
                pane: 'pane_layer_ZAB1910a',
                opacity: 1.0,
                color: 'rgba(0,0,160,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 1.8, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(154,206,98,0.0)',
				interactive: false,
            }
        }
		//var layer_Granicewojewdztw_1 = layer_Granicewojewdztw_2;
		//layer_Granicewojewdztw_1.style.color = 'white';
        var layer_Granicewojewdztw_1 = new L.geoJson(json_Granicewojewdztw_2 , {
            attribution: '<a href=""></a>',
            pane: 'pane_Granicewojewdztw_1',
			onEachFeature: pop_Granicewojewdztw_1,
            style: style_Granicewojewdztw_1_0,
        });
		//json_PL1931
		var layer_PL1931 = new L.geoJson(json_PL1931 , {
            //attribution: '<a href="https://censusmosaic.demog.berkeley.edu/data/historical-gis-files">mosaic</a>',
            pane: 'pane_layer_PL1931',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_PL1931
        });
		var layer_PL1931a = new L.geoJson(json_PL1931 , {
            pane: 'pane_layer_PL1931a',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_PL1931a
        });
		var layer_PL1897 = new L.geoJson(json_PL1897 , {
            pane: 'pane_layer_PL1897',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_PL1897
        });
		var layer_PL1897a = new L.geoJson(json_PL1897 , {
            pane: 'pane_layer_PL1897a',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_PL1897a
        });
		var layer_ZAB1910 = new L.geoJson(json_ZAB1910 , {
            pane: 'pane_layer_ZAB1910',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_ZAB1910
        });
		var layer_ZAB1910a = new L.geoJson(json_ZAB1910a , {
            pane: 'pane_layer_ZAB1910a',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_ZAB1910
        });
		var layer_ZAB1910_a = new L.geoJson(json_ZAB1910 , {
            pane: 'pane_layer_ZAB1910',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_ZAB1910a
        });
		var layer_ZAB1910a_a = new L.geoJson(json_ZAB1910a , {
            pane: 'pane_layer_ZAB1910a',
			//onEachFeature: pop_Granicewojewdztw_1,
            style: style_ZAB1910a
        });
        //bounds_group.addLayer(layer_Granicewojewdztw_2);
        //map.addLayer(layer_Granicewojewdztw_2);
		console.log(wojewods);
		function resetBorders(){
			var zzoom = map.getZoom();
			var wweight = Math.pow((1.4+(Math.pow((10-zzoom),2)-5)/49),(zzoom-6));
			layer_Granicewojewdztw_1.setStyle({color: wojBack, weight: wweight*2.8, fillPattern: patt_blank});
			layer_Granicewojewdztw_2.setStyle({color: wojFront, weight: wweight*1.96, fillPattern: patt_blank});
			
			layer_Powiaty_Simplified_2.setStyle({color: powBack, weight: wweight*1.8, fillPattern: patt_blank});
			layer_Powiaty_Simplified_1.setStyle({color: powFront, weight: wweight*1.2, fillPattern: patt_blank});
		}
		
		var Powiaty = L.layerGroup([layer_Powiaty_Simplified_1, layer_Powiaty_Simplified_2]);
		var Wojewod = L.layerGroup([layer_Granicewojewdztw_1, layer_Granicewojewdztw_2 ]);
		var IIRP = L.layerGroup([layer_PL1931a, layer_PL1931 ]);
		var KP1897 = L.layerGroup([layer_PL1897a, layer_PL1897 ]);
		var NA1910 = L.layerGroup([layer_ZAB1910, layer_ZAB1910a, layer_ZAB1910_a, layer_ZAB1910a_a ]);
		
		bounds_group.addLayer(Powiaty);
        map.addLayer(Powiaty);
		bounds_group.addLayer(Wojewod);
        map.addLayer(Wojewod);
		//bounds_group.addLayer(layer_PL1931);
		//map.addLayer(layer_PL1931);
		
		var baseMaps = {
			/*'<img src="legend/Granicewojewdztw_2.png" /> Granice województw': Wojewod,*/
			'2010': layer_10,
			'2015': layer_15,
			'2020': layer_20,
			'2010 -> 2015': layer_1510,
			'2015 -> 2020': layer_2015,
			'2010 -> 2020': layer_2010,
			'2010 -> 2015 ': layer_1510c,
			'2015 -> 2020 ': layer_2015c,
			'2010 -> 2020 ': layer_2010c
		};
		var bestMaps = {};
		
		var variables = [
			'Polska',
			'02 	województwo dolnośląskie',
			'04 	województwo kujawsko-pomorskie',
			'06 	województwo lubelskie',
			'08 	województwo lubuskie',
			'10 	województwo łódzkie',
			'12 	województwo małopolskie',
			'14 	województwo mazowieckie',
			'16 	województwo opolskie',
			'18		województwo podkarpackie',
			'20 	województwo podlaskie',
			'22 	województwo pomorskie',
			'24 	województwo śląskie',
			'26 	województwo świętokrzyskie',
			'28 	województwo warmińsko-mazurskie',
			'30 	województwo wielkopolskie',
			'32 	województwo zachodniopomorskie'];
		var subvariables = [];
		var _axis = [
			'x: '+xb+ ', y: '+yb,
			'x: '+xb+ ', y: '+zb,
			'x: '+yb+ ', y: '+xb,
			'x: '+yb+ ', y: '+zb,
			'x: '+zb+ ', y: '+xb,
			'x: '+zb+ ', y: '+yb,];
        var layerControl = new L.control.layers(baseMaps,{'<img src="legend/Granicewojewdztw_2.png" /> Granice województw': Wojewod,'<img src="legend/Powiaty_Simplified_1.png" /> Granice powiatów': Powiaty, '<img src="legend/PL1931.png" /> Polska w 1931 r.': IIRP, '<img src="legend/PL1897.png" /> Królestwo Polskie w 1897 r.': KP1897, '<img src="legend/ZAB1910.png" /> Niemcy i Austro-Węgry w 1910 r.': NA1910},{collapsed:true}).addTo(map);
		var layerControl1 = new L.control.layers(null,null,{collapsed:true}).addTo(map);
		var layerControl2 = new L.control.layers(null,null,{collapsed:false}).addTo(map);
		
		function meanTable(){
			$('.leaflet-control-layers-list:eq( 1 ) h5:eq(1)').remove();
			$('.leaflet-control-layers-list:eq( 1 ) table:eq(1)').remove();
			/*$('.leaflet-control-layers-list:eq( 1 )').append*/$('<div>\
				<h5 style="text-align: center; color: #282828; margin-bottom: 8px;">Wartości średnie dla&nbsp;gmin (<em><span style="color: red;">Polska</span></em>):</h5>\
				<table class = "tabela" id="Podsumowanie_mean">\
				<thead>\
					<tr style="background: none;">\
						<th style="border-right: 2px solid #eee; border-top-left-radius: 32px;"></th>\
						<th><b>2010</b></th>\
						<th><b>2015</b></th>\
						<th style="border-right: 2px solid #eee;"><b>2020</b></th>\
						<th><b>2010->2015</b></th>\
						<th><b>2015->2020</b></th>\
						<th>2010->2020</b></th>\
					</tr>\
				</thead>\
				<tbody></tbody></table></div>').insertAfter('#Podsumowanie_tot');
			//28,4	22,55	49,06
			//30	21,01	49
			//40,39	24,76	34,85
			$('.leaflet-control-layers-list:eq( 1 ) #Podsumowanie_mean tbody').append(renderRow('Kandydat popierany przez PiS:',28.4,30,40.39,false));
			$('.leaflet-control-layers-list:eq( 1 ) #Podsumowanie_mean tbody').append(renderRow('Kandydat popierany przez PO:',22.55,21.01,24.76,false));
			$('.leaflet-control-layers-list:eq( 1 ) #Podsumowanie_mean tbody').append(renderRow('Absencja i głosy nieważne:',49.06,49,34.86,false));
			chosenCol('Podsumowanie_mean');
		}
		
		$('.leaflet-control-layers-toggle:eq( 0 )').html('<div style="background-image: linear-gradient(to right, #c4d3ae 0%, #b8e186 51%, #c4d3ae 100%); border-radius: 8px;box-shadow: 0 0 20px #888; border: 2px solid #fff; text-shadow: -1px 0 #b8e186, 0 1px #b8e186, 1px 0 #b8e186, 0 -1px #b8e186;">Wybór mapy...</div>');
		$('.leaflet-control-layers-toggle:eq( 1 )').html('<div style="background-image: linear-gradient(to right, #c4d3ae 0%, #b8e186 51%, #c4d3ae 100%); border-radius: 8px;box-shadow: 0 0 20px #888; border: 2px solid #fff; text-shadow: -1px 0 #b8e186, 0 1px #b8e186, 1px 0 #b8e186, 0 -1px #b8e186;">Podsumowanie</div>');
		$('.leaflet-control-layers-toggle:eq( 2 )').html('<div style="background-image: linear-gradient(to right, #c4d3ae 0%, #b8e186 51%, #c4d3ae 100%); border-radius: 8px;box-shadow: 0 0 20px #888; border: 2px solid #fff; text-shadow: -1px 0 #b8e186, 0 1px #b8e186, 1px 0 #b8e186, 0 -1px #b8e186;">Dane na wykresie</div>');

		
		$('.leaflet-control-layers-list:eq( 1 )').html('<div>\
				<h5 style="text-align: center; color: #282828; margin-bottom: 8px;">Wyniki II tury Wyborów Prezydenta RP w latach 2010, 2015 i 2020<br>jako odsetek osób uprawnionych do&nbsp;głosowania (<em><span style="color: red;">Polska i zagranica</span></em>):</h5>\
				<table class = "tabela" id="Podsumowanie_tot">\
				<thead>\
					<tr style="background: none;">\
						<th style="border-right: 2px solid #eee; border-top-left-radius: 32px;"></th>\
						<th><b>2010</b></th>\
						<th><b>2015</b></th>\
						<th style="border-right: 2px solid #eee;"><b>2020</b></th>\
						<th><b>2010->2015</b></th>\
						<th><b>2015->2020</b></th>\
						<th>2010->2020</b></th>\
					</tr>\
				</thead>\
				<tbody></tbody></table></div>');
		$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',25.68,28.1,34.49,false));
		$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',28.97,26.42,33.1,false));
		$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',45.34,45.48,32.41,false));
		chosenCol('Podsumowanie_tot');
		meanTable();
		$('.leaflet-control-layers-list:eq( 1 )').append('<p style="margin-bottom: -16px;">Źródło: Opracowanie własne na podstawie danych PKW.</p>');
		
		$('.leaflet-control-layers-list:eq( 2 )').html('<div id="info-pane" class="leaflet-bar chart-container">\
			  <canvas id="chartCanvas"></canvas>\
			</div>');
		$('.leaflet-control-layers-list:eq( 1 )').css('line-height', '1.0');
		$('.leaflet-control-layers-list:eq( 1 )').css('background-image', 'linear-gradient(to right, #efd 0%, #efd 51%, #efd 100%)');
		$('.leaflet-control-layers:eq( 1 )').css('opacity', '1.0');
		$('.leaflet-control-layers-list:eq( 2 )').css('line-height', '1.0');
		$('.leaflet-control-layers-list:eq( 1 )').css('font-size', '12px');
		$('.leaflet-control-layers-list:eq( 2 )').css('font-size', '12px');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="filter"><span style="text-align:center">Filtruj gminy:</span></div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="subfilter"></div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div id="changer"><span style="text-align:center">"Obróć" wykres:</span></div>');
		$('.leaflet-control-layers-list:eq( 2 )').append('<div style="margin:  32px 0px 0px 0px;"></div>');
		//$('.leaflet-control-layers-list:eq( 1 )').append('</tbody></table></div>');
		
		scatterPlotDataArray = scatterPlotDataArray_xy;
		scatterPlotDataArray10 = scatterPlotDataArray10_xy;
		scatterPlotDataArray15 = scatterPlotDataArray15_xy;
		scatterPlotDataArray20 = scatterPlotDataArray20_xy;

		var initialChartData = {
			datasets: [{
			  label: 'Wybrana gmina',
			  data: [],
			  pointRadius: 6.4,
			  pointBorderColor: 'rgba(255, 0, 0, 1.0)',
			  pointBorderWidth: 2,
			  pointHoverRadius: 5.6,
			  pointBackgroundColor: pointFBackgroundColors
			},{
			  label: 'Filtr gmin',
			  title: 'Wybory Prezydenta RP',
			  // the data values are empty at this moment
			  // and will be updated dynamically below
			  data: [],
			  pointRadius: pointRadiuses,
			  pointBorderColor: pointBorderColors,
			  pointBorderWidth: pointBorderWidths,
			  pointHoverRadius: 5.6,
			  pointBackgroundColor: pointBackgroundColors
			},{
			  label: 'Kontekst',
			  data: [],
			  pointBorderColor: pointBBorderColors,
			  pointBackgroundColor: pointBBackgroundColors
			}]
		  };

			function average(a) {
			  //const values = ctx.chart.data.datasets[0].data;
			  const values = scatterPlotDataArray;
			  console.log(values[0].x);
			  var ret  = 0/*values.reduce((a, b) => a.x + b.x, 0) / values.length*/;
			  //console.log(ret);
			 for (i=0;i<values.length;i++){
				if (a==1){
					ret+=values[i].x;
				}else{
					ret+=values[i].y;
				}
			  }
			  return ret/values.length;
			}

		  var chartOptions = {
			scales: {
			  xAxes: [{
				scaleLabel: {
				  display: true,
				  labelString: 'Komorowski'
				},
				ticks: {
				  //beginAtZero: true,
				  max: 80,
				  stepSize: 20
				}
			  }],
			  yAxes: [{
				scaleLabel: {
				  display: true,
				  labelString: 'Kaczyński'
				},
				ticks: {
				  //beginAtZero: true,
				  max: 80,
				  stepSize: 20
				}
			  }]
			},
			title: {
				display: true,
				text: ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:']
			},
			annotation: {
			  annotations: [{
				  mode: 'vertical',
				  type: 'line',
				  scaleID: 'x-axis-1',
				  //value: 22.55,
				  value: average(1),
				  borderColor: 'rgba(255, 99, 132, 0.5)',
				  borderDash: [8, 8],
				  borderWidth: 4,
				  label: {
					enabled: true,
					content:  'Średnia: ' + average(1).toFixed(2)+jedn,
					backgroundColor: 'rgba(224,224,128,0.2)',
					fontSize: 10,
					fontColor: 'rgb(96,0,0)',
					position: 'top'
				  }
				},
				{
				  mode: 'horizontal',
				  type: 'line',
				  scaleID: 'y-axis-1',
				  value: average(2),
				  borderColor: 'rgba(255, 99, 132, 0.5)',
				  borderDash: [8, 8],
				  borderWidth: 4,
				  label: {
					enabled: true,
					content: 'Średnia: ' + average(2).toFixed(2)+jedn,
					backgroundColor: 'rgba(224,224,128,0.2)',
					fontSize: 10,
					fontColor: 'rgb(96,0,0)',
					position: 'right'
				  }
				}]
			},
			
			legend: {
				display: true,
				'onClick' : function (e, legendItem) {
					//alert('Legend item ' + legendItem.datasetIndex + ' clicked');  
					const index = legendItem.datasetIndex;
					const ci = this.chart;
					const meta = ci.getDatasetMeta(index);
					
					//ci.options.annotation.annotations[0].label.enabled = false;
					//ci.options.annotation.annotations[0].borderColor = 'rgba(255, 99, 132, 0.0)';
					//ci.options.title.text = 'Dane';
					
					//ci.options.annotation.annotations[1].enabled = false;
						// See controller.isDatasetVisible comment
					//meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
					if (meta.hidden === null){
						if (index==2){
							ci.options.annotation.annotations[0].borderColor = 'rgba(0,0,0,0.0';
							ci.options.annotation.annotations[0].label.enabled = false;
							ci.options.annotation.annotations[1].borderColor = 'rgba(0,0,0,0.0';
							ci.options.annotation.annotations[1].label.enabled = false;
						}
						meta.hidden = !ci.data.datasets[index].hidden;
					}else{
						if (index==2){
							if (layer_code!=l7&&layer_code!=l8&&layer_code!=l9||year!=0){
								ci.options.annotation.annotations[0].borderColor = 'rgba(255, 99, 132, 0.5)';
								ci.options.annotation.annotations[0].label.enabled = true;
								ci.options.annotation.annotations[1].borderColor = 'rgba(255, 99, 132, 0.5)';
								ci.options.annotation.annotations[1].label.enabled = true;
							}
						}
						meta.hidden = null;
					}
					//alert(meta.hidden);
						// We hid a dataset ... rerender the chart
					
					  //chart.update();
					
					
					ci.update();
					console.log(ci.legend);
					//chart.update();
                },
				/*color: 'rgb(255, 99, 132)',
				labels: [{
					{
					boxWidth: 20,
					color: 'rgb(255, 255, 132)'
					}/*,{
					color: 'rgb(255, 99, 255)'
					},{
					color: 'rgb(99, 99, 132)'
				}]*/
				labels:{
					boxWidth: 20
				}
			},
			tooltips: {
			  enabled: false,
			  mode: 'single',
			  //intersect: false,
			  filter: function (tooltipItem) {
				  console.log(tooltipItem.datasetIndex);
				  //item_set = tooltipItem.datasetIndex;
				  if (tooltipItem.datasetIndex === 0 || tooltipItem.datasetIndex === 1){
					return true;
				  }else{
				    return false;
				  }
			  },
			  custom: function(tooltipModel) {
				try{
				  /* if data & datasets not empty & tooltip available */
				 // var d = chart.data.datasets[1].data[100].featureId;
				  console.log(tooltipModel);
				  //console.log(d);
				  //console.log($('#chartjs-tooltip').text());
				  //console.log($('#tooltip').text());
				 // var tooltipEl = document.getElementById('chartjs-tooltip');
				  
				  var tooltipEl = document.getElementById('tooltip');
				  console.log(tooltipEl);
					// Create element on first render
					if (!tooltipEl) {
						tooltipEl = document.createElement('div');
						tooltipEl.id = 'tooltip';
						tooltipEl.innerHTML = '<table></table>';
						document.body.appendChild(tooltipEl);
					}
				  /*if(tooltipEl.hasOwnProperty('dataPoints') && tooltipEl.dataPoints[0] != 'undefined'){
					if(tooltipModel.dataPoints[0].datasetIndex == 0) // <-- dataset index
						return;
				  }*/
				  /*if (tooltipModel.opacity !== 0 && chart.data.labels.length && chart.data.datasets.length) {
					//get dataPoints index 
					var index = tooltipModel.dataPoints[0].index;
					// get dataPoints datasetIndex 
					var dataSetIndex = tooltipModel.dataPoints[0].datasetIndex;
					// get the current color on index and datasetIndex position 
					var color =  chart.data.datasets[dataSetIndex].backgroundColor[index];
					// set backgroundColor 
					tooltipModel.backgroundColor = color;
				  };*/
				   // Hide if no tooltip
                if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }

                // Set caret Position
                tooltipEl.classList.remove('above', 'below', 'no-transform');
                if (tooltipModel.yAlign) {
                    tooltipEl.classList.add(tooltipModel.yAlign);
                } else {
                    tooltipEl.classList.add('no-transform');
                }

                function getBody(bodyItem) {
                    return bodyItem.lines;
                }

                // Set Text
                if (tooltipModel.body) {
                    var titleLines = tooltipModel.title || [];
					//var titleLines =  ['Nojewo'];
                    var bodyLines = tooltipModel.body.map(getBody);
					/*console.log(titleLines);*/
					console.log(bodyLines);
                    var innerHtml = '<thead>';

                    titleLines.forEach(function(title) {
						console.log(title);
						
                        innerHtml += '<tr><th><span style="background:' + tooltipModel.labelColors[0].backgroundColor + '; border: 1px solid rgba(255,255,255,0.5);width: 8px; height: 8px;display:inline-block;"></span>  <b style=" font-size: 12px; text-align: center;">' + title + '</b></th></tr>';
						
                        //innerHtml += '<tr><th>Klwówek</th></tr>';
                    });
                    innerHtml += '</thead><tbody>';

                    bodyLines.forEach(function(body, i) {
                        /*var colors = tooltipModel.labelColors[i];
						console.log(tooltipModel.labelColors[i]);
                        var style = 'background:' + colors.backgroundColor;
                        style += '; border-color:' + colors.borderColor;
                        style += '; border-width: 2px';
                        var span = '<span style="' + style + '"></span>';*/
                        //innerHtml += '<tr><td>' + /*span +*/ body + 'KK</td></tr>';
                        innerHtml += body ;
                    });
                   //innerHtml += '</tbody>';

                   var tableRoot = tooltipEl.querySelector('table');
                    tableRoot.innerHTML = innerHtml;
					//$('#chartjs-tooltip table').html(innerHtml);
					//console.log($('#chartjs-tooltip').text());
                }

                // `this` will be the overall tooltip
                var position = this._chart.canvas.getBoundingClientRect();
                //var position = chart.canvas.getBoundingClientRect();

                // Display, position, and set styles for font
                tooltipEl.style.opacity = 1;
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                tooltipEl.style.fontFamily = tooltipModel._bodyFontFamily;
                tooltipEl.style.fontSize = /*tooltipModel.bodyFontSize +*/ '10px';
                tooltipEl.style.fontStyle = tooltipModel._bodyFontStyle;
                tooltipEl.style.zIndex = '9999';
                //tooltipEl.style.padding = tooltipModel.yPadding + 'px ' + tooltipModel.xPadding + 'px';
                tooltipEl.style.padding = '2px 2px';
                tooltipEl.style.pointerEvents = 'none';
				console.log(tooltipEl);
				//$('#info-pane table').html(innerHtml);
				//console.log($('#chartjs-tooltip').html());
				//console.log($('#tooltip').html());
				}catch(e){
				console.log(e);
				/*innerHtml += '<tr><th><span style="background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.5);width: 8px; height: 8px;display:inline-block;"></span>  <b style=" font-size: 12px; text-align: center;">' + title + '</b></th></tr>';*/
				}
				//return innerHtml;
			},
                callbacks: {
                    afterBody: function(tooltipItems, data) { 
						/*console.log(chart.data.datasets[0].data[tooltipItems[0].index]);
						console.log(chart.data.datasets[1].data[tooltipItems[0].index]);
						console.log(chart.data.datasets[2].data[tooltipItems[0].index]);*/
                    },
					title: function(tooltipItems, data) {
						
						//var value = [kodList[tooltipItems[0].index].substring(6, 7) !== "1"? 'gm.' : 'm.'];
						var value = ['<b>'];
						console.log(tooltipItems);
						//console.log(typeof tooltipItems[0].datasetIndex);
						console.log(chart.data.datasets[1].data);
						console.log(chart.data.datasets[2].data);
						function waitForElement(){
						if (typeof tooltipItems[0].datasetIndex !== "undefined" /*&& tooltipItems[0].length > 0 *//*&& (tooltipItems[0].datasetIndex == 0 || tooltipItems[0].datasetIndex == 1)*/){
							console.log(tooltipItems[0]);
							value.push(chart.data.datasets[tooltipItems[0].datasetIndex].data[tooltipItems[0].index].featureId.substring(6, 7) !== "1"? 'gm.' : 'm.');
							value.push(' '+gminList[tooltipItems[0].index]+'</b>');
						}else{
							console.log("Tooltip widmo");
							setTimeout(waitForElement, 50);
							//return '';
						}
						}
						/* && (tooltipItems[0].datasetIndex == 0 || tooltipItems[0].datasetIndex == 1)*/
						try{
							waitForElement();
						}catch(e){
							console.log("Mamy błąd" + e);
						}
						return value.join('');
					},
					label: function(tooltipItems, data) {
						return setTooltipText('Kaczyński', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
					}					
                }
			},
			onClick: function(evt) {   
				var element = chart.getElementAtEvent(evt);
				var clickFeatureIds = element.map(function (datum) {
					return chart.data.datasets[1].data[datum._index].featureId;
				});
			  
				
				//customControlLayers();
				layer_current.eachLayer(function (evt, idx) {
				  if (clickFeatureIds.indexOf(evt.feature.properties.JPT_KOD_JE) > -1) {
					console.log(year);
					switch(year){
						case 0:
							break;
						case 10:
							map.removeLayer(layer_current);
							layer_current = layer_10;
							layer_10.addTo(map);
							chart.update();
							customControlLayers();
							break;
						case 15:
							map.removeLayer(layer_current);
							layer_current = layer_15;
							layer_15.addTo(map);
							chart.update();
							customControlLayers();
							break;
						case 20:
							map.removeLayer(layer_current);
							layer_current = layer_20;
							layer_20.addTo(map);
							chart.update();
							customControlLayers();
							break;
						default:
							break;
							/*layer_current = layer_10;
							layer_10.addTo(map);
							chart.update();*/
				  }
				  layer_current.eachLayer(function(layer) {	//restore feature color
						layer_current.resetStyle(layer);
				  });
					//map.fitBounds(layers[evt.feature.properties.JPT_KOD_JE].getBounds());
					//map.fitBounds(wojewods[evt.feature.properties.JPT_KOD_JE.substring(0,2)].getBounds());
					/*layer_current.eachLayer(function(layer) {	//restore feature color
						layer_current.resetStyle(layer);
					});*/
					layers[evt.feature.properties.JPT_KOD_JE].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
					manual_popup = false;
					layers[evt.feature.properties.JPT_KOD_JE].openPopup();
					manual_popup = true;
					//map.once('moveend', layers[evt.feature.properties.JPT_KOD_JE].openPopup(), layer_current);
				  } else {
					//console.log('Void');
				  }
				});
				
			},
			maintainAspectRatio: false,
			// turn off animations during chart data updates
			animation: {
			  duration: 0.2
			},
			// see STEP 4 below
			onHover: handleChartHover
			};

		var ctx = document.getElementById('chartCanvas').getContext('2d');
		var chart = new Chart(ctx, {
			type: 'scatter',
			data: initialChartData,
			options: chartOptions
		 });
		 function updateAnn(){
			chart.options.annotation.annotations[0].value = average(1);
			chart.options.annotation.annotations[0].label.content = sred + average(1).toFixed(2)+jedn;
			chart.options.annotation.annotations[1].value = average(2);
			chart.options.annotation.annotations[1].label.content = sred + average(2).toFixed(2)+jedn;
		 }
		 function switchAnn(a){
			if (a==0||chart.legend.legendItems[2].hidden==true){
				chart.options.annotation.annotations[0].borderColor = 'rgba(0,0,0,0.0';
				chart.options.annotation.annotations[0].label.enabled = false;
				chart.options.annotation.annotations[1].borderColor = 'rgba(0,0,0,0.0';
				chart.options.annotation.annotations[1].label.enabled = false;
			}else{
				chart.options.annotation.annotations[0].borderColor = 'rgba(255, 99, 132, 0.5)';
				chart.options.annotation.annotations[0].label.enabled = true;
				chart.options.annotation.annotations[1].borderColor = 'rgba(255, 99, 132, 0.5)';
				chart.options.annotation.annotations[1].label.enabled = true;
			}
		 }
		/*var originalGetElementAtEvent = chart.getElementAtEvent;
		chart.getElementAtEvent = function () {
		  return originalGetElementAtEvent.apply(this, arguments).filter(function (e) {
			console.log(e._datasetIndex);
			return e._datasetIndex == 0;
		  });
		}*/
		
		
		chart.data.datasets[0].data = checkPoint();
		chart.data.datasets[1].data = scatterPlotDataArray;
		chart.data.datasets[2].data = [];
		//console.log(chart.data.datasets[0]);
		//console.dir(chart.tooltipModel.positioners);
		console.log(chart);
					
		chart.update();
		//console.log(scatterPlotDataArray);
		//console.log(layers);
		//console.log(chart.data.datasets[1].data[0]);
		
		  function handleChartHover (e) {
			var chartHoverData = chart.getElementsAtEvent(e);
			//console.log(chartHoverData);
			if (!chartHoverData.length) {
			  // if there were no data elements found when hovering over the chart,
			  // reset any previous styling overrides and return
			  /*layer_current.eachLayer(function (e) {
			  });*/

			  return;
			}

			// otherwise, bring attention to the features on the map
			// that are currently being hovered over in the chart
			var hoverFeatureIds = chartHoverData.map(function (datum) {
			  return chart.data.datasets[1].data[datum._index].featureId;
			});
			//console.log(hoverFeatureIds);
			/*layer_Gminy_0.eachLayer(function (e, idx) {
			  if (hoverFeatureIds.indexOf(e.feature.properties.JPT_KOD_JE) > -1) {
				//layers[e.feature.properties.JPT_KOD_JE].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
				//layers[e.feature.properties.JPT_KOD_JE].openPopup();
				//console.log('Something');
				//layers[e.feature.properties.JPT_KOD_JE].setZIndexOffset(10000);
			  } else {
				//console.log('Void');
				//e.setStyle({color: 'rgba(255,255,255,0.0)', weight: '8', lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,255,0,0.1)',});
			  }
			});*/
		  }
		/*for (i=0; i<scatterPlotDataArray_xy.length; i++){
			var el = scatterPlotDataArray_xy[i];
			var x = el.x;
			var y = el.y;
			el.x = 100-(x+y);
			scatterPlotDataArray_zy.push(el);
			el.x = x;
		}*/
		//var ranges = {};
		//console.log(powList);
		function fitChart(){
			var vminX = arrayXMin(chart.data.datasets[1].data);
			var vminY = arrayYMin(chart.data.datasets[1].data);
			var vmaxX = arrayXMax(chart.data.datasets[1].data);
			var vmaxY = arrayYMax(chart.data.datasets[1].data);
			console.log("fitChart: "+vmaxX);
			console.log("fitChart: "+vmaxY);
			var vdiffX = vmaxX - vminX;
			var vdiffY = vmaxY - vminY;
			if (vdiffX>15){
				vminX=Math.floor(vminX/5)*5;
				vmaxX=Math.ceil(vmaxX/5)*5;
				//stepSize: 5
				chart.options.scales.xAxes[0].ticks.stepSize= 5;
			}else{
				vminX=Math.floor(vminX/2)*2;
				vmaxX=Math.ceil(vmaxX/2)*2;
				chart.options.scales.xAxes[0].ticks.stepSize= 2;
			}
			if (vdiffY>15){
				vminY=Math.floor(vminY/5)*5;
				vmaxY=Math.ceil(vmaxY/5)*5;
				chart.options.scales.yAxes[0].ticks.stepSize= 5;
			}else{
				vminY=Math.floor(vminY/2)*2;
				vmaxY=Math.ceil(vmaxY/2)*2;
				chart.options.scales.yAxes[0].ticks.stepSize= 2;
			}
			//chart.options.scales.xAxes[0].ticks={};
			//chart.options.scales.yAxes[0].ticks={};
			chart.options.scales.xAxes[0].ticks.beginAtZero= false;
			chart.options.scales.yAxes[0].ticks.beginAtZero= false;
			chart.options.scales.xAxes[0].ticks.min= vminX;
			chart.options.scales.yAxes[0].ticks.min= vminY;
			chart.options.scales.xAxes[0].ticks.max= vmaxX;
			chart.options.scales.yAxes[0].ticks.max= vmaxY;
		}
		
		function setChart(bzero = true, _min = 0, _max = 80, _step = 20){
			chart.options.scales.xAxes[0].ticks = {
			  beginAtZero: bzero,
			  min: _min,
			  max: _max,
			  stepSize: _step
			};
			chart.options.scales.yAxes[0].ticks = {
			  beginAtZero: bzero,
			  min: _min,
			  max: _max,
			  stepSize: _step
			};
		
		}
		
		var filtered = false;
		function checkPoint(){
			var checkedPlotDataArray =[];
			//console.log(woj);
			for (i=0; i<scatterPlotDataArray.length; i++){
				var el = scatterPlotDataArray[i];
				//el.x = 100-(el.x+el.y);
				if (el.featureId==current_KOD){
					checkedPlotDataArray.push(el);
				}else{
					checkedPlotDataArray.push(0);
				}
			}
			return checkedPlotDataArray;	
		}
		function filterChart(){
			var filteredPlotDataArray =[];
			var woj = $select.val().substring(0,2);
			//console.log(woj);
			for (i=0; i<scatterPlotDataArray.length; i++){
				var el = scatterPlotDataArray[i];
				//el.x = 100-(el.x+el.y);
				if (el.featureId.substring(0,2)==woj){
					filteredPlotDataArray.push(el);
				}else{
					filteredPlotDataArray.push(0);
				}
			}
			return filteredPlotDataArray;	
		}
		function subfilterChart(){
			var subfilteredPlotDataArray =[];
				var pow_ = $subselect.val().substring(0,4);
				//console.log(woj);
				for (i=0; i<scatterPlotDataArray.length; i++){
					var el = scatterPlotDataArray[i];
					//el.x = 100-(el.x+el.y);
					if (el.featureId.substring(0,4)==pow_){
						subfilteredPlotDataArray.push(el);
					}else{
						subfilteredPlotDataArray.push(0);
					}
				}
				return subfilteredPlotDataArray;
				
		}
		//var filteredListPowArray =[];
		function filterListPow(){
			var filteredListPowArray =[];
			//filteredListPowArray.length = 0;
				var woj_ = $select.val().substring(0,2);
				console.log("Filtrowanie listy powiatów z woj "+woj_);
				for (i=0; i<powList.length; i++){
					var el = powList[i];
					//el.x = 100-(el.x+el.y);
					if (woj_==el.substring(0,2)){
						filteredListPowArray.push(el);
					}/*else{
						filteredListPowArray.push(0);
					}*/
				}
				//console.log(filteredListPowArray);
				return filteredListPowArray;
				
		}
		var $select = $('<select></select>')
			.appendTo($('#filter'))
			.on('change', function() {
				if (!layer_change_first_clicked&&!subselect_change_first_clicked&&!popup_open_first_clicked&&!popup_close_first_clicked){
					select_change_first_clicked = true;
				}else{
					select_change_first_clicked = false;
				}
				console.log("select_change_first_clicked: " + select_change_first_clicked);
				//////alert("select_change_first_clicked: " + select_change_first_clicked);
				//map.closePopup();
				//Czyścimy listę powiatów w subselect oraz listę gmin na wykresie
				var filteredPlotDataArray =[];
				var filteredListPowArray = [];
				console.log('Lista województw');
				console.log('Filter: ' + filtered);
				console.log($(this).val());
				$subselect.empty();
				temp_zoomed = auto_zoom;
				/*layer_Granicewojewdztw_1.eachLayer(function(layer) {	//restore feature color
					layer_Granicewojewdztw_1.resetStyle(layer);
				});*/
				resetBorders();
				//map.getPane('pane_Granicewojewdztw_1').style.zIndex = 402;
				  switch(year){
						case 0:
							break;
						case 10:
							map.removeLayer(layer_current);
							layer_current = layer_10;
							layer_current.addTo(map);
							customControlLayers();
							//chart.update
							/*layer_current.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po10, p.pis10);
									pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
							});
								
							chart.data.datasets[0].pointBackgroundColor=pointBackgroundColors;*/
							break;
						case 15:
							map.removeLayer(layer_current);
							layer_current = layer_15;
							layer_current.addTo(map);
							customControlLayers();
							//chart.update();
							/*layer_current.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po15, p.pis15);
									pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
							});
								
							chart.data.datasets[0].pointBackgroundColor=pointBackgroundColors;*/
							break;
						case 20:
							console.log('Layer 2020');
							map.removeLayer(layer_current);
							console.log('Layer 2020 1.');
							layer_current = layer_20;
							layer_current.addTo(map);
							console.log('Layer 2020 2.');
							customControlLayers();
							//chart.update();
							/*layer_current.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po20, p.pis20);
									pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
							});
								
							chart.data.datasets[0].pointBackgroundColor=pointBackgroundColors;*/
							break;
						default:
							break;
							/*layer_current = layer_10;
							layer_10.addTo(map);
							chart.update();*/
				}
				//if (isPopupOpen()){
				
				//}
				console.log($(this).val());
				//if (select_change_first_clicked){
					layer_code = layer_current._leaflet_id;
				//}
				//changerToChart($changer);
				chart.data.datasets[0].data = checkPoint();
				if (!block_cl_pop/*&&popup_open_first_clicked*/){
					block_centering = true;
					map.closePopup();
					block_centering = false;
					//popup_open_first_clicked = false;
					//popup_close_first_clicked = true;
				}
				if ($(this).val()=='Polska'){
					chart.data.datasets[1].data = scatterPlotDataArray;
					//chart.data.datasets[0].data = [];
					console.log($select.val());
					console.log($subselect.val());
					chart.data.datasets[2].data = [];
					$subselect.empty();
					filtered = false;
					console.log('select changed ' + filtered);
					selected = false;
					already_selected = true;
					if (manual_zoom){
						map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.4});
					}else{
						var cbounds = layers[current_KOD].getBounds();
						map.setMaxZoom(map.getZoom());
						map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
						map.setMaxZoom(10);
					}
					//already_selected = false;
					if (!polygon_clicked&&!item_clicked&&!adm_clicked){
						sel_clicked = true;
					}else{
						sel_clicked = false;
					}
					if (item_clicked){
						//stały zoom
						auto_zoom = false;
					}else if (adm_clicked||sel_clicked){
						auto_zoom = true;
						/*if (!temp_zoomed){
							//stały zoom
							manually_zoomed = false;
						}else{
							//dopasowanie poligonu do okna
							manually_zoomed = true;
						//}*/
					}else{
						auto_zoom = temp_zoomed;
						//auto_zoom = false;
					}
					czoom = map.getZoom();
					//if (!popup_open_first_clicked&&!popup_close_first_clicked){
						console.log("sel kraj");
						//$(document).ready(function (){
						
						//manually_zoomed = true;
						//});
						$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html('Polska i zagranica');
						$('.leaflet-control-layers-list:eq( 1 ) table:eq(0) tbody').empty();
						$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',25.68,28.1,34.49,false));
						$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',28.97,26.42,33.1,false));
						$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',45.34,45.48,32.41,false));
						//map.getPane('labels').style.display = 'none';
						meanTable();
		
					//}
					if (layer_code==l1||layer_code==l2||layer_code==l3||year!=0){
						setChart();
						console.log("Chart setted");
					}else{
						console.log("Chart fitted");
						fitChart();
					}
					sred = 'Średnia: ';
					//chosenCol('Podsumowanie_mean');
				}else /*if ($subselect.val()==' ')*/{
					var woj = $(this).val().substring(0,2);
					
					if (!select_twice/*&&!manual_popup*/){
						already_selected = true;
						if (manual_zoom){
							map.fitBounds(wojewods[woj].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.4});
						}else{
							var cbounds = layers[current_KOD].getBounds();
							map.setMaxZoom(map.getZoom());
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							map.setMaxZoom(10);
						}
						selected = true;
						if (!polygon_clicked&&!item_clicked&&!adm_clicked){
							sel_clicked = true;
						}else{
							sel_clicked = false;
						}
						if (current_KOD.substring(0,2)!=woj){
							chart.data.datasets[0].data = [];
							chart.data.datasets[0].data.push(0);
						}
						console.log($select.val());
						console.log($subselect.val());
						//if (woj_zoom){
							//if (!popup_open_first_clicked&&!popup_close_first_clicked){
								console.log("sel woj");
							if (item_clicked){
								//stały zoom
								auto_zoom = false;
								//manually_zoomed = false;
							}else if (adm_clicked||sel_clicked){
								auto_zoom = true;
								/*if (!temp_zoomed){
									//stały zoom
									manually_zoomed = false;
								}else{
									//dopasowanie poligonu do okna
									manually_zoomed = true;
								//}*/
							}else{
								auto_zoom = temp_zoomed;
								//auto_zoom = false;
							}
							sred = 'Śr. (kraj): ';
					}
					//already_selected = false;
					
						
							//manually_zoomed = true;
							/*if (czoom<8){
								map.getPane('labels').style.display = 'none';
							}*/
							/*map.getPane('labels').style.display = 'inline-block';
							map.getPane('labels').style['text-align'] = 'center';*/
						//}
					//}
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(0) span').html($select.val().substring(3));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
					console.log(json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0]);
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS10"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS15"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PO10"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PO15"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PO20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS10"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS15"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) h5:eq(1)').remove();
					$('.leaflet-control-layers-list:eq( 1 ) table:eq(1)').remove();
					woj_zoom = true;
					if (current_KOD.substring(0,2)!=woj){
						chart.data.datasets[0].data = [];
					}
					/*map.getPane('labels').style.display = 'inline-block';
					map.getPane('labels').style['text-align'] = 'center';*/
					//console.log(woj);
					for (i=0; i<scatterPlotDataArray.length; i++){
						var el = scatterPlotDataArray[i];
						//el.x = 100-(el.x+el.y);
						if (el.featureId.substring(0,2)==woj){
							filteredPlotDataArray.push(el);
						}else{
							filteredPlotDataArray.push(0);
						}
					}
					console.log(filteredPlotDataArray);
					/*filteredListPowArray = filterListPow();
					for (var i = 0; i < filteredListPowArray.length+1; i++) {
						//ranges[variables[i]] = { min: Infinity, max: -Infinity };
						// Simultaneously, build the UI for selecting different
						// ranges
						if (i==0){
							$('<option></option>')
							.text(' ')
							.attr('value', 'none')
							.appendTo($subselect);
						}else{
							$('<option></option>')
							.text(filteredListPowArray[i-1])
							.attr('value', filteredListPowArray[i-1])
							.appendTo($subselect);
						}
					}*/
					//filterListPow();
					//filterChart();
					//console.log('Wybrane woj ' + filteredPlotDataArray);
					chart.data.datasets[1].data = filteredPlotDataArray;
					//chart.data.datasets[1].data = filterChart;
					//chart.data.datasets[0].data = [];
					chart.data.datasets[2].data = [];
					fitChart();
					filtered = true;
					//alert("Select changed - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
					sel_clicked = false;
					console.log('select changed ' + filtered);
					//filteredPlotDataArray =[];
					czoom = map.getZoom();
					wojewods[woj].setStyle({color: 'rgba(255,255,255,1.0)'/*, fillColor: 'rgba(255,224,224,0.25)'*/, fillPattern: stripes, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*3.36});
					wojewods2[woj].setStyle({color: 'rgba(224,0,0,1.0)', weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.24});
					wojewods2[woj].bringToFront();
					console.log('Zmiana stylu woj');
				}
				//already_selected = false;
				
				chosenCol('Podsumowanie_tot');
				//manually_zoomed = auto_zoom;
				/*for (i=0; i<filteredPlotDataArray.length; i++) {
					var fl = filteredPlotDataArray[i];
					fl.x = 100-(fl.x+fl.y);
				}*/
				//////alert('select_twice: '+select_twice);
				//szoom = map.getZoom();
				//console.log("czoom: "+czoom+" szoom: "+szoom);
				updateAnn();
				if (!select_twice){
				$(document).ready(function (){
					//zoomToLabels();
					chart.update();
				});
				}
				console.log('Block popup close: '+block_cl_pop);
				
				//select_change_first_clicked = false;
			});
		for (var i = 0; i < variables.length; i++) {
			//ranges[variables[i]] = { min: Infinity, max: -Infinity };
			// Simultaneously, build the UI for selecting different
			// ranges
			$('<option></option>')
				.text(variables[i])
				.attr('value', variables[i])
				.appendTo($select);
		}
		var filteredPlotDataArray =[];
		//map.createPane('subsel');
		var $subselect = $('<select></select>')
			.appendTo($('#subfilter'))
			.prop('disabled', true)
			.on('change', function() {
				filteredPlotDataArray.length = 0;
				console.log('"'+$(this).val()+'"');
				//////alert("Subselect: " + subselect_change_first_clicked);
				resetBorders();
				  switch(year){
						case 0:
							break;
						case 10:
							map.removeLayer(layer_current);
							layer_current = layer_10;
							layer_10.addTo(map);
							customControlLayers();
							//chart.update();
							/*layer_10.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po10, p.pis10);
									pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
							});
								
							chart.data.datasets[0].pointBackgroundColor=pointBackgroundColors;*/
							break;
						case 15:
							map.removeLayer(layer_current);
							layer_current = layer_15;
							layer_15.addTo(map);
							customControlLayers();
							//chart.update();
							/*layer_15.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po15, p.pis15);
									pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
							});
								
							chart.data.datasets[0].pointBackgroundColor=pointBackgroundColors;*/
							break;
						case 20:
							map.removeLayer(layer_current);
							layer_current = layer_20;
							layer_20.addTo(map);
							customControlLayers();
							//chart.update();
							/*layer_20.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po20, p.pis20);
									pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
							});
								
							chart.data.datasets[0].pointBackgroundColor=pointBackgroundColors;*/
							break;
						default:
							break;
							/*layer_current = layer_10;
							layer_10.addTo(map);
							chart.update();*/
				}
				
				chart.data.datasets[0].data = checkPoint();
				temp_zoomed = auto_zoom;
				
				if (!block_cl_pop/*&&popup_open_first_clicked*/){
					block_centering = true;
					map.closePopup();
					block_centering = false;
					//popup_open_first_clicked = false;
					//popup_close_first_clicked = true;
				}
				already_selected = true;
				if ($(this).val()=='none'/* ||$(this).is(':empty')*/){
					//chart.data.datasets[1].data = scatterPlotDataArray;
					chart.data.datasets[1].data = filterChart();
					/*chart.options.scales.xAxes[0].ticks = {};
					chart.options.scales.yAxes[0].ticks = {};
					chart.options.scales.xAxes[0].ticks = {beginAtZero: false};
					chart.options.scales.yAxes[0].ticks = {beginAtZero: false};*/
					//console.log('Znak biały: '+chart.data.datasets[1].data);
					var woj= $select.val().substring(0,2);
					selected = true;
					if (!polygon_clicked&&!item_clicked&&!adm_clicked){
						sel_clicked = true;
					}else{
						sel_clicked = false;
					}
					if (current_KOD.substring(0,2)!=woj){
						chart.data.datasets[0].data = [];
						chart.data.datasets[0].data.push(0);
					}
					//map.spin(true);
					//setTimeout(function () {
					//console.log(subb);
					//if (subb==0
						//!!TEMP
					
					if (!popup_open_first_clicked&&!popup_close_first_clicked){
						console.log("sub woj gr1");
						//$(document).ready(function ()
						if (item_clicked){
							//stały zoom
							auto_zoom = false;
						}else if (adm_clicked||sel_clicked){
							auto_zoom = true;
							/*if (!temp_zoomed){
								//stały zoom
								manually_zoomed = false;
							}else{
								//dopasowanie poligonu do okna
								manually_zoomed = true;
							//}*/
						}else{
							auto_zoom = temp_zoomed;
							//auto_zoom = false;
						}
						if (manual_zoom){
							//if (woj != current_KOD.substring(0,2)){
							map.fitBounds(wojewods[woj].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.4});
							//}
						}else{
							var cbounds = layers[current_KOD].getBounds();
							map.setMaxZoom(map.getZoom());
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							map.setMaxZoom(10);
						}
						
						//});
							/*map.getPane('labels').style.display = 'inline-block';
							map.getPane('labels').style['text-align'] = 'center';*/
					}
					//manually_zoomed = true;
					$('.leaflet-control-layers-list:eq( 1 ) h5 span').html($select.val().substring(3));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS10"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS15"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PiS20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PO10"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PO15"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["PO20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS10"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS15"],json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', woj)[0].properties["ABS20"],false));
						//map.spin(false);
					//}, 3000);
					wojewods[woj].setStyle({color: 'rgba(255,255,255,1.0)'/*, fillColor: 'rgba(255,224,224,0.25)'*/, fillPattern: stripes, weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*3.36});
					wojewods2[woj].setStyle({color: 'rgba(224,0,0,1.0)', weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.24});
					wojewods2[woj].bringToFront();
					filtered = false;
					sel_clicked = false;
					console.log('subselect changed ' + filtered);
				}else{
					var pow_= $(this).val().substring(0,4);
					//console.log(woj);
					selected = true;
					//map.spin(true);
					if (!polygon_clicked&&!item_clicked&&!adm_clicked){
						subsel_clicked = true;
					}else{
						subsel_clicked = false;
					}
					//setTimeout(function () {
					if (!popup_open_first_clicked&&!popup_close_first_clicked){
						console.log("Nazwa powiatu---");
						//$(document).ready(function (){
						//auto_zoom = true;
						if (item_clicked){
							//stały zoom
							auto_zoom = false;
						}else if (adm_clicked||subsel_clicked){
							auto_zoom = true;
							/*if (!temp_zoomed){
								//stały zoom
								manually_zoomed = false;
							}else{
								//dopasowanie poligonu do okna
								manually_zoomed = true;
							//}*/
						}else{
							auto_zoom = temp_zoomed;
							//auto_zoom = false;
						}
						if (manual_zoom){
							map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.4});
							console.log("manual_zoom");
						}else{
							var cbounds = layers[current_KOD].getBounds();
							map.setMaxZoom(map.getZoom());
							map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							map.setMaxZoom(10);
							//console.log("manually_zoomed: "+manually_zoomed);
							/*if (manually_zoomed){
								map.setMaxZoom(10);
							}else{
								map.setMaxZoom(map.getZoom());
							}*/
							//console.log("!manual_zoom");
						}
						//auto_zoom = false;
						//});
							/*map.getPane('labels').style.display = 'inline-block';
							map.getPane('labels').style['text-align'] = 'center';*/
					}
					
					
					////alert("Subselect changed - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\npopup_close_first_clicked: " + "\npopup_open_first_clicked: " + popup_open_first_clicked);
					subsel_clicked = false;
					$('.leaflet-control-layers-list:eq( 1 ) h5 span').html($(this).val().substring(5));
					//$('.leaflet-control-layers-list:eq( 1 ) tbody').html('');
					$('.leaflet-control-layers-list:eq( 1 ) tbody').empty();
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PiS:',json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PiS'10"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PiS'15"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PiS'20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Kandydat popierany przez PO:',json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PO'10"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PO'15"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_PO'20"],false));
					$('.leaflet-control-layers-list:eq( 1 ) tbody').append(renderRow('Absencja i głosy nieważne:',json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_ABS'10"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_ABS'15"],json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', pow_)[0].properties["Prez_pow_ABS'20"],false));
						//map.spin(false);
					//}, 3000);
					for (i=0; i<scatterPlotDataArray.length; i++){
						var el = scatterPlotDataArray[i];
						//el.x = 100-(el.x+el.y);
						if (el.featureId.substring(0,4)==pow_){
							filteredPlotDataArray.push(el);
						}else{
							filteredPlotDataArray.push(0);
						}
					}
					if (current_KOD.substring(0,4)!=pow_){
						chart.data.datasets[0].data = [];
						chart.data.datasets[0].data.push(0);
					}
					chart.data.datasets[1].data = filteredPlotDataArray;
					//chart.data.datasets[0].data = [];
					chart.data.datasets[2].data = [];
					czoom = map.getZoom();
					pow_ats2[pow_].setStyle({color: 'rgba(240,32,32,1.0)', weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*1.68/*, fillPattern: stripes*/});
					pow_ats[pow_].setStyle({color: 'rgba(224,224,224,0.5)', weight: Math.pow((1.4+(Math.pow((10-czoom),2)-5)/49),(czoom-6))*2.52, fillPattern: stripes});
					
					pow_ats2[pow_].bringToFront();
					//map.getPane('subsel').style.zIndex = 420;
					//pow_ats[pow_].setStyle({pane: 'pane_Powiaty_Simplified_2'});
					filtered = true;
					console.log('subselect changed ' + filtered);
					//filteredPlotDataArray =[];
				}
				//already_selected = false;
				
				//szoom = map.getZoom();
				//console.log("czoom: "+czoom+" szoom: "+szoom);
				chosenCol('Podsumowanie_tot');
				/*for (i=0; i<filteredPlotDataArray.length; i++) {
					var fl = filteredPlotDataArray[i];
					fl.x = 100-(fl.x+fl.y);
				}*/
				//zoomToLabels();
				fitChart();
				sred = 'Śr. (kraj): ';
				updateAnn();
				chart.update();
			});
		
		var subch = function(){
			if ($select.val()!='Polska'){
				$subselect.prop('disabled', false).empty();
				filteredListPowArray = filterListPow();
				//console.log('Powiaty: '+filteredListPowArray);
				filtered = true;
				console.log('subch changed ' + filtered);
				for (var i = 0; i < filteredListPowArray.length+1; i++) {
					//ranges[variables[i]] = { min: Infinity, max: -Infinity };
					// Simultaneously, build the UI for selecting different
					// ranges
					if (i==0){
						$('<option></option>')
						.text(' ')
						.attr('value', 'none')
						.appendTo($subselect);
					}else{
						$('<option></option>')
						.text(filteredListPowArray[i-1])
						.attr('value', filteredListPowArray[i-1])
						.appendTo($subselect);
					}
				}
			}else{
				$subselect.prop('disabled', true);
				$subselect.empty();
				filtered = false;
				console.log('subch changed ' + filtered);
			}
		};
		function updateChanger(xx,yy,zz){
			var tsel = $changer.prop('selectedIndex');
			$changer.empty();
			_axis = [
				'x: '+xx+ ', y: '+yy,
				'x: '+xx+ ', y: '+zz,
				'x: '+yy+ ', y: '+xx,
				'x: '+yy+ ', y: '+zz,
				'x: '+zz+ ', y: '+xx,
				'x: '+zz+ ', y: '+yy,];
			for (var i = 0; i < _axis.length; i++) {
				$('<option></option>')
					.text(_axis[i])
					.attr('value', _axis[i])
					.appendTo($changer);
			}
			$('#changer option')[tsel].selected = true;
			//$('#selectBox option').eq(tsel).prop('selected', true);
		}
		function changerToChart(sel){
			switch(sel.prop('selectedIndex')){
						case 0:
							scatterPlotDataArray = scatterPlotDataArray_xy;
							scatterPlotDataArray10 = scatterPlotDataArray10_xy;
							scatterPlotDataArray15 = scatterPlotDataArray15_xy;
							scatterPlotDataArray20 = scatterPlotDataArray20_xy;
							chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
							chart.options.scales. yAxes[0].scaleLabel.labelString=ya;
							break;
						case 1:
							scatterPlotDataArray = scatterPlotDataArray_xz;
							scatterPlotDataArray10 = scatterPlotDataArray10_xz;
							scatterPlotDataArray15 = scatterPlotDataArray15_xz;
							scatterPlotDataArray20 = scatterPlotDataArray20_xz;
							chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
							chart.options.scales. yAxes[0].scaleLabel.labelString=za;
							break;
						case 2:
							scatterPlotDataArray = scatterPlotDataArray_yx;
							scatterPlotDataArray10 = scatterPlotDataArray10_yx;
							scatterPlotDataArray15 = scatterPlotDataArray15_yx;
							scatterPlotDataArray20 = scatterPlotDataArray20_yx;
							chart.options.scales. xAxes[0].scaleLabel.labelString=ya;
							chart.options.scales. yAxes[0].scaleLabel.labelString=xa;	
							break;
						case 3:
							scatterPlotDataArray = scatterPlotDataArray_yz;
							scatterPlotDataArray10 = scatterPlotDataArray10_yz;
							scatterPlotDataArray15 = scatterPlotDataArray15_yz;
							scatterPlotDataArray20 = scatterPlotDataArray20_yz;
							chart.options.scales. xAxes[0].scaleLabel.labelString=ya;
							chart.options.scales. yAxes[0].scaleLabel.labelString=za;
							break;
						case 4:
							scatterPlotDataArray = scatterPlotDataArray_zx;
							scatterPlotDataArray10 = scatterPlotDataArray10_zx;
							scatterPlotDataArray15 = scatterPlotDataArray15_zx;
							scatterPlotDataArray20 = scatterPlotDataArray20_zx;
							chart.options.scales. xAxes[0].scaleLabel.labelString=za;
							chart.options.scales. yAxes[0].scaleLabel.labelString=xa;
							break;
						case 5:
							scatterPlotDataArray = scatterPlotDataArray_zy;
							scatterPlotDataArray10 = scatterPlotDataArray10_zy;
							scatterPlotDataArray15 = scatterPlotDataArray15_zy;
							scatterPlotDataArray20 = scatterPlotDataArray20_zy;
							chart.options.scales. xAxes[0].scaleLabel.labelString=za;
							chart.options.scales. yAxes[0].scaleLabel.labelString=ya;	
							break;
						default:
							scatterPlotDataArray = scatterPlotDataArray_xy;
							scatterPlotDataArray10 = scatterPlotDataArray10_xy;
							scatterPlotDataArray15 = scatterPlotDataArray15_xy;
							scatterPlotDataArray20 = scatterPlotDataArray20_xy;
							chart.options.scales. xAxes[0].scaleLabel.labelString=xa;
							chart.options.scales. yAxes[0].scaleLabel.labelString=ya;
					}
		}
		
		function colorizeText(value){
			if (value==0){
				return '>';
			}else if  (value>0){
				return ' style="color: #c0ffc0">+'
			}else{
				return ' style="color: #ffc0c0">'
			}
		}
		
		function setTooltipText(opt1, opt2, opt3, meas,tooltipItems){
			var multistringText =  [];
			if (tooltipItems.datasetIndex!=2){
			  if ($subselect.val()=='none'||$subselect.is(':empty')){
				  
				  multistringText.push('<tr><td colspan="2" style="text-align: center;">Położenie:</td></tr>');
				  if ($select.val()=='Polska'){
					multistringText.push('<tr><td colspan="2"  style="text-align: left;"> województwo '+ json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', scatterPlotDataArray_xy[tooltipItems.index].featureId.substring(0, 2))[0].properties.JPT_NAZWA_+'</td></tr>');
				  }
				  multistringText.push('<tr><td colspan="2"  style="text-align: left;">'+ json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', scatterPlotDataArray_xy[tooltipItems.index].featureId.substring(0, 4))[0].properties.JPT_NAZWA_+'</td></tr>');
			  }
			  
			   var d = scatterPlotDataArray_xy[tooltipItems.index];
			    if  (meas=='&nbsp;p.p.'){
					multistringText.push('<tr><td colspan="2" style="text-align: center;">Zmiana wyników:</td></tr>');
					multistringText.push('<tr><td>'+opt1+':</td><td'+colorizeText(d.y)+d.y.toFixed(2)+meas+'</td></tr>');
					multistringText.push('<tr><td>'+opt2+':</td><td'+colorizeText(d.x)+d.x.toFixed(2)+meas+'</td></tr>');
					multistringText.push('<tr><td>'+opt3+':</td><td'+colorizeText(0-(d.y+d.x))+(0-(d.y+d.x)).toFixed(2)+meas+'</td></tr>');
				}else{
					var ytext=(d.y>d.x)?'<b style="color: yellow">'+opt1+':</b></td><td><b style="color: yellow">'+d.y.toFixed(2)+meas+'</b>':opt1+'</td><td>'+d.y.toFixed(2)+meas;
					var xtext=(d.x>d.y)?'<b style="color: yellow">'+opt2+':</b></td><td><b style="color: yellow">'+d.x.toFixed(2)+meas+'</b>':opt2+'</td><td>'+d.x.toFixed(2)+meas;
					multistringText.push('<tr><td colspan="2" style="text-align: center;">Wyniki:</td></tr>');
					multistringText.push('<tr><td>'+ytext+'</td></tr>');
					multistringText.push('<tr><td>'+xtext+'</td></tr>');
					multistringText.push('<tr><td><i style="color: #dddddd">'+opt3+':</i></td><td><i style="color: #dddddd">'+(100-(d.y+d.x)).toFixed(2)+meas+'</i></td></tr>');
				}
			}
			return multistringText.join('');
		}
		console.log('Inicjacja subch');
		$select.change(subch);
		var $changer = $('<select name="changer1" onmousedown="if(this.options.length>4){this.size=4;}"  onchange="this.size=0;" onblur="this.size=0;"></select>')
			.appendTo($('#changer'))
			.on('change', function() {
				changerToChart($(this));
				console.log(filtered);
				layer_code = layer_current._leaflet_id;
				chart.data.datasets[0].data = checkPoint();
				if ($select.val()=='Polska'){
					console.log(layer_code+" - "+l1+" - "+l2+" - "+l3+" - "+year);
					chart.data.datasets[1].data = scatterPlotDataArray;
					if (layer_code==l1||layer_code==l2||layer_code==l3||year!=0){
						setChart();
						console.log("Chart setted");
					}else{
						console.log("Chart fitted");
						fitChart();
					}
				}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
					chart.data.datasets[1].data = filterChart();
					//console.log(chart.options.tooltips);
					if ($select.val().substring(0,2)!=current_KOD.substring(0,2)){
						chart.data.datasets[0].data = [];
					}
					//chart.data.datasets[2].data = scatterPlotDataArray;
					fitChart();
				}else {
					chart.data.datasets[1].data = subfilterChart();
					//console.log(chart.options.tooltips);
					if ($subselect.val().substring(0,4)!=current_KOD.substring(0,4)){
						chart.data.datasets[0].data = [];
					}
					//chart.data.datasets[2].data = scatterPlotDataArray;
					fitChart();
				}
				if (year!=0){
					chart.data.datasets[2].data = scatterPlotDataArray;
					setChart();
				}else{
					chart.data.datasets[2].data = [];
					if ($select.val()!='Polska') fitChart();
				}
				updateAnn();
				chart.update();
			});
		for (var i = 0; i < _axis.length; i++) {
			//ranges[variables[i]] = { min: Infinity, max: -Infinity };
			// Simultaneously, build the UI for selecting different
			// ranges
			$('<option></option>')
				.text(_axis[i])
				.attr('value', _axis[i])
				.appendTo($changer);
		}
		//!!TEMP
		//setBounds();
		
		
		map.createPane('labels');
		map.getPane('labels').style.zIndex = 650;
		map.getPane('labels').style.pointerEvents = 'none';
		map.getPane('labels').style.display = 'none';
		
		//var searchLayer = L.layerGroup().addTo(map);
		var searchControl = new L.Control.Search({
			layer: layer_current,
			propertyName: 'index',
			marker: false,
			textPlaceholder: 'Wpisz nazwę gminy...',
			/*filterData: (text, records) => records,*/
			buildTip: function(text, val) {
					  var p = val.layer.feature.properties;
					  var tip = p.JPT_NAZWA_;
					  var vip = p.JPT_KOD_JE;
					  return '<a href="#" class=""><div style="float:left; width: 176px;"><span style=" font-size: 12px;">'+ tip +'</span>, <span style=" font-size: 11px;"><i>' +(vip.substring(6,7)!=="1"?'gmina':'miasto')+ '</i></span></div><div style="float:left; font-size: 9px; padding-left: 4px;">' + json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', val.layer.feature.properties['Powiat'])[0].properties.JPT_NAZWA_+'<br>województwo ' +  json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', val.layer.feature.properties['Wojewod'])[0].properties.JPT_NAZWA_ + '</div><div style="clear:both;"></div></a>';
			},
			moveToLocation: function(latlng, title, map) {
				console.log("search");
				map.fitBounds( latlng.layer.getBounds() , {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.4});
				var zoom = map.getBoundsZoom(latlng.layer.getBounds());
				map.setView(latlng, zoom); // access the zoom
			}
		});
		searchControl.on('search:locationfound', function(e) {
		
			console.log(e);
			var kod = e.layer.feature.properties.JPT_KOD_JE;
			current_KOD = kod;
			woj_zoom = false;
			map.closePopup();
			var pind = kod.substring(2,4)/1+1;
			console.log(pind);
			
			console.log($select);
			console.log($select.val());
			//if ($select.val()=='Polska'){
				//console.log("Tak - Polska!");
			var wind = kod.substring(0,2)/2+1;
			select_twice = true;
			if (wind!=cind){
				$('#filter :nth-child('+wind+')').prop('selected', true).change();
				console.log('Search found subch');
				$select.change(subch);
			}
			//$select.change(subch);
			//subb = 1;
			$("#subfilter option").filter(function() {
				  //may want to use $.trim in here
					return $(this).text().substring(0,4) == current_KOD.substring(0,4);
				}).prop('selected', true).change();
			select_twice = false;
			//subb = 0;
			console.log($('#subfilter :nth-child('+pind+')'));
			cind=wind;
			polind =0;
			filtered = true;
			console.log('search ' + filtered);
			//map.removeLayer(this._markerSearch)
			e.layer.setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
			e.layer.bringToFront();
			resetLabels([layer_Powiaty_Simplified_1]);
			//map.getPane('labels').style.display = 'inline-block';
			if(e.layer._popup)
				e.layer.openPopup();
			//https://bdot10k.geoportal.gov.pl/#showLayersList&1618582473368
		}).on('search:collapsed', function(e) {

			layer_current.eachLayer(function(layer) {	//restore feature color
				//To fix display of borders
				layer_current.resetStyle(layer);
			});	
		});
		map.addControl( searchControl );
		
		var i = 0;

        layer_Powiaty_Simplified_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
			
			//var p = layer.getBounds().getCenter();
			
			layer.bindTooltip((label_Powiaty_Simplified_1_eval_expression(context) !== null?String('<div style="color: #fff; font-size: 8pt; font-weight: bold; box-shadow: 0 0 15px rgba(0,0,0,0.25); text-align: center; text-shadow: rgba(80,80,80,0.75) 2px 0px 0px, rgba(80,80,80,0.75) 1.75px 0.966667px 0px, rgba(80,80,80,0.75) 1.08333px 1.68333px 0px, rgba(80,80,80,0.75) 0.133333px 2px 0px, rgba(80,80,80,0.75) -0.833333px 1.81667px 0px, rgba(80,80,80,0.75) -1.6px 1.2px 0px, rgba(80,80,80,0.75) -1.98333px 0.283333px 0px, rgba(80,80,80,0.75) -1.86667px -0.7px 0px, rgba(80,80,80,0.75) -1.3px -1.51667px 0px, rgba(80,80,80,0.75) -0.416667px -1.95px 0px, rgba(80,80,80,0.75) 0.566667px -1.91667px 0px, rgba(80,80,80,0.75) 1.41667px -1.41667px 0px, rgba(80,80,80,0.75) 1.91667px -0.566667px 0px; font-family: \'MS Shell Dlg 2\', sans-serif">' + label_Powiaty_Simplified_1_eval_expression(context)) + '</div>':''), {pane: 'labels', permanent: true, offset: [0, 0], className: 'css_Powiaty_Simplified_1', direction:"center", opacity:1.0}).openTooltip(lab_centers[i]);
            labels.push(layer);
            totalMarkers += 1;
            layer.added = true;
            addLabel(layer, i);
            i++;
        });
		
		L.Control.Watermark = L.Control.extend({
			onAdd: function(map) {
				var img = L.DomUtil.create('img');

				img.src = './images/2010.png';
				img.style.width = '200px';
				img.style.opacity= '0.9';
				//margin-bottom: -60px;
				img.style.margin= '0px 0px 0px 0px';

				return img;
			},

			onRemove: function(map) {
				// Nothing to do here
			}
		});

		L.control.watermark = function(opts) {
			return new L.Control.Watermark(opts);
		}

		L.control.watermark({ position: 'bottomleft' }).addTo(map);
		$('.leaflet-bottom:eq(0)').css('filter', 'drop-shadow(1px 1px 0 white) drop-shadow(-1px -1px 0 white) drop-shadow(5px 5px 10px #ccc)');
		
		$('.leaflet-control-layers-base label:eq( 0 ) div input').prop("checked", true);
		
		function customControlLayers(){
			console.log($('.leaflet-control-layers-base label div input').slice(3,6));
			$( ".leaflet-control-layers-base:eq(0) p" ).remove( ":contains('dla kandydatów')" );
			$('.leaflet-control-layers-base label div input').slice(3,6).addClass('leaflet-control-layers-middle-input');
			//$('.leaflet-control-layers-base label:eq( 0 ) div input').prop("checked", true);
			$('.leaflet-control-layers-middle-input').next().css("background-image","linear-gradient(to right, #e6f5b0 0%, #f7f7d7 51%, #e6f5b0 100%)");
			$('.leaflet-control-layers-base:eq(0) label:eq(0)').before('<p class= "category">Poparcie dla kandydatów<br>(wartość średnia jako punkt odniesienia):</p>');
			$('<p class= "category">Zmiana poparcia dla kandydatów<br>(wartość średnia jako punkt odniesienia):</p>').insertAfter('.leaflet-control-layers label:eq(2)');
			$('<p class= "category">Zmiana poparcia dla kandydatów<br>(zero jako punkt odniesienia):</p>').insertAfter('.leaflet-control-layers label:eq(5)');
			//$('.leaflet-control-layers-selector:eq(0)+span').html('Na na na')
			$('<div style="margin-bottom: 12px;"></div>').insertAfter('.leaflet-control-layers label:eq(8)');
			$('.leaflet-control-layers-list:eq( 0 )').append('<div style="margin:  32px 0px 0px 0px;"></div>');
		}
		
		$('.leaflet-control-layers-list:eq( 1 )').append('<div style="margin:  32px 0px 0px 0px;"></div>');
		$('.leaflet-control-layers-base:eq(0)').before('<div style="margin:  8px 0px 0px 0px; font-family: \'Roboto\', sans-serif ;"><div style = "text-align:center; font-size: 16px; margin-bottom: 16px; font-weight: 900; font-color: #000; line-height: 1.25; text-stroke: 4px white;">Wyniki II tury Wyborów Prezydenta RP<br>jako odsetek osób uprawnionych<br>do&nbsp;głosowania:</div></div>');
		customControlLayers();
		var margl = '<div style="margin-left:20px;">';
		var thead = [];
		thead[0]='<tr style=""><th colspan="4" style="font-size: 12px;"><div><b>Jarosław Kaczyński:</b></div></th></tr>';
		thead[1]='<tr><th colspan="4" style="font-size: 12px;"><div  style="display: flex; justify-content: center; align-items: center;"><b>Bronisław Komorowski:</b></div></th></tr>';
		thead[2]='<tr><th colspan="4" style="font-size: 12px;"><div><b>Absencja i głosy nieważne:</b></div></th></tr>';
		thead[3]='<tr style=""><th colspan="4" style="font-size: 12px;"><div><b>Andrzej Duda:</b></div></th></tr>';
		thead[4]='<tr><th colspan="4" style="font-size: 12px;"><div  style="display: flex; justify-content: center; align-items: center;"><b>Bronisław Komorowski:</b></div></th></tr>';
		thead[5]='<tr><th colspan="4" style="font-size: 12px;"><div><b>Absencja i głosy nieważne:</b></div></th></tr>';
		thead[6]='<tr style=""><th colspan="4" style="font-size: 12px;"><div><b>Andrzej Duda:</b></div></th></tr>';
		thead[7]='<tr><th colspan="4" style="font-size: 12px;"><div  style="display: flex; justify-content: center; align-items: center;"><b>Rafał Trzaskowski:</b></div></th></tr>';
		thead[8]='<tr><th colspan="4" style="font-size: 12px;"><div><b>Absencja i głosy nieważne:</b></div></th></tr>';
		var row_empty = '<tr><td colspan="4" style="font-size: 32px; background-color: #e4e4e4;"><div  style="display: flex; justify-content: center; align-items: center;"><b>...</b></div></td></tr>';
		
		function candidateName(cIndex){
			switch(cIndex){
				case  0:
					return 'Kaczyński:';
					break;
				case  1:
					return 'Komorowski:';
					break;
				case  3:
					return 'Duda:';
					break;
				case  4:
					return 'Komorowski:';
					break;
				case  6:
					return 'Duda:';
					break;
				case  7:
					return 'Trzaskowski:';
					break;
				default:
					return 'NN:';
			}
		}
		
		function selectCol(col_nr, idt){
			$('#'+idt+' tr th:nth-child( '+(col_nr+1)+' )').css("border-top","4px solid #7fbc41");
			$('#'+idt+' tr:nth-child(n) td:nth-child('+(col_nr+1)+')').each(function() {
				//console.log("Highlighted: "+this);
				//console.log(this);
				$(this).css("border-left","4px solid #7fbc41");
				$(this).css("border-right","4px solid #7fbc41");
			});
			$('#'+idt+' tr th:nth-child( '+(col_nr+1)+' )').css("border-left","4px solid #7fbc41");
			$('#'+idt+' tr th:nth-child( '+(col_nr+1)+' )').css("border-right","4px solid #7fbc41");
			/*$('.tabela tr:eq( 1 ) td:eq( 1 )').css("border-left","4px solid #7fbc41");
			$('.tabela tr:eq( 1 ) td:eq( 1 )').css("border-right","4px solid #7fbc41");
			$('.tabela tr:eq( 2 ) td:eq( 1 )').css("border-left","4px solid #7fbc41");
			$('.tabela tr:eq( 2 ) td:eq( 1 )').css("border-right","4px solid #7fbc41");
			$('.tabela tr:eq( 3 ) td:eq( 1 )').css("border-left","4px solid #7fbc41");
			$('.tabela tr:eq( 3 ) td:eq( 1 )').css("border-right","4px solid #7fbc41");
			$('.tabela tr:eq( 4 ) td:eq( 1 )').css("border-left","4px solid #7fbc41");
			$('.tabela tr:eq( 4 ) td:eq( 1 )').css("border-right","4px solid #7fbc41");*/
			$('#'+idt+' tr:last-of-type td:nth-child( '+(col_nr+1)+' )').css("border-bottom","4px solid #7fbc41");
		}
		function chosenCol(id_t){
			switch(layer_code){
				case l1:
					selectCol(1,id_t);
					break;
				case l2:
					selectCol(2,id_t);
					break;
				case l3:
					selectCol(3,id_t);
					break;
				case l4:
					selectCol(4,id_t);
					break;
				case l5:
					selectCol(5,id_t);
					break;
				case l6:
					selectCol(6,id_t);
					break;
				case l7:
					selectCol(4,id_t);
					break;
				case l8:
					selectCol(5,id_t);
					break;
				case l9:
					selectCol(6,id_t);
					break;
				default:
					selectCol(1,id_t);
			}
		}
		map.on('popupclose', function(e) {
			console.log('%cPOPUP CLOSED!!!', 'color: red');
			//////alert('%cPOPUP CLOSED!!!', 'color: red');
			popup_open_first_clicked = false;
			
			//temp_zoomed = manually_zoomed;
			//if (!already_selected){
				manually_zoomed = auto_zoom;
			//}
			console.log('Select: ' + $select.val());
			if (!link_clicked){
				year = 0;
				layers = [];
				scatterPlotDataArray_xy = [];
				scatterPlotDataArray_xz= [];
				scatterPlotDataArray_yx = [];
				scatterPlotDataArray_yz = [];
				scatterPlotDataArray_zx = [];
				scatterPlotDataArray_zy = [];
				pointBackgroundColors=[];
				pointFBackgroundColors=[];
				pointBBackgroundColors=[];
				//chart.data.datasets[0].data = [];
				chart.data.datasets[2].data = [];
				//scatterPlotDataArray = scatterPlotDataArrayTemp;
				switch(layer_code){
					case l1:
						xa = 'Komorowski';
						ya = 'Kaczyński';
						za = 'Absencja i nieważne';
						xb = xa;
						yb = ya;
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
							rotateData(p, p.po10, p.pis10);
							pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
							pointFBackgroundColors.push(p.rgb10);
						});
						//chart.data.datasets[0].pointBackgroundColor=pointFBackgroundColors;
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
				//console.log(chart.data.datasets[0].pointBackgroundColor);
						console.log(scatterPlotDataArray);
						//setChart();
						changerToChart($changer);
						chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('Kaczyński', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
						}
						jedn = '%';
						switchAnn(1);
						break;
					case l2:
						xa = 'Komorowski';
						ya = 'Duda';
						za = 'Absencja i nieważne';
						xb = xa;
						yb = ya;
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
							rotateData(p, p.po15, p.pis15);
							pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
							pointFBackgroundColors.push(p.rgb15);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						console.log(scatterPlotDataArray);
						///setChart();
						changerToChart($changer);
						chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2015 r.', 'jako odsetek osób uprawnionych do głosowania:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('Duda', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
						}
						jedn = '%';
						switchAnn(1);
						break;
					case l3:
						xa = 'Trzaskowski';
						ya = 'Duda';
						za = 'Absencja i nieważne';
						xb = xa;
						yb = ya;
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
							rotateData(p, p.po20, p.pis20);
							pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
							pointFBackgroundColors.push(p.rgb20);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						console.log(scatterPlotDataArray);
						//setChart();
						changerToChart($changer);
						chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2020 r.', 'jako odsetek osób uprawnionych do głosowania:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('Duda', 'Trzaskowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
						}
						jedn = '%';
						switchAnn(1);
						break;
					case l4:
						xa = 'Komorowski\'15 - Komorowski\'10';
						ya = 'Duda\'15 - Kaczyński\'10';
						za = 'ABS\'15 - ABS\'10';
						xb = 'KOM\'15 - KOM\'10';
						yb = 'DUD\'15 - KAC\'10';
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							var rpo = p.po15 - p.po10;
							var rpis = p.pis15 - p.pis10;
							rotateDataPP(p, rpo, rpis);
							pointBackgroundColors.push(colorconvert(p.rgb1510,0.8));
							pointFBackgroundColors.push(p.rgb1510);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						//setChart(false, -25, 25, 10);
						//fitChart();
						/*chart.options.scales.xAxes[0].ticks = {
						  beginAtZero: false,
						  max: 25,
						  min: -25,
						  stepSize: 10
						};
						chart.options.scales.yAxes[0].ticks = {
						  beginAtZero: false,
						  max: 25,
						  min: -25,
						  stepSize: 10
						};*/
						changerToChart($changer);
						chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2015:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('DUD\'15-KAC\'10', 'KOM\'15-KOM\'10', 'ABS\'15-ABS\'10', '&nbsp;p.p.',tooltipItems);
						}
						jedn = ' p.p.';
						switchAnn(1);
						break;
					case l5:
						xa = 'Trzaskowski\'20 - Komorowski\'15';
						ya = 'Duda\'20 - Duda\'15';
						za = 'ABS\'20 - ABS\'15';
						xb = 'TRZ\'20 - KOM\'15';
						yb = 'DUD\'20 - DUD\'15';
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							var rpo = p.po20- p.po15;
							var rpis = p.pis20 - p.pis15;
							rotateDataPP(p, rpo, rpis);
							pointBackgroundColors.push(colorconvert(p.rgb2015,0.8));
							pointFBackgroundColors.push(p.rgb2015);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						//setChart(false, -40, 40, 20
						//fitChart();
						/*chart.options.scales.xAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};
						chart.options.scales.yAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};*/
						changerToChart($changer);
						chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2015 -> 2020:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('DUD\'20-DUD\'15', 'TRZ\'20-KOM\'15', 'ABS\'20-ABS\'15', '&nbsp;p.p.',tooltipItems);
						}
						jedn = ' p.p.';
						switchAnn(1);
						break;
					case l6:
						xa = 'Trzaskowski\'20 - Komorowski\'10';
						ya = 'Duda\'20 - Kaczyński\'10';
						za = 'ABS\'20 - ABS\'10';
						xb = 'TRZ\'20 - KOM\'10';
						yb = 'DUD\'20 - KAC\'10';
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							var rpo = p.po20 - p.po10;
							var rpis = p.pis20 - p.pis10;
							rotateDataPP(p, rpo, rpis);
							pointBackgroundColors.push(colorconvert(p.rgb2010,0.8));
							pointFBackgroundColors.push(p.rgb2010);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						//setChart(false, -40, 40, 20);
						//fitChart();
						/*chart.options.scales.xAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};
						chart.options.scales.yAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};*/
						changerToChart($changer);
						chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2020:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('DUD\'20-KAC\'10', 'TRZ\'20-KOM\'10', 'ABS\'20-ABS\'10', '&nbsp;p.p.',tooltipItems);
						}
						jedn = ' p.p.';
						switchAnn(1);
						break;
					case l7:
						xa = 'Komorowski\'15 - Komorowski\'10';
						ya = 'Duda\'15 - Kaczyński\'10';
						za = 'ABS\'15 - ABS\'10';
						xb = 'KOM\'15 - KOM\'10';
						yb = 'DUD\'15 - KAC\'10';
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							var rpo = p.po15 - p.po10;
							var rpis = p.pis15 - p.pis10;
							rotateDataPP(p, rpo, rpis);
							pointBackgroundColors.push(colorconvert(p.rgb1510c,0.8));
							pointFBackgroundColors.push(p.rgb1510c);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						//setChart(false, -25, 25, 10);
						//fitChart();
						/*chart.options.scales.xAxes[0].ticks = {
						  beginAtZero: false,
						  max: 25,
						  min: -25,
						  stepSize: 10
						};
						chart.options.scales.yAxes[0].ticks = {
						  beginAtZero: false,
						  max: 25,
						  min: -25,
						  stepSize: 10
						};*/
						changerToChart($changer);
						chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2015:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('DUD\'15-KAC\'10', 'KOM\'15-KOM\'10', 'ABS\'15-ABS\'10', '&nbsp;p.p.',tooltipItems);
						}
						jedn = ' p.p.';
						switchAnn(0);
						break;
					case l8:
						xa = 'Trzaskowski\'20 - Komorowski\'15';
						ya = 'Duda\'20 - Duda\'15';
						za = 'ABS\'20 - ABS\'15';
						xb = 'TRZ\'20 - KOM\'15';
						yb = 'DUD\'20 - DUD\'15';
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							var rpo = p.po20- p.po15;
							var rpis = p.pis20 - p.pis15;
							rotateDataPP(p, rpo, rpis);
							pointBackgroundColors.push(colorconvert(p.rgb2015c,0.8));
							pointFBackgroundColors.push(p.rgb2015c);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						//setChart(false, -40, 40, 20);
						//fitChart();
						/*chart.options.scales.xAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};
						chart.options.scales.yAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};*/
						changerToChart($changer);
						chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2015 -> 2020:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('DUD\'20-DUD\'15', 'TRZ\'20-KOM\'15', 'ABS\'20-ABS\'15', '&nbsp;p.p.',tooltipItems);
						}
						jedn = ' p.p.';
						switchAnn(0);
						break;
					case l9:
						xa = 'Trzaskowski\'20 - Komorowski\'10';
						ya = 'Duda\'20 - Kaczyński\'10';
						za = 'ABS\'20 - ABS\'10';
						xb = 'TRZ\'20 - KOM\'10';
						yb = 'DUD\'20 - KAC\'10';
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							var rpo = p.po20 - p.po10;
							var rpis = p.pis20 - p.pis10;
							rotateDataPP(p, rpo, rpis);
							pointBackgroundColors.push(colorconvert(p.rgb2010c,0.8));
							pointFBackgroundColors.push(p.rgb2010c);
						});
						chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
						//setChart(false, -40, 40, 20);
						//fitChart();
						/*chart.options.scales.xAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};
						chart.options.scales.yAxes[0].ticks = {
						  beginAtZero: false,
						  max: 40,
						  min: -40,
						  stepSize: 20
						};*/
						changerToChart($changer);
						chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2020:'];
						chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
							return setTooltipText('DUD\'20-KAC\'10', 'TRZ\'20-KOM\'10', 'ABS\'20-ABS\'10', '&nbsp;p.p.',tooltipItems);
						}
						jedn = ' p.p.';
						switchAnn(0);
						break;
					default:
						xa = 'Komorowski';
						ya = 'Kaczyński';
						za = 'Absencja i nieważne';
						xb = xa;
						yb = ya;
						zb = za;
						updateChanger(xb,yb,zb);
						layer_current.eachLayer(function (evt, idx) {
							var p = evt.feature.properties;
							layers[p.JPT_KOD_JE] = evt;
							//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
							rotateData(p, p.po10, p.pis10);
							pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
							pointFBackgroundColors.push(p.rgb10);
						});
						
					}
					
					chart.data.datasets[0].pointBackgroundColor=pointFBackgroundColors;
					chart.data.datasets[0].data = checkPoint();
					//$select.change(subch);
					console.log('Select: ' + $select.val());
					console.log(map.getBounds());
					czoom = map.getZoom();
					popup_close_first_clicked = true;
					//temp_zoomed = manually_zoomed;
					if (/*!filtered&&currentAttrValue!='#tab1'*/$select.val()=='Polska'){
						chart.data.datasets[1].data = scatterPlotDataArray;
						/*function map_onResize(e){    
							map.setMinZoom(map.getZoom()-1)
							map.fitBounds(bounds, true);
							map.setMinZoom(map.getZoom());
						}*/
						//temp_zoomed = auto_zoom;
						//$(document).ready(function (){
						//auto_zoom = true;
						if (czoom==szoom){
							if(!block_centering){
								map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							}
						}else{
							//current_KOD
							if(!block_centering){
								var cbounds = layers[current_KOD].getBounds();
								map.setMaxZoom(map.getZoom());
								map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
								map.setMaxZoom(10);
							}
						}
						//});
						//sc = $("#tab2").scrollTop();
						//$("#tab2").scrollTop($("#tab2").scrollHeight);
						//sc = $("#tab2").scrollTop(400);
						//sc = $("#tab2").scrollTop() + $("#tab2")[0].scrollHeight - $("#tab2").height() - 16;
						//sc = $("#tab2")[0].scrollHeight - $("#tab2").height() - 16;
						sc = sc_temp;
						if(layer_code==l1||layer_code==l2||layer_code==l3){
							setChart();
						}else{
							fitChart();
						}
						/*if (czoom<8){
							map.getPane('labels').style.display = 'none';
						}*/
						//console.log("scrollTop: "+ $("#tab2").scrollTop() +" scrollHeight: "+ $("#tab2")[0].scrollHeight +" sc: "+sc);
						//console.log( "#tab2 scrollHeight: "+ $("#tab2")[0].scrollHeight +" height: "+ $("#tab2").height()  +" sc: "+ sc);
						//$('.tooltips').css("bottom",(sc+24)+"px");
					}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
						//sc = $("#tab2").height();
						//sc = /*$("#tab2").scrollTop() +*/ $("#tab2")[0].scrollHeight - 2*$("#tab2").height() - 40;
						//$('.tooltips').css("bottom",(sc+24)+"px");
						chart.data.datasets[1].data = filterChart();
						/*if (czoom<8){
							map.getPane('labels').style.display = 'none';
						}*/
						var woj = $select.val().substring(0,2);
						if (woj != current_KOD.substring(0,2)){
							chart.data.datasets[0].data = [];
						}
						//$(document).ready(function (){
						//czoom = map.getZoom();
						//temp_zoomed = manually_zoomed;
						//$(document).ready(function (){
						//auto_zoom = true;
						//alert("Popup close - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
						if (czoom==szoom){
							if(!block_centering){
								map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							}
						}else if (manually_zoomed){
							if(!block_centering){
								map.fitBounds(wojewods[woj].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							}
						}else{
							if(!block_centering){
								var cbounds = layers[current_KOD]/*wojewods[woj]*/.getBounds();
								map.setMaxZoom(map.getZoom());
								map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
								map.setMaxZoom(10);
							}
						}
						//});
						/*map.getPane('labels').style.display = 'inline-block';
						map.getPane('labels').style['text-align'] = 'center';*/
						woj_zoom = true;
						console.log(chart.options.tooltips);
						fitChart();
					}else {
						sc = 0;
						$('.tooltips').css("bottom",(sc+24)+"px");
						chart.data.datasets[1].data = subfilterChart();
						var pow_= $subselect.val().substring(0,4);
						
						if (pow_ != current_KOD.substring(0,4)){
							chart.data.datasets[0].data = [];
						}
						//$(document).ready(function (){
						console.log("czoom: "+czoom+" szoom: "+szoom);
						//if (czoom==szoom){
						//alert("Popup close sub - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\npopup_close_first_clicked: " + "\npopup_open_first_clicked: " + popup_open_first_clicked);
						//temp_zoomed = manually_zoomed;
						//$(document).ready(function (){
						//auto_zoom = true;
						if (czoom==szoom){
							if(!block_centering){
								map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							}
						}else if (manually_zoomed){
							if(!block_centering){
								map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
							}
						}else{
							if(!block_centering){
								//var cbounds = layers[current_KOD].getBounds();
								map.setMaxZoom(map.getZoom());
								//map.fitBounds(cbounds, {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
								map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.8});
								map.setMaxZoom(10);
							}
						}
						//auto_zoom = false;
						//});
						//$(document).ready(function (){
						//manually_zoomed = temp_zoomed;
						//});
						//});
						/*map.getPane('labels').style.display = 'inline-block';
						map.getPane('labels').style['text-align'] = 'center';*/
						console.log(chart.options.tooltips);
						fitChart();
					}
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//chart.update();
					layer_current.eachLayer(function(layer) {	//restore feature color
						layer_current.resetStyle(layer);
					});
					already_filtered = true;
			}
			//$(document).ready(function (){
			var zoom = map.getZoom();
			if (zoom < tooltipThreshold+1){
				$('path.stroke-polyline').css('mix-blend-mode', 'normal');
			}else{
				$('path.stroke-polyline').css('mix-blend-mode', 'multiply');
			}
			updateAnn();
			chart.update();
			//});
			//popup_close_first_clicked = false;
			//manually_zoomed = temp_zoomed;
			//map.getPane('pane_Granicewojewdztw_1').style.zIndex = 402;
		});
		map.on('popupopen', function(e) {
		//if (!popOpened
			//////alert('POPUP OPENED!!! '+ manual_popup);
			//$(document).ready(function (){
				//popup_open_first_clicked = true;
			//});
			//manually_zoomed = auto_zoom;
			var curr = e.popup._source.feature.properties.JPT_KOD_JE;
			//already_selected = false;
			popup_close_first_clicked = false;
			//var curr = e.popup._source.feature.properties.JPT_KOD_JE;
			current_KOD = curr;
			var pop_kod = curr;
			layer_code = layer_current._leaflet_id;
			link_clicked = false;
			//options_saved = chart.options;
			//data_saved = chart.data.datasets[0];
			var PJE = e.popup._source.feature.properties.Powiat;
			var PWE = e.popup._source.feature.properties.Wojewod;
			var powiat_nazwa = json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', PJE)[0].properties.JPT_NAZWA_;
			var woj_nazwa = json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', PWE)[0].properties.JPT_NAZWA_;
			
			block_cl_pop = true;
			
			//////alert('manual_popup: '+manual_popup);
			if (manual_popup){
			//czoom = map.getZoom();
			chart.data.datasets[0].data = [];
			if ($select.val()=='Polska'){
				chart.data.datasets[1].data = scatterPlotDataArray;
				//fitChart();
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				var skod = pop_kod.substring(0,2).toString();
				var sind = pop_kod.substring(0,2)/2+1;
				console.log(pop_kod+'-'+skod+'-'+cind+'-'+sind);
				
				//if (sind!=cind){
					//console.log('Popup opened (woj) subch');
					//$select.change(subch);
					//setTimeout(function () {
						polygon_clicked = true;
						manual_zoom = false;
						$('#filter :nth-child('+sind+')').prop('selected', true).change();
						manual_zoom = true;
						polygon_clicked = false;
						//chart.update();
					//}, 500);
					//console.log('popup opened ' + filtered);
					wojewods[PWE].setStyle({color: 'rgba(255,255,255,1.0)'});
					wojewods2[PWE].setStyle({color: 'rgba(224,0,0,1.0)'});
				//}
				/*if ($select.val()!='Polska'){
					$('#subfilter :nth-child(1)').prop('selected', true).change();
				}*/
				//chart.data.datasets[1].data = filterChart();
				console.log(chart.options.tooltips);
				fitChart();
			}	else {
				select_twice = true;
				woj_zoom = false;
				var pind = pop_kod.substring(2,4)/1+1;
				console.log(pind);
				
				console.log($select);
				console.log($select.val());
				//if ($select.val()=='Polska'){
					//console.log("Tak - Polska!");
				var wind = pop_kod.substring(0,2)/2+1;
				if (wind!=cind){
					$('#filter :nth-child('+wind+')').prop('selected', true).change();
					console.log('Popup opened (pow) subch');
					$select.change(subch);
					console.log("iii");
				}
				//$select.change(subch);
				//subb = 1;
				//$('#subfilter :nth-child('+pind+')').prop('selected', true).change();
				polygon_clicked = true;
				manual_zoom = false;
				$("#subfilter option").filter(function() {
				  //may want to use $.trim in here
					return $(this).text().substring(0,4) == current_KOD.substring(0,4);
				}).prop('selected', true).change();
				manual_zoom = true;
				polygon_clicked = false;
				console.log("iii");
				//subb = 0;
				console.log($('#subfilter :nth-child('+pind+')'));
				//map.fitBounds(pow_ats[kod.substring(0,4)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
				cind=wind;
				polind =0;
				filtered = true;
				console.log('popup opened ' + filtered);
				//chart.data.datasets[1].data = subfilterChart();
				console.log(chart.options.tooltips);
				//fitChart();
				//map.getPane('pane_Granicewojewdztw_1').style.zIndex = 402;
			}
			select_twice = false;
			pointRadiuses = [];
			pointBorderColors = [];
			pointBBorderColors = [];
			pointBorderWidths = [];
			var licz = 0;
			var liczyc = true;
			layer_current.eachLayer(function(layer) {
				
				pointBBorderColors.push('rgba(255, 255, 255, 0.2)');
				/*if (current_KOD==layer.feature.properties.JPT_KOD_JE){
					//layer.bringToBack();
					console.log(layer.feature.properties.JPT_KOD_JE);
					pointRadiuses.push(6.4);
					pointBorderColors.push('rgba(255, 0, 0, 1.0)');
					pointBorderWidths.push(2.56);
					//layer.push(layer.splice(layer.indexOf(layer[current_KOD]), 1)[0]);
					liczyc = false;
				}else{*/
					pointRadiuses.push(3.6);
					pointBorderColors.push('rgba(64, 64, 64, 0.64)');
					pointBorderWidths.push(1.0);
				//}
			});
			/*pointRadiuses.push(pointRadiuses.splice(pointRadiuses[licz], 1)[0]);
			pointBorderColors.push(pointBorderColors.splice(pointBorderColors[licz], 1)[0]);
			pointBorderWidths.push(pointBorderWidths.splice(pointBorderWidths[licz], 1)[0]);
			pointBackgroundColors.push(pointBackgroundColors.splice(pointBackgroundColors[licz], 1)[0]);*/
			/*pointRadiuses[2476]=6.4;
			pointBorderColors[2476]='rgba(255, 0, 0, 0.4)';
			pointBorderWidths[2476]=2.56;*/
			//layer_current[licz];
			
			
			}
			chart.data.datasets[1].pointRadius = pointRadiuses;
			chart.data.datasets[1].pointBorderColor = pointBorderColors;
			chart.data.datasets[2].pointBorderColor = pointBBorderColors;
			chart.data.datasets[1].pointBorderWidth = pointBorderWidths;
			chart.data.datasets[2].pointBackgroundColor = pointBBackgroundColors;
			
			chart.data.datasets[2].data = [];
			chart.data.datasets[1].pointBackgroundColor = pointBackgroundColors;
			
			
			//chart.data.datasets[1].data.push(chart.data.datasets[1].data.splice(scatterPlotDataArray[licz], 1)[0]);
			//chart.data.datasets[0].pointRadius[licz]= 6.4;
			console.log(pointRadiuses.length);
			chart.data.datasets[0].data = checkPoint();
			chart.update();
			block_cl_pop = false;
			manual_popup = true;
			$(document).ready(function ()	{
				//$('leaflet-popup  leaflet-zoom-animated').ready(function ()	{
		//setTimeout(function(){ console.log("Czekamy..."); }, 1000);
			/*if (popOpened){
				setTimeout(function(){ console.log("Czekamy..."); }, 2000);
			}*/
			
			chosenCol('Podsumowanie');	
				
				
			var popupContent	= [];
			var wpopupContent	= [];
			var plpopupContent	= [];
			
			for (i=0; i<3; i++){
				popupContent[i] = new Array();
				wpopupContent[i] = new Array();
				plpopupContent[i] = new Array();
			}
			for (i=0; i<3; i++){
				popupContent[i].push(margl);
				wpopupContent[i].push(margl);
				plpopupContent[i].push(margl);
			}
			//console.log(JEkod[feature.properties['Powiat']][0][0]);
			//console.log(wpopupContent[0]);
			
			
			
			for (i=0;i<9;i++){
				var len = JEkod[PJE][i].length;
				
				popupContent[Math.floor(i/3)].push('<div style="float:left; padding: 2px; width: 200px;"><table class = "tabela" id = "fixedheight"><thead>');
				popupContent[Math.floor(i/3)].push(thead[i]);
				popupContent[Math.floor(i/3)].push('</thead><tbody>');
				
				if (len<8){
					for (a=0; a<JEkod[PJE][i].length;a++){
						var d1 = JEkod[PJE][Math.floor(i/3)*3].indexOf(JEkod[PJE][i][a]);
						var d2 = JEkod[PJE][Math.floor(i/3)*3+1].indexOf(JEkod[PJE][i][a]);
						var d3 = JEkod[PJE][Math.floor(i/3)*3+2].indexOf(JEkod[PJE][i][a]);
						var t_gm = (JEkod[PJE][i][a].substring(6,7)!=="1"?'gm. ':'m. ');
						if (JEkod[PJE][i][a] == curr){
							popupContent[Math.floor(i/3)].push('<tr><td style="font-weight:bold; text-align: right;"><div>'+(a+1)+ '.</div></td><td class="pow" style="font-weight:bold"><div><a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+t_gm + '<span class="gmina">'+JEnazwa[PJE][i][a]+'</span></span></a></div></td><td style="font-weight:bold"><div>'+lengthToBlank1(JEudzial[PJE][i][a]) +'%</div></td><td><div><div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((JEudzial[PJE][i][a] != 100)? JEkolor[PJE][i][a]:'rgba(0,0,0,0.0)')  + '; opacity: 0.8; width: 12px; height: 100%;"></div></div></div></td></tr>');
							
						}else{
							popupContent[Math.floor(i/3)].push('<tr><td style="text-align: right;"><div>'+(a+1)+ '.</div></td><td class="pow">\
								<div class="containers">\
									<a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+t_gm + '<span class="gmina">'+JEnazwa[PJE][i][a]+'</span></span>\
										<span class="tooltip-wrappers">\
											<span class="tooltips"><h4 style="margin: 4px; padding: 0px; text-align: center;">Położenie:</h4>TERYT: <span class="kod">' +JEkod[PJE][i][a]+'</span><br><h4 style="margin: 4px; padding: 0px; text-align: center;">Wyniki:</h4><table id="popt"><tr><td>'+candidateName(Math.floor(i/3)*3)+'</td><td>'+lengthToBlank1(JEudzial[PJE][Math.floor(i/3)*3][d1])+'%</td></tr><tr><td>'+candidateName(Math.floor(i/3)*3+1)+'</td><td>'+lengthToBlank1(JEudzial[PJE][Math.floor(i/3)*3+1][d2])+'%</td></tr><tr><td>Absencja i nieważne:</td><td>'+lengthToBlank1(JEudzial[PJE][Math.floor(i/3)*3+2][d3])+'%</td></tr></table>\
											</span>\
										</span>\
									</a>\
								</div>\
							</td><td><div>'+lengthToBlank1(JEudzial[PJE][i][a]) +'%</div></td><td><div>'+'<div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((JEudzial[PJE][i][a] != 100)? JEkolor[PJE][i][a]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>');
						}
					}
				}else{
					var ind = JEkod[PJE][i].indexOf(curr);
					for (b=0; b<len;b++){
						var t_gm = (JEkod[PJE][i][b].substring(6,7)!=="1"?'gm. ':'m. ');
						
						var d1 = JEkod[PJE][Math.floor(i/3)*3].indexOf(JEkod[PJE][i][b]);
						var d2 = JEkod[PJE][Math.floor(i/3)*3+1].indexOf(JEkod[PJE][i][b]);
						var d3 = JEkod[PJE][Math.floor(i/3)*3+2].indexOf(JEkod[PJE][i][b]);
						var row = '<tr><td style="text-align: right;"><div>'+(b+1)+ '.</div></td><td class="pow">\
								<div class="containers">\
									<a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px; text-align: center;">'+t_gm + '<span class="gmina">'+JEnazwa[PJE][i][b]+'</span></span>\
										<span class="tooltip-wrappers">\
											<span class="tooltips"><h4 style="margin: 4px; padding: 0px; text-align: center;">Położenie:</h4>TERYT: <span class="kod">' +JEkod[PJE][i][b]+'</span><br><h4 style="margin: 4px; padding: 0px; text-align: center;">Wyniki:</h4><table><tr><td>'+candidateName(Math.floor(i/3)*3)+'</td><td>'+lengthToBlank1(JEudzial[PJE][Math.floor(i/3)*3][d1])+'%</td></tr><tr><td>'+candidateName(Math.floor(i/3)*3+1)+'</td><td>'+lengthToBlank1(JEudzial[PJE][Math.floor(i/3)*3+1][d2])+'%</td></tr><tr><td>Absencja i nieważne:</td><td>'+lengthToBlank1(JEudzial[PJE][Math.floor(i/3)*3+2][d3])+'%</td></tr></table>\
											</span>\
										</span>\
									</a>\
								</div>\
							</td><td><div>'+lengthToBlank1(JEudzial[PJE][i][b]) +'%</div></td><td><div>'+'<div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((JEudzial[PJE][i][b] != 100)? JEkolor[PJE][i][b]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>';
						var row_curr = '<tr><td style="font-weight:bold; text-align: right;"><div>'+(b+1)+ '.</div></td><td class="pow" style="font-weight:bold"><div><a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+t_gm + '<span class="gmina">'+JEnazwa[PJE][i][b]+'</span></span></a></div></td><td style="font-weight:bold"><div>'+lengthToBlank1(JEudzial[PJE][i][b])+'%</div></td><td><div>'+'<div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((JEudzial[PJE][i][b] != 100)? JEkolor[PJE][i][b]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>';
						if(ind<2||ind>len-3){
							if(b<3||b>len-4){
								if (b == ind){
									popupContent[Math.floor(i/3)].push(row_curr);
								}else{
									popupContent[Math.floor(i/3)].push(row);
								}
							}else if (b==3){
								popupContent[Math.floor(i/3)].push( row_empty);
							}
						}else if(ind==len-3){
							if(b==len-3){
								popupContent[Math.floor(i/3)].push( row_curr);
							}else if(b<2||b>len-3||b==ind-1){
								popupContent[Math.floor(i/3)].push(row);
							}else if (b==3){
								popupContent[Math.floor(i/3)].push( row_empty);
							}
						}else if(ind==2){
							if(b==2){
								popupContent[Math.floor(i/3)].push(row_curr);
							}else if(b<2||b>len-3||b==ind+1){
								popupContent[Math.floor(i/3)].push(row);
							}else if (b==4){
								popupContent[Math.floor(i/3)].push( row_empty);
							}
						}else{
							if(b==ind){
								popupContent[Math.floor(i/3)].push(row_curr);
							}else if(b==0||b==len-1||b==ind+1||b==ind-1){
								popupContent[Math.floor(i/3)].push(row);
							}else if (b==1||b==len-2){
								popupContent[Math.floor(i/3)].push( row_empty);
							}
						}
					}
				}
				popupContent[Math.floor(i/3)].push('</tbody></table></div>');
			}
			
			//json_Demografia.features.
			//var curr = e.popup._source.feature.properties.JPT_KOD_JE;
			for (i=0;i<9;i++){
				var len = WEkod[PWE][i].length;
				wpopupContent[Math.floor(i/3)].push('<div style="float:left; padding: 2px; width: 200px;"><table class = "tabela" id = "fixedheight"><thead>');
				wpopupContent[Math.floor(i/3)].push(thead[i]);
				wpopupContent[Math.floor(i/3)].push('</thead><tbody>');
					var ind = WEkod[PWE][i].indexOf(curr);
					for (b=0; b<len;b++){
						var d1 = WEkod[PWE][Math.floor(i/3)*3].indexOf(WEkod[PWE][i][b]);
						var d2 = WEkod[PWE][Math.floor(i/3)*3+1].indexOf(WEkod[PWE][i][b]);
						var d3 = WEkod[PWE][Math.floor(i/3)*3+2].indexOf(WEkod[PWE][i][b]);
						var t_gm = (WEkod[PWE][i][b].substring(6,7)!=="1"?'gm. ':'m. ');
						var row = '<tr><td><div>'+(b+1)+ '.</div></td><td class = "woj">\
								<div class="containers">\
									<a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+t_gm + '<span class="gmina">'+WEnazwa[PWE][i][b]+'</span></span>\
										<span class="tooltip-wrappers">\
											<span class="tooltips"><h4 style="margin: 4px; padding: 0px; text-align: center;">Położenie:</h4>TERYT: <span class="kod">' +WEkod[PWE][i][b]+'</span><br>'+  json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', WEpow[PWE][i][b])[0].properties.JPT_NAZWA_+ '<br><h4 style="margin: 4px; padding: 0px; text-align: center;">Wyniki:</h4><table><tr><td>'+candidateName(Math.floor(i/3)*3)+'</td><td>'+lengthToBlank1(WEudzial[PWE][Math.floor(i/3)*3][d1])+'%</td></tr><tr><td>'+candidateName(Math.floor(i/3)*3+1)+'</td><td>'+lengthToBlank1(WEudzial[PWE][Math.floor(i/3)*3+1][d2])+'%</td></tr><tr><td>Absencja i nieważne:</td><td>'+lengthToBlank1(WEudzial[PWE][Math.floor(i/3)*3+2][d3])+'%</td></tr></table>\
											</span>\
										</span>\
									</a>\
								</div>\
							</td><td><div>'+lengthToBlank1(WEudzial[PWE][i][b]) +'%</div></td><td><div><div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((WEudzial[PWE][i][b] != 100)? WEkolor[PWE][i][b]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>';
							
						var row_curr = '<tr><td style="font-weight:bold; text-align: right;"><div>'+(b+1)+ '.</div></td><td class="woj" style="font-weight:bold"><div><a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+t_gm + '<span class="gmina">'+WEnazwa[PWE][i][b]+'</span></span></a></div></td><td style="font-weight:bold"><div>'+lengthToBlank1(WEudzial[PWE][i][b]) +'%</div></td><td><div><div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((WEudzial[PWE][i][b] != 100)? WEkolor[PWE][i][b]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>';
						
						if(ind<2||ind>len-3){
							if(b<3||b>len-4){
								if (b == ind){
									wpopupContent[Math.floor(i/3)].push(row_curr);
								}else{
									wpopupContent[Math.floor(i/3)].push(row);
								}
							}else if (b==3){
								wpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}else if(ind==len-3){
							if(b==len-3){
								wpopupContent[Math.floor(i/3)].push(row_curr);
							}else if(b<2||b>len-3||b==ind-1){
								wpopupContent[Math.floor(i/3)].push(row);
							}else if (b==3){
								wpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}else if(ind==2){
							if(b==2){
								wpopupContent[Math.floor(i/3)].push(row_curr);
							}else if(b<2||b>len-3||b==ind+1){
								wpopupContent[Math.floor(i/3)].push(row);
							}else if (b==4){
								wpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}else{
							if(b==ind){
								wpopupContent[Math.floor(i/3)].push(row_curr);
							}else if(b==0||b==len-1||b==ind+1||b==ind-1){
								wpopupContent[Math.floor(i/3)].push(row);
							}else if (b==1||b==len-2){
								wpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}
					}
				//wpopupContent[Math.floor(i/3)] =  wpopupContent[Math.floor(i/3)] +'</tbody></table></div>';
				wpopupContent[Math.floor(i/3)].push('</tbody></table></div>');
			}
			
			//var curr = e.popup._source.feature.properties.JPT_KOD_JE;
			for (i=0;i<9;i++){
				var len = PLkod[i].length;
				var row = "";
				
				//console.log(len);
				plpopupContent[Math.floor(i/3)].push('<div style="float:left; padding: 2px; width: 200px;"><table class = "tabela" id = "fixedheight"><thead>');
				plpopupContent[Math.floor(i/3)].push(thead[i]);
				plpopupContent[Math.floor(i/3)].push('</thead><tbody>');
					var row_curr;
					var ind = PLkod[i].indexOf(curr);
					//console.log(ind);
					
					if  (typeof PLkod[i][ind]!== 'undefined'){
						var t_gm = (PLkod[i][ind].substring(6,7)!=="1"?'gm. ':'m. ');
						row_curr = '<tr><td style="font-weight:bold; text-align: right;"><div>'+(ind+1)+ '.</div></td><td style="font-weight:bold"><div><a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+t_gm + '<span class="gmina">'+PLnazwa[i][ind]+'</span></span></a></div></td><td style="font-weight:bold"><div>'+lengthToBlank1(PLudzial[i][ind]) +'%</div></td><td><div><div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((PLudzial[i][ind] != 100)? PLkolor[i][ind]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>';
					}else{
						row_curr = '';
					}
					for (b=0; b<len;b++){
						var d1 = PLkod[Math.floor(i/3)*3].indexOf(PLkod[i][b]);
						var d2 = PLkod[Math.floor(i/3)*3+1].indexOf(PLkod[i][b]);
						var d3 = PLkod[Math.floor(i/3)*3+2].indexOf(PLkod[i][b]);
						var t_gm = (PLkod[i][b].substring(6,7)!=="1"?'gm. ':'m. ');
						
						
						if(ind<2||ind>len-3){
							if(b<3||b>len-4){
								if (b == ind){
									plpopupContent[Math.floor(i/3)].push(row_curr);
								}else{
									row = rowGen(b, i, t_gm, d1, d2, d3);
									plpopupContent[Math.floor(i/3)].push(row);
								}
							}else if (b==3){
								plpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}else if(ind==len-3){
							if(b==len-3){
								plpopupContent[Math.floor(i/3)].push(row_curr);
							}else if(b<2||b>len-3||b==ind-1){
								row = rowGen(b, i, t_gm, d1, d2, d3);
								plpopupContent[Math.floor(i/3)].push(row);
							}else if (b==3){
								plpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}else if(ind==2){
							if(b==2){
								plpopupContent[Math.floor(i/3)].push(row_curr);
							}else if(b<2||b>len-3||b==ind+1){
								row = rowGen(b, i, t_gm, d1, d2, d3);
								plpopupContent[Math.floor(i/3)].push(row);
							}else if (b==4){
								plpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}else{
							if(b==ind){
								plpopupContent[Math.floor(i/3)].push(row_curr);
							}else if(b==0||b==len-1||b==ind+1||b==ind-1){
								row = rowGen(b, i, t_gm, d1, d2, d3);
								plpopupContent[Math.floor(i/3)].push(row);
							}else if (b==1||b==len-2){
								plpopupContent[Math.floor(i/3)].push(row_empty);
							}
						}
					}
				/*}*/
				plpopupContent[Math.floor(i/3)].push('</tbody></table></div>');
			}
			for (i=0; i<3; i++){
				popupContent[i].push('<div style="clear:both;"></div></div>');
			}
			for (i=0; i<3; i++){
				plpopupContent[i].push('<div style="clear:both;"></div></div>');
				wpopupContent[i].push('<div style="clear:both;"></div></div>');
				
			}
			$('#tab2').ready(function ()	{
			$('#tab2').html('<h5 style = "margin-left:28px; color: #282828;">'+powiat_nazwa+':</h5>');
			$('#tab3').html('<h5 style = "margin-left:28px; color: #282828;">'+powiat_nazwa+':</h5>');
			$('#tab4').html('<h5 style = "margin-left:28px; color: #282828;">'+powiat_nazwa+':</h5>');
			for (i=0; i<3; i++){
				$('#tab'+(i+2)).append('<p>'+popupContent[i].join("")+'</p>');
				$('#tab'+(i+2)).append('<h5  id = "tooltip-2" style = "margin-left:28px; color: #282828;">województwo ' + woj_nazwa + ':</h5>');
				$('#tab'+(i+2)).append('<p>'+wpopupContent[i].join("")+'</p>');
				$('#tab'+(i+2)).append('<h5 style = "margin-left:28px; color: #282828;">Polska:</h5>');
				$('#tab'+(i+2)).append('<p>'+plpopupContent[i].join("")+'</p>');
				$( "p" ).remove( ":contains('undefined')" );
				//$("#tooltip-2").tooltip();
			}
			
			$("#tab2").scroll(function () { 
				/*if ($(this).is(':animated')) {
					console.log('scroll happen by animate');
				} else if (e.originalEvent) {
					// scroll happen manual scroll
					console.log('scroll happen manual scroll');
					already_filtered = false;
				} else {
					// scroll happen by call
					console.log('scroll happen by call');
					already_filtered = false;
				}*/
				if (!already_filtered){
				sc = $("#tab2").scrollTop();
				$('.tooltips').css("bottom",(sc+24)+"px");
				}
				sc_temp=sc;
				//console.log(sc);
				//console.log("#tab2 was scrolled.");
			});
			$("#tab3").scroll(function () { 
				if (!already_filtered){
				sc = $("#tab3").scrollTop();
				$('.tooltips').css("bottom",(sc+24)+"px");
				}
				sc_temp=sc;
				//console.log(sc);
				//console.log("#tab3 was scrolled.");
			});
			$("#tab4").scroll(function () {
				if (!already_filtered){
				sc = $("#tab4").scrollTop();
				$('.tooltips').css("bottom",(sc+24)+"px");
				}
				sc_temp=sc;
				//console.log(sc);
				//$("#tab2").scrollTop(sc);
				//$("#tab3").scrollTop(sc);
				//console.log("#tab4 was scrolled.");
			});
		  /*console.log(e.popup._source.feature.properties.Wojewod);*/
		  /*$('.tab-content').click(function(e){
			console.log("One of the many Small Polygon Links was clicked");
		  });*/
		  $('.tabs .tab-links a').on('mouseenter',function(e) {
						//var currentAttrValue = $(this).attr('href');

						// Show/Hide Tabs
						if ($(this).parent('li').prev().hasClass('active')){
							//console.log("Tak!!!");
							
							//$(this).parent('li').prev().children('a').addClass('tab-links extra_stuff').parent('li').siblings().children('a').removeClass('tab-links extra_stuff');
							//console.log($(this).parent('li').prev().children('a'));
							$("#workAround").html(".tabs .active a:after {background: #7fbc41;}"); //Działa
						}else{
							//console.log("Nie!!!");
							$("#workAround").html(".tabs .active a:after {background: #4d9221;}")/*.animate({background: #7fbc41}, 150)*/;
						}
						
						if ($(this).parent('li').next().hasClass('active')){
							//console.log("pTak!!!");
							
							//$(this).parent('li').prev().children('a').addClass('tab-links extra_stuff').parent('li').siblings().children('a').removeClass('tab-links extra_stuff');
							//console.log($(this).parent('li').next().children('a'));
							$("#workAround").html(".tabs .active a:before {background: #7fbc41;}");
						}else{
							//console.log("pNie!!!");
							//$("#workAround").html(".tabs .active a:before {background: #a700e5;}");
						}
						// Change/remove current tab to active
						//$(this).parent('li').addClass('active').siblings().removeClass('active');

						//e.preventDefault();
					});
					$('.tabs .tab-links a').on('mouseleave',function(e) {
						$("#workAround").html(".tabs .active a:after {background: #7F00DA;}");
						//$("#workAround").html(".tabs .tab-links:last-of-type a:after {background: #222;}");
						$("#workAround").html(".tabs .active a:before {background: #4d9221;}");
					});
					$('.tabs .tab-links a').on('click', function(e) {
						var currentAttrValue = $(this).attr('href');
						console.log(currentAttrValue);
						
						// Show/Hide Tabs
						layers = {};
						scatterPlotDataArray_xy = [];
						scatterPlotDataArray_xz= [];
						scatterPlotDataArray_yx = [];
						scatterPlotDataArray_yz = [];
						scatterPlotDataArray_zx = [];
						scatterPlotDataArray_zy = [];
						pointBackgroundColors=[];
						pointFBackgroundColors=[];
						pointBBackgroundColors=[];
						
						$('.tabs ' + currentAttrValue).show().siblings().hide();
						switch(currentAttrValue){
							case '#tab2':
								year = 10;
								xa = 'Komorowski';
								ya = 'Kaczyński';
								za = 'Absencja i nieważne';
								xb = xa;
								yb = ya;
								zb = za;
								updateChanger(xb,yb,zb);
								layer_10.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po10, p.pis10);
									pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
									pointFBackgroundColors.push(p.rgb10);
									pointBBackgroundColors.push(colorconvert(p.rgb10,0.32));
								});
								
								chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
								chart.data.datasets[2].pointBackgroundColor=pointBBackgroundColors;
								//console.log(chart.data.datasets[0].pointBackgroundColor);
								console.log(scatterPlotDataArray);
								chart.options.scales.xAxes[0].ticks = {
								  beginAtZero: false,
								  max: 80,
								  stepSize: 20
								};
								chart.options.scales.yAxes[0].ticks = {
								  beginAtZero: false,
								  max: 80,
								  stepSize: 20
								};
								changerToChart($changer);
								chart.data.datasets[0].data = checkPoint();
								chart.data.datasets[0].pointBackgroundColor=pointFBackgroundColors;
								chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:'];
								chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
									return setTooltipText('Kaczyński', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
								}
								jedn = '%';
								switchAnn(1);
								console.log(filtered);
								if ($select.val()=='Polska'/*&&currentAttrValue!='#tab1'*/){
									chart.data.datasets[1].data = scatterPlotDataArray;
									//sc = $("#tab2").scrollTop();
									//$("#tab2").scrollTop($("#tab2").scrollHeight);
									//sc = $("#tab2").scrollTop(400);
									if (already_filtered){
										sc = $("#tab2")[0].scrollHeight - $("#tab2").height() - 16;
										console.log( "#tab2 scrollHeight: "+ $("#tab2")[0].scrollHeight +" height: "+ $("#tab2").height()  +" sc: "+ sc);
										$('#tab2 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[2].data = [];
								}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
									//sc = $("#tab2").height();
									if (already_filtered){
										sc =  $("#tab2")[0].scrollHeight - 2*$("#tab2").height() - 40;
										$('#tab2 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[1].data = filterChart();
									chart.data.datasets[2].data = scatterPlotDataArray10;
									
									console.log(chart.options.tooltips);
								}	else {
									if (already_filtered){
										sc = 16;
										$('#tab2 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[1].data = subfilterChart();
									chart.data.datasets[2].data = scatterPlotDataArray10;
									
									console.log(chart.options.tooltips);
								}
								already_filtered = false;
								sc_temp = sc;
								//console.log(data_saved);
								break;
							case '#tab3':
								year = 15;
								xa = 'Komorowski';
								ya = 'Duda';
								za = 'Absencja i nieważne';
								xb = xa;
								yb = ya;
								zb = za;
								updateChanger(xb,yb,zb);
								layer_15.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po15, p.pis15);
									pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
									pointFBackgroundColors.push(p.rgb15);
									pointBBackgroundColors.push(colorconvert(p.rgb15,0.32));
								});
								
								chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
								chart.data.datasets[2].pointBackgroundColor=pointBBackgroundColors;
								console.log(scatterPlotDataArray);
								chart.options.scales.xAxes[0].ticks = {
								  beginAtZero: true,
								  max: 80,
								  stepSize: 20
								};
								chart.options.scales.yAxes[0].ticks = {
								  beginAtZero: true,
								  max: 80,
								  stepSize: 20
								};
								changerToChart($changer);
								chart.data.datasets[0].data = checkPoint();
								chart.data.datasets[0].pointBackgroundColor=pointFBackgroundColors;
								chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2015 r.', 'jako odsetek osób uprawnionych do głosowania:'];
								chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
									return setTooltipText('Duda', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
								}
								jedn = '%';
								switchAnn(1);
								console.log("Czy użyto filtra gmin: "+filtered);
								if ($select.val()=='Polska'/*&&currentAttrValue!='#tab1'*/){
									chart.data.datasets[1].data = scatterPlotDataArray;
									if (already_filtered){
										sc = $("#tab3")[0].scrollHeight - $("#tab3").height() - 16;
										console.log( "#tab3 scrollHeight: "+ $("#tab3")[0].scrollHeight +" height: "+ $("#tab3").height()  +" sc: "+ sc);
										$('#tab3 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[2].data = [];
								}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
									//sc = $("#tab2").height();
									if (already_filtered){
										sc = $("#tab3")[0].scrollHeight - 2*$("#tab3").height() - 40;
										$('#tab3 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[1].data = filterChart();
									chart.data.datasets[2].data = scatterPlotDataArray15;
									
									console.log(chart.options.tooltips);
								}	else {
									if (already_filtered){
										sc = 16;
										$('#tab3 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[1].data = subfilterChart();
									chart.data.datasets[2].data = scatterPlotDataArray15;
									
									console.log(chart.options.tooltips);
								}
								already_filtered = false;
								sc_temp = sc;
								//console.log(data_saved);
								break;
							case '#tab4':
								year = 20;
								xa = 'Trzaskowski';
								ya = 'Duda';
								za = 'Absencja i nieważne';
								xb = xa;
								yb = ya;
								zb = za;
								updateChanger(xb,yb,zb);
								layer_20.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po20, p.pis20);
									pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
									pointFBackgroundColors.push(p.rgb20);
									pointBBackgroundColors.push(colorconvert(p.rgb20,0.32));
								});
								
								chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
								chart.data.datasets[2].pointBackgroundColor=pointBBackgroundColors;
								console.log(scatterPlotDataArray);
								chart.options.scales.xAxes[0].ticks = {
								  beginAtZero: true,
								  max: 80,
								  stepSize: 20
								};
								chart.options.scales.yAxes[0].ticks = {
								  beginAtZero: true,
								  max: 80,
								  stepSize: 20
								};
								changerToChart($changer);
								chart.data.datasets[0].data = checkPoint();
								chart.data.datasets[0].pointBackgroundColor = pointFBackgroundColors;
								chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2020 r.', 'jako odsetek osób uprawnionych do głosowania:'];
								chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
									return setTooltipText('Duda', 'Trzaskowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
								}
								//console.log(data_saved);
								console.log(filtered);
								jedn = '%';
								switchAnn(1);
								if ($select.val()=='Polska'/*&&currentAttrValue!='#tab1'*/){
									chart.data.datasets[1].data = scatterPlotDataArray;
									//sc = $("#tab2").scrollTop();
									//$("#tab2").scrollTop($("#tab2").scrollHeight);
									//sc = $("#tab2").scrollTop(400);
									if (already_filtered){
										sc = $("#tab4")[0].scrollHeight - $("#tab4").height() - 16;
										console.log( "#tab4 scrollHeight: "+ $("#tab4")[0].scrollHeight +" height: "+ $("#tab4").height()  +" sc: "+ sc);
										$('.tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[2].data = [];
								}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
									//sc = $("#tab2").height();
									if (already_filtered){
										sc = $("#tab4")[0].scrollHeight - 2*$("#tab4").height() - 40;
										$('#tab4 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[1].data = filterChart();
									chart.data.datasets[2].data = scatterPlotDataArray20;
									console.log(chart.options.tooltips);
								}	else {
									if (already_filtered){
										sc = 16;
										$('#tab4 .tooltips').css("bottom",(sc+24)+"px");
									}
									chart.data.datasets[1].data = subfilterChart();
									chart.data.datasets[2].data = scatterPlotDataArray20;
									
									console.log(chart.options.tooltips);
								}
								already_filtered = false;
								sc_temp = sc;
								break;
							default:
								chart.data.datasets[2].data = [];
								year = 0;
								//scatterPlotDataArray = scatterPlotDataArrayTemp;
								switch(layer_code){
									case l1:
										xa = 'Komorowski';
										ya = 'Kaczyński';
										za = 'Absencja i nieważne';
										xb = xa;
										yb = ya;
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
											rotateData(p, p.po10, p.pis10);
											pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
											pointFBackgroundColors.push(p.rgb10);
										});
										
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										setChart();
										//console.log(chart.data.datasets[0].pointBackgroundColor);
										console.log(scatterPlotDataArray);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.data.datasets[0].data = checkPoint();
										chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('Kaczyński', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
										}
										jedn = '%';
										switchAnn(1);
										break;
									case l2:
										xa = 'Komorowski';
										ya = 'Duda';
										za = 'Absencja i nieważne';
										xb = xa;
										yb = ya;
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
											rotateData(p, p.po15, p.pis15);
											pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
											pointFBackgroundColors.push(p.rgb15);
										});
										
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										console.log(scatterPlotDataArray);
										setChart();
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.data.datasets[0].data = checkPoint();
										chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2015 r.', 'jako odsetek osób uprawnionych do głosowania:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('Duda', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
										}
										jedn = '%';
										switchAnn(1);
										break;
									case l3:
										xa = 'Trzaskowski';
										ya = 'Duda';
										za = 'Absencja i nieważne';
										xb = xa;
										yb = ya;
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
											rotateData(p, p.po20, p.pis20);
											pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
											pointFBackgroundColors.push(p.rgb20);
										});
										
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										setChart();
										console.log(scatterPlotDataArray);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.data.datasets[0].data = checkPoint();
										chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2020 r.', 'jako odsetek osób uprawnionych do głosowania:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('Duda', 'Trzaskowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
										}
										jedn = '%';
										switchAnn(1);
										break;
									case l4:
										xa = 'Komorowski\'15 - Komorowski\'10';
										ya = 'Duda\'15 - Kaczyński\'10';
										za = 'ABS\'15 - ABS\'10';
										xb = 'KOM\'15 - KOM\'10';
										yb = 'DUD\'15 - KAC\'10';
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											var rpo = p.po15 - p.po10;
											var rpis = p.pis15 - p.pis10;
											rotateDataPP(p, rpo, rpis);
											pointBackgroundColors.push(colorconvert(p.rgb1510,0.8));
											pointFBackgroundColors.push(p.rgb1510);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										setChart(false, -25, 25, 10);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: false,
										  max: 25,
										  min: -25,
										  stepSize: 10
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: false,
										  max: 25,
										  min: -25,
										  stepSize: 10
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2015:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('DUD\'15-KAC\'10', 'KOM\'15-KOM\'10', 'ABS\'15-ABS\'10', '&nbsp;p.p.',tooltipItems);
										}
										jedn = ' p.p.';
										switchAnn(1);
										break;
									case l5:
										xa = 'Trzaskowski\'20 - Komorowski\'15';
										ya = 'Duda\'20 - Duda\'15';
										za = 'ABS\'20 - ABS\'15';
										xb = 'TRZ\'20 - KOM\'15';
										yb = 'DUD\'20 - DUD\'15';
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											var rpo = p.po20- p.po15;
											var rpis = p.pis20 - p.pis15;
											rotateDataPP(p, rpo, rpis);
											pointBackgroundColors.push(colorconvert(p.rgb2015,0.8));
											pointFBackgroundColors.push(p.rgb2015);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										setChart(false, -40, 40, 20);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2015 -> 2020:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('DUD\'20-DUD\'15', 'TRZ\'20-KOM\'15', 'ABS\'20-ABS\'15', '&nbsp;p.p.',tooltipItems);
										}
										jedn = ' p.p.';
										switchAnn(1);
										break;
									case l6:
										xa = 'Trzaskowski\'20 - Komorowski\'10';
										ya = 'Duda\'20 - Kaczyński\'10';
										za = 'ABS\'20 - ABS\'10';
										xb = 'TRZ\'20 - KOM\'10';
										yb = 'DUD\'20 - KAC\'10';
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											var rpo = p.po20 - p.po10;
											var rpis = p.pis20 - p.pis10;
											rotateDataPP(p, rpo, rpis);
											pointBackgroundColors.push(colorconvert(p.rgb2010,0.8));
											pointFBackgroundColors.push(p.rgb2010);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										//setChart(false, -40, 40, 20);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2020:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('DUD\'20-KAC\'10', 'TRZ\'20-KOM\'10', 'ABS\'20-ABS\'10', '&nbsp;p.p.',tooltipItems);
										}
										jedn = ' p.p.';
										switchAnn(1);
										break;
									case l7:
										xa = 'Komorowski\'15 - Komorowski\'10';
										ya = 'Duda\'15 - Kaczyński\'10';
										za = 'ABS\'15 - ABS\'10';
										xb = 'KOM\'15 - KOM\'10';
										yb = 'DUD\'15 - KAC\'10';
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											var rpo = p.po15 - p.po10;
											var rpis = p.pis15 - p.pis10;
											rotateDataPP(p, rpo, rpis);
											pointBackgroundColors.push(colorconvert(p.rgb1510c,0.8));
											pointFBackgroundColors.push(p.rgb1510c);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										//setChart(false, -25, 25, 10);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: false,
										  max: 25,
										  min: -25,
										  stepSize: 10
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: false,
										  max: 25,
										  min: -25,
										  stepSize: 10
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2015:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('DUD\'15-KAC\'10', 'KOM\'15-KOM\'10', 'ABS\'15-ABS\'10', '&nbsp;p.p.',tooltipItems);
										}
										jedn = ' p.p.';
										switchAnn(0);
										break;
									case l8:
										xa = 'Trzaskowski\'20 - Komorowski\'15';
										ya = 'Duda\'20 - Duda\'15';
										za = 'ABS\'20 - ABS\'15';
										xb = 'TRZ\'20 - KOM\'15';
										yb = 'DUD\'20 - DUD\'15';
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											var rpo = p.po20- p.po15;
											var rpis = p.pis20 - p.pis15;
											rotateDataPP(p, rpo, rpis);
											pointBackgroundColors.push(colorconvert(p.rgb2015c,0.8));
											pointFBackgroundColors.push(p.rgb2015c);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										//setChart(false, -40, 40, 20);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2015 -> 2020:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('DUD\'20-DUD\'15', 'TRZ\'20-KOM\'15', 'ABS\'20-ABS\'15', '&nbsp;p.p.',tooltipItems);
										}
										jedn = ' p.p.';
										switchAnn(0);
										break;
									case l9:
										xa = 'Trzaskowski\'20 - Komorowski\'10';
										ya = 'Duda\'20 - Kaczyński\'10';
										za = 'ABS\'20 - ABS\'10';
										xb = 'TRZ\'20 - KOM\'10';
										yb = 'DUD\'20 - KAC\'10';
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											var rpo = p.po20 - p.po10;
											var rpis = p.pis20 - p.pis10;
											rotateDataPP(p, rpo, rpis);
											pointBackgroundColors.push(colorconvert(p.rgb2010c,0.8));
											pointFBackgroundColors.push(p.rgb2010c);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										//setChart(false, -40, 40, 20);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: false,
										  max: 40,
										  min: -40,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2020:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('DUD\'20-KAC\'10', 'TRZ\'20-KOM\'10', 'ABS\'20-ABS\'10', '&nbsp;p.p.',tooltipItems);
										}
										jedn = ' p.p.';
										switchAnn(0);
										break;
									default:
										xa = 'Komorowski';
										ya = 'Kaczyński';
										za = 'Absencja i nieważne';
										xb = xa;
										yb = ya;
										zb = za;
										updateChanger(xb,yb,zb);
										layer_current.eachLayer(function (evt, idx) {
											var p = evt.feature.properties;
											layers[p.JPT_KOD_JE] = evt;
											//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
											rotateData(p, p.po10, p.pis10);
											pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
											pointFBackgroundColors.push(p.rgb10);
										});
										chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
										//console.log(chart.data.datasets[0].pointBackgroundColor);
										console.log(scatterPlotDataArray);
										/*chart.options.scales.xAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};
										chart.options.scales.yAxes[0].ticks = {
										  beginAtZero: true,
										  max: 80,
										  stepSize: 20
										};*/
										changerToChart($changer);
										chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:'];
										chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
											return setTooltipText('Kaczyński', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
										}
								}
								chart.data.datasets[0].pointBackgroundColor=pointFBackgroundColors;
								chart.data.datasets[0].data=checkPoint();
								console.log(scatterPlotDataArray[0].x);
								console.log(filtered);
								if ($select.val()=='Polska'/*&&currentAttrValue!='#tab1'*/){
									chart.data.datasets[1].data = scatterPlotDataArray;
									//sc = $("#tab2").scrollTop();
									//$("#tab2").scrollTop($("#tab2").scrollHeight);
									//sc = $("#tab2").scrollTop(400);
									//sc = $("#tab2").scrollTop() + $("#tab2")[0].scrollHeight - $("#tab2").height() - 16;
									//sc = $("#tab2")[0].scrollHeight - $("#tab2").height() - 16;
									if (layer_code==l1||layer_code==l2||layer_code==l3){
										setChart();
									}else{
										fitChart();
									}
									sc = sc_temp;
									//console.log("scrollTop: "+ $("#tab2").scrollTop() +" scrollHeight: "+ $("#tab2")[0].scrollHeight +" sc: "+sc);
									console.log( "#tab2 scrollHeight: "+ $("#tab2")[0].scrollHeight +" height: "+ $("#tab2").height()  +" sc: "+ sc);
									//$('.tooltips').css("bottom",(sc+24)+"px");
								}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
									//sc = $("#tab2").height();
									sc = $("#tab2").scrollTop() + $("#tab2")[0].scrollHeight - 2*$("#tab2").height() - 40;
									$('.tooltips').css("bottom",(sc+24)+"px");
									chart.data.datasets[1].data = filterChart();
									console.log(chart.options.tooltips);
									fitChart();
								}	else {
									sc = 0;
									$('.tooltips').css("bottom",(sc+24)+"px");
									chart.data.datasets[1].data = subfilterChart();
									console.log(chart.options.tooltips);
									fitChart();
								}
								/*layer_current.eachLayer(function (evt, idx) {
									var p = evt.feature.properties;
									//console.log(evt);
									layers[p.JPT_KOD_JE] = evt;
									//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
									rotateData(p, p.po10, p.pis10);
									pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
								});*/
								sc = sc_temp;
								console.log('tab 1');
								//console.log(scatterPlotDataArray);
								//===changerToChart($changer);
								//chart.options = options_saved;
								//chart.data.datasets[0] = data_saved;
								//console.log(chart.data.datasets[0]);
						}
						//if (currentAttrValue!='#tab1'){
							/*if (!filtered/*&&currentAttrValue!='#tab1'*//*){
								chart.data.datasets[1].data = scatterPlotDataArray;
								//sc = $("#tab2").scrollTop();
								//$("#tab2").scrollTop($("#tab2").scrollHeight);
								//sc = $("#tab2").scrollTop(400);
								sc = $("#tab2").scrollTop() + $("#tab2")[0].scrollHeight - $("#tab2").height() - 16;
								console.log(sc);
								$('.tooltips').css("bottom",(sc+24)+"px");
							}else if  ($subselect.val()=='none'){
								//sc = $("#tab2").height();
								sc = $("#tab2").scrollTop() + $("#tab2")[0].scrollHeight - 2*$("#tab2").height() - 40;
								$('.tooltips').css("bottom",(sc+24)+"px");
								chart.data.datasets[1].data = filterChart();
								console.log(chart.options.tooltips);
							}	else {
								sc = 0;
								$('.tooltips').css("bottom",(sc+24)+"px");
								chart.data.datasets[1].data = subfilterChart();
								console.log(chart.options.tooltips);
							}*/
						//}
						
						console.log( "#tab2 scrollHeight: "+ $("#tab2")[0].scrollHeight +" height: "+ $("#tab2").height()  +" sc: "+ sc);
						updateAnn();
						chart.update();
						// Change/remove current tab to active
						$(this).parent('li').addClass('active').siblings().removeClass('active');
						$("#workAround").html(".tabs .active a:after {background: #4d9221;}");
						$("#tab2").scrollTop(sc);
						$("#tab3").scrollTop(sc);
						$("#tab4").scrollTop(sc);
						//this.className="thing1 extra_stuff";
						e.preventDefault();
					});
					$('.tab-content div h5').on('click',function(e) {
						if  ($(this).parents('#tab2').length){
							if (layer_10._leaflet_id!=layer_current._leaflet_id){
								map.removeLayer(layer_current);
								layer_current = layer_10;
								layer_10.addTo(map);
								//customControlLayers();
							}
						}else if  ($(this).parents('#tab3').length){
							if (layer_15._leaflet_id!=layer_current._leaflet_id){
								map.removeLayer(layer_current);
								layer_current = layer_15;
								layer_15.addTo(map);
								//customControlLayers();
							}
						}else if  ($(this).parents('#tab4').length){
							if (layer_20._leaflet_id!=layer_current._leaflet_id){
								map.removeLayer(layer_current);
								layer_current = layer_20;
								layer_20.addTo(map);
								//customControlLayers();
							}
						}
						
						//////alert('Show!!!'+$(this).text().substring(0,3));
						if ($(this).text().substring(0,3)=='pow'){
							woj_zoom = false;
							select_twice = true;
							//map.closePopup();
							var pind = current_KOD.substring(2,4)/1+1;
							console.log(pind);
							
							console.log($select);
							console.log($select.val());
							//if ($select.val()=='Polska'){
								//console.log("Tak - Polska!");
							var wind = current_KOD.substring(0,2)/2+1;
							//if (wind!=cind){
								$('#filter :nth-child('+wind+')').prop('selected', true).change();
								console.log('Ranking (pow) subch');
								$select.change(subch);
								console.log('pow link clicked ' + filtered);
							//}
							//$select.change(subch);
							//subb = 1;
							//$('#subfilter :nth-child('+pind+')').prop('selected', true).change();
							//manually_zoomed = true;
							adm_clicked = true;
							$("#subfilter option").filter(function() {
							  //may want to use $.trim in here
							  return $(this).text().substring(0,4) == current_KOD.substring(0,4);
							}).prop('selected', true).change();
							adm_clicked = false;
							console.log('pow link clicked ' + filtered);
							//subb = 0;
							console.log($('#subfilter :nth-child('+pind+')'));
							//map.fitBounds(pow_ats[kod.substring(0,4)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=wind;
							polind =0;
							filtered = true;
							select_twice = false;
							console.log('pow link clicked ' + filtered);
						}else if ($(this).text().substring(0,3)=='woj'){
							console.log($(this));
							//link_clicked = true;
							var skod = current_KOD.substring(0,2).toString();
							var sind = current_KOD.substring(0,2)/2+1;
							console.log(current_KOD+'-'+skod+'-'+cind+'-'+sind);
							//console.log(wojewods);
							//console.log(wojewods[skod.toString()]);
							
							//console.log($('#subfilter :nth-child(1)'));
							//$select.change(subch);
							//console.log($('#subfilter :nth-child(1)'));
							if ($select.val()!='Polska'){
								$('#subfilter :nth-child(1)').prop('selected', true).change();
								console.log('woj link clicked ' + filtered);
								//filtered = false;
								//map.closePopup();
							}
							//if (sind!=cind){
								adm_clicked = true;
								$('#filter :nth-child('+sind+')').prop('selected', true).change();
								adm_clicked = false;
								console.log('Ranking (woj) subch');
								$select.change(subch);
								/*setTimeout(function () {
									$('#filter :nth-child('+sind+')').prop('selected', true).change();
									//chart.update();
								}, 500);*/
								console.log('woj link clicked ' + filtered);
								
							/*}else{
								//
								console.log('same woj link clicked ' + filtered);
								//map.fitBounds(wojewods[skod].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							}*/
							
							//map.fitBounds(wojewods[kod.substring(0,2)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=sind;
							polind =0;
							filtered = true;
							console.log('woj link clicked ' + filtered);
							//map.closePopup();
						}
						
						if  (!$(this).parents('#tab1').length){
							map.closePopup();
							customControlLayers();
							console.log('#tab1 link clicked ' + filtered);
						}
					});
					$('.has-tooltip span.gmina').on('click',function(e) {
						console.log('Clicked!');
						manual_popup = false;
						link_clicked = true;
						block_centering = true;
						var kod;
						
						if ( $(this).parent().parent().children('.tooltip-wrappers').children('.tooltips').children('.kod').length ) {
							kod = $(this).parent().parent().children('.tooltip-wrappers').children('.tooltips').children('.kod').text();
						}else{
							kod = current_KOD;
						}
						
						layer_current.eachLayer(function(layer) {	//restore feature color
							layer_current.resetStyle(layer);
						});
						
						if  ($(this).parents('#tab2').length){
							if (layer_10._leaflet_id!=layer_current._leaflet_id){
								map.removeLayer(layer_current);
								layer_current = layer_10;
								layer_10.addTo(map);
								//customControlLayers();
							}
						}else if  ($(this).parents('#tab3').length){
							if (layer_15._leaflet_id!=layer_current._leaflet_id){
								map.removeLayer(layer_current);
								layer_current = layer_15;
								layer_15.addTo(map);
								//customControlLayers();
							}
						}else if  ($(this).parents('#tab4').length){
							if (layer_20._leaflet_id!=layer_current._leaflet_id){
								map.removeLayer(layer_current);
								layer_current = layer_20;
								layer_20.addTo(map);
								//customControlLayers();
							}
						}
						
						
						
						manual_zoom = false;
						//map.spin(true);
						if  ($(this).parents('.woj').length){//czy istnieje choć jeden rodzic o klasie "woj"
							/*setTimeout(function () {
								map.fitBounds(wojewods[kod.substring(0,2)].getBounds());
							}, 1000);*/
							console.log($(this));
							//link_clicked = true;
							var skod = kod.substring(0,2).toString();
							var sind = kod.substring(0,2)/2+1;
							console.log(kod+'-'+skod+'-'+cind+'-'+sind);
							//console.log(wojewods);
							//console.log(wojewods[skod.toString()]);
							
							//console.log($('#subfilter :nth-child(1)'));
							//$select.change(subch);
							//console.log($('#subfilter :nth-child(1)'));
							
							if ($select.val()!='Polska'){
								//item_clicked = true;
								$('#subfilter :nth-child(1)').prop('selected', true).change();
								//item_clicked = false;
								console.log('woj link clicked ' + filtered);
								//filtered = false;
								//map.closePopup();
							}
							if (sind!=cind){
								item_clicked = true;
								$('#filter :nth-child('+sind+')').prop('selected', true).change();
								item_clicked = false;
								console.log('Ranking (woj) subch');
								$select.change(subch);
								/*setTimeout(function () {
									$('#filter :nth-child('+sind+')').prop('selected', true).change();
									//chart.update();
								}, 500);*/
								console.log('woj link clicked ' + filtered);
								
							}else{
								//
								console.log('same woj link clicked ' + filtered);
								//map.fitBounds(wojewods[skod].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							}
							
							//map.fitBounds(wojewods[kod.substring(0,2)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=sind;
							polind =0;
							filtered = true;
							console.log('woj link clicked ' + filtered);
							//map.closePopup();
						} else if ($(this).parents('.pow').length){
							/*setTimeout(function () {
								map.fitBounds(pow_ats[kod.substring(0,4)].getBounds());
							}, 1000);*/
							woj_zoom = false;
							select_twice = true;
							//map.closePopup();
							var pind = kod.substring(2,4)/1+1;
							console.log(pind);
							
							console.log($select);
							console.log($select.val());
							//if ($select.val()=='Polska'){
								//console.log("Tak - Polska!");
							var wind = kod.substring(0,2)/2+1;
							if (wind!=cind){
								$('#filter :nth-child('+wind+')').prop('selected', true).change();
								console.log('Ranking (pow) subch');
								$select.change(subch);
								console.log('pow link clicked ' + filtered);
							}
							//$select.change(subch);
							//subb = 1;
							//$('#subfilter :nth-child('+pind+')').prop('selected', true).change();
							item_clicked = true;
							//manually_zoomed = false;
							$("#subfilter option").filter(function() {
							  //may want to use $.trim in here
							  return $(this).text().substring(0,4) == kod.substring(0,4);
							}).prop('selected', true).change();
							item_clicked = false;
							console.log('pow link clicked ' + filtered);
							//subb = 0;
							console.log($('#subfilter :nth-child('+pind+')'));
							//map.fitBounds(pow_ats[kod.substring(0,4)].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
							cind=wind;
							polind =0;
							filtered = true;
							select_twice = false;
							console.log('pow link clicked ' + filtered);
						}else{
							//if (polind==0){
								//$('#subfilter :nth-child(1)').prop('selected', false).change();
								item_clicked = true;
								$('#filter :nth-child(1)').prop('selected', true).change();
								item_clicked = false;
								$subselect.empty()/*.change()*/;
								console.log("iii");
								console.log("pop pow kraj");
								//map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [320, 0]});
							//}
							cind=1;
							polind = 1;
							filtered = false;
							console.log('pow link clicked ' + filtered);
						}
						map.closePopup();
						manual_zoom = true;
						//manually_zoomed = false;
						console.log("Kod: "+kod);
						layers[kod].setStyle({color: 'rgba(255,255,255,0.5)', weight: '8', /*dashArray: '16, 16',*/  lineCap: 'round', lineJoin: 'round',fillColor: 'rgba(255,0,0,0.9)',});
						/*setTimeout(function () {
								layers[kod].openPopup();
								//map.spin(false);
						}, 2500);*/
						//map.spin(false);
						layers[kod].openPopup();
						block_centering = false;
						customControlLayers();
						manual_popup = true;
					});
				});
			});
			console.log('Koniec kodu popup filtered: ' + filtered);
			//setTimeout(function () {
			//temp_zoomed = manually_zoomed;
			$(document).ready(function (){
			if (layers[current_KOD].isPopupOpen()){
				var px = map.project(e.target._popup._latlng); // find the pixel location on the map where the popup anchor is
				px.y -= e.target._popup._container.clientHeight/2+32; // find the height of the popup container, divide by 2, subtract from the Y axis of marker location
				px.x += 128;
				map.panTo(map.unproject(px),{animate: true, duration: 0.8}); // pan to new center
				console.log("Panned center");
			}
			});
			var zoom = map.getZoom();
			if (zoom < tooltipThreshold+1){
				$('path.stroke-polyline').css('mix-blend-mode', 'normal');
			}else{
				$('path.stroke-polyline').css('mix-blend-mode', 'multiply');
			}
			//////alert("End of panning - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed);
			//manually_zoomed = temp_zoomed;
			//}, 250);
			
		});
		map.on('baselayerchange', function (eventLayer) {
			year = 0;
			//$( "p.leaflet-control-layers-base:eq(0)" ).remove( ":contains('Poparcie dla kandydatów')" );
			//$('.leaflet-control-layers-base:eq(0) label:eq(0)').before('<p class= "category">Poparcie dla kandydatów<br>(wartość średnia jako punkt odniesienia):</p>');
			
			console.log(eventLayer.layer);
			layer_current = eventLayer.layer;
			layer_code = layer_current._leaflet_id;
			//layer_current.setStyle({color: 'rgba(64,64,64,'+(0.25+(a_zoom-5)*0.1)+')'});
			//zoomToLabels();
			searchControl._layer = layer_current;
			layers = [];
			scatterPlotDataArrayTemp = scatterPlotDataArray;
			scatterPlotDataArray_xy = [];
			scatterPlotDataArray_xz= [];
			scatterPlotDataArray_yx = [];
			scatterPlotDataArray_yz = [];
			scatterPlotDataArray_zx = [];
			scatterPlotDataArray_zy = [];
			pointBackgroundColors = [];
			pointFBackgroundColors = [];
			
			$('#Podsumowanie_tot tr th').css("border-top","none");
			$('#Podsumowanie_tot tr:nth-child(n) td').each(function() {
				$(this).css("border-left","none");
				$(this).css("border-right","1px solid #dddddd");
			});
			$('#Podsumowanie_tot tr th').css("border","1px solid #999");
			//$('#Podsumowanie_tot tr th:nth-child( '+(col_nr+1)+' )').css("border-right","4px solid #7fbc41");
			$('#Podsumowanie_tot tr:last-of-type td').css("border-bottom","4px solid #276419");
			$('#Podsumowanie_tot tr td:nth-child(4)').css("border-right","2px dotted #bbb");
			chosenCol('Podsumowanie_tot');
			
			if ($select.val()=="Polska"){
				$('#Podsumowanie_mean tr th').css("border-top","none");
				$('#Podsumowanie_mean tr:nth-child(n) td').each(function() {
					$(this).css("border-left","none");
					$(this).css("border-right","1px solid #dddddd");
				});
				$('#Podsumowanie_mean tr th').css("border","1px solid #999");
				//$('#Podsumowanie_tot tr th:nth-child( '+(col_nr+1)+' )').css("border-right","4px solid #7fbc41");
				$('#Podsumowanie_mean tr:last-of-type td').css("border-bottom","4px solid #276419");
				$('#Podsumowanie_mean tr td:nth-child(4)').css("border-right","2px dotted #bbb");
				chosenCol('Podsumowanie_mean');
			}
			
			////////alert($changer.prop('selectedIndex'));
			switch(eventLayer.name){
				case '2010':
					xa = 'Komorowski';
					ya = 'Kaczyński';
					za = 'Absencja i nieważne';
					xb = xa;
					yb = ya;
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2010.png" style="width: 200px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
						rotateData(p, p.po10, p.pis10);
						pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
						pointFBackgroundColors.push(p.rgb10);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: true,
					  max: 80,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: true,
					  max: 80,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('Kaczyński', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
					}
					jedn = '%';
					switchAnn(1);
					break;
				case '2015':
					xa = 'Komorowski';
					ya = 'Duda';
					za = 'Absencja i nieważne';
					xb = xa;
					yb = ya;
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2015.png" style="width: 200px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
						rotateData(p, p.po15, p.pis15);
						pointBackgroundColors.push(colorconvert(p.rgb15,0.8));
						pointFBackgroundColors.push(p.rgb15);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: true,
					  max: 80,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: true,
					  max: 80,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2015 r.', 'jako odsetek osób uprawnionych do głosowania:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('Duda', 'Komorowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
					}
					jedn = '%';
					switchAnn(1);
					break;
				case '2020':
					xa = 'Trzaskowski';
					ya = 'Duda';
					za = 'Absencja i nieważne';
					xb = xa;
					yb = ya;
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2020.png" style="width: 200px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						//p.index = p.JPT_NAZWA_ + " | "+ p.JPT_KOD_JE;
						rotateData(p, p.po20, p.pis20);
						pointBackgroundColors.push(colorconvert(p.rgb20,0.8));
						pointFBackgroundColors.push(p.rgb20);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					
					//setChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: true,
					  max: 80,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: true,
					  max: 80,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2020 r.', 'jako odsetek osób uprawnionych do głosowania:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('Duda', 'Trzaskowski', 'Absencja i&nbsp;nieważne', '%',tooltipItems);
					}
					jedn = '%';
					switchAnn(1);
					
					//chart.update();
					break;
				case '2010 -> 2015':
					xa = 'Komorowski\'15 - Komorowski\'10';
					ya = 'Duda\'15 - Kaczyński\'10';
					za = 'ABS\'15 - ABS\'10';
					xb = 'KOM\'15 - KOM\'10';
					yb = 'DUD\'15 - KAC\'10';
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2010 --_ 2015.png" style="left: -50px; width: 400px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						var rpo = p.po15 - p.po10;
						var rpis = p.pis15 - p.pis10;
						rotateDataPP(p, rpo, rpis);
						pointBackgroundColors.push(colorconvert(p.rgb1510,0.8));
						pointFBackgroundColors.push(p.rgb1510);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart(false, -25, 25, 10);
					//fitChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: false,
					  max: 25,
					  min: -25,
					  stepSize: 10
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: false,
					  max: 25,
					  min: -25,
					  stepSize: 10
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2015:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('DUD\'15-KAC\'10', 'KOM\'15-KOM\'10', 'ABS\'15-ABS\'10', '&nbsp;p.p.',tooltipItems);
					}
					jedn = ' p.p.';
					switchAnn(1);
					break;
				case '2015 -> 2020':
					xa = 'Trzaskowski\'20 - Komorowski\'15';
					ya = 'Duda\'20 - Duda\'15';
					za = 'ABS\'20 - ABS\'15';
					xb = 'TRZ\'20 - KOM\'15';
					yb = 'DUD\'20 - DUD\'15';
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2015 --_ 2020.png" style="left: -50px; width: 400px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						var rpo = p.po20 - p.po15;
						var rpis = p.pis20 - p.pis15;
						rotateDataPP(p, rpo, rpis);
						pointBackgroundColors.push(colorconvert(p.rgb2015,0.8));
						pointFBackgroundColors.push(p.rgb2015);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart(false, -40, 40, 20);
					//fitChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2015 -> 2020:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('DUD\'20-DUD\'15', 'TRZ\'20-KOM\'15', 'ABS\'20-ABS\'15', '&nbsp;p.p.',tooltipItems);
					}
					jedn = ' p.p.';
					switchAnn(1);
					break;
					case '2010 -> 2020':
					xa = 'Trzaskowski\'20 - Komorowski\'10';
					ya = 'Duda\'20 - Kaczyński\'10';
					za = 'ABS\'20 - ABS\'10';
					xb = 'TRZ\'20 - KOM\'10';
					yb = 'DUD\'20 - KAC\'10';
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2010 --_ 2020.png" style="left: -50px; width: 400px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						var rpo = p.po20 - p.po10;
						var rpis = p.pis20 - p.pis10;
						rotateDataPP(p, rpo, rpis);
						/*if (p.PA > 50) {
							//pointBorderWidths.push(1.5);
							pointBackgroundColors.push(colorconvert("#800000",0.8));
						}else if (p.PA <= 50 && p.PA > 45){
							//pointBorderWidths.push(1);
							pointBackgroundColors.push(colorconvert("#00a000",0.8));
						}else if (p.PA <= 45 && p.PA > 40){
							//pointBorderWidths.push(1);
							pointBackgroundColors.push(colorconvert("#ffffff",0.8));
						}else if (p.PA <= 40 && p.PA > 35){
							//pointBorderWidths.push(1);
							pointBackgroundColors.push(colorconvert("#0000e0",0.8));
						}else if (p.PA <= 35){
							//pointBorderWidths.push(1);
							pointBackgroundColors.push(colorconvert("#ff0000",0.8));
						}else {*/
							//pointBorderWidths.push(1);
							pointBackgroundColors.push(colorconvert(p.rgb2010,0.8));
						//}
						//pointBackgroundColors.push(colorconvert(p.rgb2010,0.8));
						pointFBackgroundColors.push(p.rgb2010);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart(false, -40, 40, 20);
					//fitChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2020:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('DUD\'20-KAC\'10', 'TRZ\'20-KOM\'10', 'ABS\'20-ABS\'10', '&nbsp;p.p.',tooltipItems);
					}
					jedn = ' p.p.';
					switchAnn(1);
					break;
					case '2010 -> 2015 ':
					xa = 'Komorowski\'15 - Komorowski\'10';
					ya = 'Duda\'15 - Kaczyński\'10';
					za = 'ABS\'15 - ABS\'10';
					xb = 'KOM\'15 - KOM\'10';
					yb = 'DUD\'15 - KAC\'10';
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2010 --_ 2015.png" style="left: -50px; width: 400px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						var rpo = p.po15 - p.po10;
						var rpis = p.pis15 - p.pis10;
						rotateDataPP(p, rpo, rpis);
						pointBackgroundColors.push(colorconvert(p.rgb1510c,0.8));
						pointFBackgroundColors.push(p.rgb1510c);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart(false, -25, 25, 10);
					//fitChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: false,
					  max: 25,
					  min: -25,
					  stepSize: 10
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: false,
					  max: 25,
					  min: -25,
					  stepSize: 10
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2015:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('DUD\'15-KAC\'10', 'KOM\'15-KOM\'10', 'ABS\'15-ABS\'10', '&nbsp;p.p.',tooltipItems);
					}
					jedn = ' p.p.';
					switchAnn(0);
					break;
					case '2015 -> 2020 ':
					xa = 'Trzaskowski\'20 - Komorowski\'15';
					ya = 'Duda\'20 - Duda\'15';
					za = 'ABS\'20 - ABS\'15';
					xb = 'TRZ\'20 - KOM\'15';
					yb = 'DUD\'20 - DUD\'15';
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2015 --_ 2020.png" style="left: -50px; width: 400px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						var rpo = p.po20- p.po15;
						var rpis = p.pis20 - p.pis15;
						rotateDataPP(p, rpo, rpis);
						pointBackgroundColors.push(colorconvert(p.rgb2015c,0.8));
						pointFBackgroundColors.push(p.rgb2015c);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart(false, -40, 40, 20);
					//fitChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2015 -> 2020:'];
					//chart.options.annotation.annotations[0].value = 10;
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('DUD\'20-DUD\'15', 'TRZ\'20-KOM\'15', 'ABS\'20-ABS\'15', '&nbsp;p.p.',tooltipItems);
					}
					jedn = ' p.p.';
					switchAnn(0);
					break;
					case '2010 -> 2020 ':
					console.log('Layer 2010 -> 2020');
					xa = 'Trzaskowski\'20 - Komorowski\'10';
					ya = 'Duda\'20 - Kaczyński\'10';
					za = 'ABS\'20 - ABS\'10';
					xb = 'TRZ\'20 - KOM\'10';
					yb = 'DUD\'20 - KAC\'10';
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2010 --_ 2020.png" style="left: -50px; width: 400px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						var rpo = p.po20 - p.po10;
						var rpis = p.pis20 - p.pis10;
						rotateDataPP(p, rpo, rpis);
						pointBackgroundColors.push(colorconvert(p.rgb2010c,0.8));
						pointFBackgroundColors.push(p.rgb2010c);
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					//setChart(false, -40, 40, 20);
					//fitChart();
					/*chart.options.scales.xAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};
					chart.options.scales.yAxes[0].ticks = {
					  beginAtZero: false,
					  max: 40,
					  min: -40,
					  stepSize: 20
					};*/
					changerToChart($changer);
					chart.options.title.text = ['Zmiana  wyników (p.p.) II tury Wyborów Prezydenta RP', '2010 -> 2020:'];
					chart.options.tooltips.callbacks.label = function(tooltipItems, data) {
						return setTooltipText('DUD\'20-KAC\'10', 'TRZ\'20-KOM\'10', 'ABS\'20-ABS\'10', '&nbsp;p.p.',tooltipItems);
					}
					jedn = ' p.p.';
					switchAnn(0);
					break;
				default:
					xa = 'Komorowski';
					ya = 'Kaczyński';
					za = 'Absencja i nieważne';
					xb = xa;
					yb = ya;
					zb = za;
					updateChanger(xb,yb,zb);
					$('.leaflet-bottom:eq( 0 )').html('<img class="leaflet-control" src="./images/2010.png" style="width: 200px; opacity: 0.9; margin-bottom: 0px;">');
					layer_current.eachLayer(function (evt, idx) {
						var p = evt.feature.properties;
						layers[p.JPT_KOD_JE] = evt;
						rotateData(p, p.po10, p.pis10);
						pointBackgroundColors.push(colorconvert(p.rgb10,0.8));
					});
					chart.data.datasets[1].pointBackgroundColor=pointBackgroundColors;
					changerToChart($changer);
					chart.options.title.text = ['Wyniki II tury Wyborów Prezydenta RP w 2010 r.', 'jako odsetek osób uprawnionych do głosowania:'];
					break;
			};
			 chart.data.datasets[0].data = checkPoint();
			 chart.data.datasets[0].pointBackgroundColor=pointFBackgroundColors;
			 console.log(scatterPlotDataArray);
				if ($select.val()=='Polska'){
					chart.data.datasets[1].data = scatterPlotDataArray;
					//chart.data.datasets[2].data = [];
					if (layer_code==l1||layer_code==l2||layer_code==l3){
						setChart();
					}else{
						fitChart();
					}
				}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
					chart.data.datasets[1].data = filterChart();
					console.log(chart.options.tooltips);
					fitChart();
				}	else {
					chart.data.datasets[1].data = subfilterChart();
					console.log(chart.options.tooltips);
					fitChart();
				}
				updateAnn();
				chart.update();
				var zoom = map.getZoom();
				if (zoom < tooltipThreshold+1){
					$('path.stroke-polyline').css('mix-blend-mode', 'normal');
				}else{
					$('path.stroke-polyline').css('mix-blend-mode', 'multiply');
				}
				//options_saved = chart.options;
				//data_saved = chart.data.datasets[0];
		});
		var lastZoom;
		
		function zoomToLabels(){
			resetLabels([layer_Powiaty_Simplified_1]);
			var zoom = map.getZoom();
			layer_10.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_15.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_20.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_1510.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_2015.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_2010.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_1510c.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_2015c.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			layer_2010c.setStyle({color: 'rgba(64,64,64,'+(0.25+(zoom-5)*0.1)+')'});
			
			//if($select.val()=='Polska'){
				if (zoom < tooltipThreshold/* && (!lastZoom || lastZoom >= tooltipThreshold)*/) {
					map.getPane('labels').style.display = 'none';
					
				} else if (zoom >= tooltipThreshold/* && (!lastZoom || lastZoom < tooltipThreshold)*/) { 
					map.getPane('labels').style.display = 'inline-block';
					map.getPane('labels').style['text-align'] = 'center';
				}
				if (zoom < tooltipThreshold+1){
					$('path.stroke-polyline').css('mix-blend-mode', 'normal');
				}else{
					$('path.stroke-polyline').css('mix-blend-mode', 'multiply');
				}
			//}
			selected = false;
			lastZoom = zoom;
			/*setTimeout(function () {
				resetLabels([layer_Powiaty_Simplified_1]);
			},0);*/
			
		}

		/*map.on('zoomend', function() {
			setTimeout(function () {
				resetLabels([layer_Powiaty_Simplified_1]);
			},0);
		});*/
		
		function rowGen(nrow, iter, u_gm, c1, c2, c3){
			return '<tr><td><div>'+(nrow+1)+ '.</div></td><td>\
				<div class="containers">\
					<a class="has-tooltip" href="#"><span style="display: block; width: 80px; margin: 0px;">'+ u_gm + '<span class="gmina">'+PLnazwa[iter][nrow]+'</span></span>\
						<span class="tooltip-wrappers">\
							<span class="tooltips"><h4 style="margin: 4px; padding: 0px; text-align: center;">Położenie:</h4>TERYT: <span class="kod">' +PLkod[iter][nrow]+'</span><br>'+ json_Powiaty_Simplified_1.getFeaturesByProperty('JPT_KOD_JE', PLpow[iter][nrow])[0].properties.JPT_NAZWA_+'<br>województwo ' +  json_Granicewojewdztw_2.getFeaturesByProperty('Wojewod', PLwoj[iter][nrow])[0].properties.JPT_NAZWA_ + '<br><h4 style="margin: 4px; padding: 0px; text-align: center;">Wyniki:</h4><table><tr><td>'+candidateName(Math.floor(i/3)*3)+'</td><td>'+lengthToBlank1(PLudzial[Math.floor(iter/3)*3][c1])+'%</td></tr><tr><td>'+candidateName(Math.floor(i/3)*3+1)+'</td><td>'+lengthToBlank1(PLudzial[Math.floor(iter/3)*3+1][c2])+'%</td></tr><tr><td>Absencja i  nieważne:</td><td>'+lengthToBlank1(PLudzial[Math.floor(iter/3)*3+2][c3])+'%</td></tr></table>\
							</span>\
						</span>\
					</a>\
				</div>\
			</td><td><div>'+lengthToBlank1(PLudzial[iter][nrow]) +'%</div></td><td><div><div style = "background-color: white; display: inline-block; padding: 0px; margin: 2px;"><div style = "background-color: ' + ((PLudzial[iter][nrow] != 100)? PLkolor[iter][nrow]:'rgba(0,0,0,0.0)')   + '; opacity: 0.8;  width: 12px; height: 100%;"></div></div></div></td></tr>';
		}
		
		
		map.on('zoomend', function () {
			
			var currentZoom = map.getZoom();
			
			//console.log(map.getPane('pane_Gminy_0').style.color);
			/*layer_Powiaty_Simplified_1.setStyle({weight: Math.pow(1.2,(currentZoom-3))});
			layer_Powiaty_Simplified_2.setStyle({weight: Math.pow(1.2,(currentZoom-3))+1.6});
			layer_Granicewojewdztw_2.setStyle({weight: Math.pow(1.2,(currentZoom))});
			layer_Granicewojewdztw_1.setStyle({weight: Math.pow(1.2,(currentZoom+2))});*/
			/*layer_Powiaty_Simplified_1.setStyle({weight: Math.pow((1.44+(Math.pow((10-currentZoom),2)-5)/25),(currentZoom-6))*1.12});
			layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.44+(Math.pow((10-currentZoom),2)-5)/25),(currentZoom-6))*1.68});
			layer_Granicewojewdztw_2.setStyle({weight: Math.pow((1.44+(Math.pow((10-currentZoom),2)-5)/25),(currentZoom-6))*1.68});
			layer_Granicewojewdztw_1.setStyle({weight: Math.pow((1.44+(Math.pow((10-currentZoom),2)-5)/25),(currentZoom-6))*2.52});*/
			//var lzoom = Math.pow((currentZoom-6),0.75)*0.75+1;
			map.getPane('pane_Gminy_0').style['mix-blend-mode'] = blend_modes[currentZoom-6];
			var lzoom = zooms[currentZoom-6];
			layer_Powiaty_Simplified_1.setStyle({weight: lzoom*1.0});
			layer_Powiaty_Simplified_2.setStyle({weight: lzoom*1.5});
			layer_Granicewojewdztw_2.setStyle({weight: lzoom*1.8});
			layer_Granicewojewdztw_1.setStyle({weight: lzoom*2.7});
			layer_PL1931.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.6});
			layer_PL1931a.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.8});
			layer_PL1897.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.6});
			layer_PL1897a.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.8});
			layer_ZAB1910.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.6});
			layer_ZAB1910a.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.6});
			layer_ZAB1910_a.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.8});
			layer_ZAB1910a_a.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.8});
			//alert("Grubość granic województw: " + Math.pow((1.44+(Math.pow((10-currentZoom),2)-5)/25),(currentZoom-6))*1.68);
			if ($select.val()=='Polska'){
				console.log("Bez filtrowania");
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				//layer_Powiaty_Simplified_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.08});
				//layer_Powiaty_Simplified_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.44});
				//layer_Okr_2.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.6});
				var woj_ = $select.val().substring(0,2);
				wojewods2[woj_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.24});
				wojewods[woj_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.36});
				wojewods2[woj_].bringToFront();
				//layer_Okr_1.setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.56});
			}else {
				var pow_ = $subselect.val().substring(0,4);
				pow_ats[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.92});
				pow_ats2[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.44});
				pow_ats2[pow_].bringToFront();
			}
			if (pop_op){
				layers[current_KOD].openPopup();
				pop_op=false;
			}
			console.log("End of zoom");
			//alert("Zoom end - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
			//auto_zoom = false;
			//manually_zoomed = false;
			zoomToLabels();
			setTimeout(function () {
				setTimeout(function () {
					zooming = false;
				}, 500);
			}, 0);
			block_centering = false;
			already_selected = false;
			popup_close_first_clicked = false;
		});
		map.on('moveend', function() {
			////alert("Drag end - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
			already_selected = false;
			popup_close_first_clicked = false;
			setTimeout(function () {
				console.log(map.getPane('pane_Gminy_0').style.color);
				//zoomToLabels(currentZoom);
			}, 3000);
			/*var zoom = map.getZoom();
			if (zoom>8){
				zoomToLabels();
			}*/
		});
		map.on('dragstart', function() {
			//console.log("Drag start - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
			/*if (auto_zoom){
				manually_zoomed = true;
			}else{
				manually_zoomed = false;
			}*/
		});
		map.on('zoomstart', function () {
			//temp_zoomed = manually_zoomed;
			console.log("Zoom start - manually_zoomed: " + manually_zoomed + " \ntemp_zoomed: " + temp_zoomed + "\nitem_clicked: " + item_clicked + "\nsubsel_clicked: " + subsel_clicked + "\npolygon_clicked: " + polygon_clicked + "\nadm_clicked: " + adm_clicked + "\nauto_zoom: "+ auto_zoom + "\nsel_clicked: " + sel_clicked);
			//manual_zoom?manually_zoomed=true:manually_zoomed=false;
			/*if (auto_zoom){
				manually_zoomed = true;
			}else{
				manually_zoomed = false;
			}*/
			if (!already_selected&&!popup_close_first_clicked){
				auto_zoom = false;
			}
			console.log("already_selected: " + already_selected);
			console.log("popup_close_first_clicked: " + popup_close_first_clicked);
			
			if (layers[current_KOD].isPopupOpen()){
				console.log("Zoom - popup zamknięty");
				pop_op=true;
				block_centering = true;
				map.closePopup();
				
			}
			
		});
		map.on('overlayadd', function (eventLayer) {
			//if (eventLayer.name==||eventLayer.name==
			var currentZoom = map.getZoom();
			if (/*!filtered&&currentAttrValue!='#tab1'*/$select.val()=='Polska'){
				//resetLabels();
				//map.fitBounds([[48.7066068804,11.9576083267],[54.6798073754,27.5635253264]], {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.75});
				
			}else if  ($subselect.val()=='none'||$subselect.is(':empty')){
				
				var woj = $select.val().substring(0,2);
				wojewods2[woj].setStyle({color: 'rgba(224,0,0,1.0)', fillPattern: stripes, weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.24});
				wojewods[woj].setStyle({color: 'rgba(255,255,255,1.0)', weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*3.36});
				wojewods2[woj].bringToFront();
				//map.fitBounds(wojewods[woj].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.75});
			}else {
				var pow_ = $subselect.val().substring(0,4);
				pow_ats[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*2.52, fillPattern: stripes});
				pow_ats2[pow_].setStyle({weight: Math.pow((1.4+(Math.pow((10-currentZoom),2)-5)/49),(currentZoom-6))*1.68});
				pow_ats2[pow_].bringToFront();
				//map.fitBounds(pow_ats[pow_].getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0], animate: true, duration: 0.75});

			}
			var i = 0;
			layer_Powiaty_Simplified_1.eachLayer(function(layer) {
				layer.closeTooltip();
				layer.openTooltip(lab_centers[i]);
				i++;
			});
			resetLabels([layer_Powiaty_Simplified_1]);
		});
		
		//map.fitBounds(layer_Powiaty_Simplified_1.getBounds(), {paddingBottomRight: [400, 0], paddingTopLeft: [80, 0]});
	</script>
        
		
    </body>
</html>
